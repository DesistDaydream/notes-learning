---
title: Jinja
---

# æ¦‚è¿°

> å‚è€ƒï¼š
>
> - [GitHub é¡¹ç›®ï¼Œpallets/jinja](https://github.com/pallets/jinja)
> - [å®˜ç½‘](https://jinja.palletsprojects.com/)
>   - [å›½äººç¿»è¯‘å®˜ç½‘](http://docs.jinkan.org/docs/jinja2/)
> - [Wikiï¼ŒJinja](https://en.wikipedia.org/wiki/Jinja_(template_engine))
> - [éªé©¬é‡‘é¾™åšå®¢ï¼Œ9. å¦‚è™æ·»ç¿¼çš„åŠ›é‡ï¼šè§£é”å¼ºå¤§çš„ Jinja2 æ¨¡æ¿](https://www.junmajinlong.com/ansible/9_power_of_jinja2/)

Jinja æ˜¯ä¸€ä¸ªç”¨äº Python å˜æˆè¯­è¨€ä¸­çš„ **Template Engine(æ¨¡æ¿å¼•æ“)**ã€‚Jinja é€šå¸¸è¢«ç”¨æ¥ä½œä¸º Python çš„ Web æ¡†æ¶(e.g.Flaskã€Django)çš„æ•°æ®æ¸²æŸ“çš„åº•å±‚è°ƒç”¨ã€‚

> Django å…¶å®è‡ªå¸¦æ¨¡æ¿å¼•æ“(DTL)ï¼Œåªä¸è¿‡ç”±äº Jinja çš„æµè¡Œï¼Œé€šå¸¸éƒ½è®© Django çš„æ¨¡æ¿å¼•æ“ä½¿ç”¨ Jinja2

Jinja æ¨¡æ¿å¼•æ“å…è®¸å®šåˆ¶æ ‡ç­¾ã€è¿‡æ»¤å™¨ã€æµ‹è¯•å’Œå…¨å±€å˜é‡ã€‚æ­¤å¤–ï¼Œä¸ Django æ¨¡æ¿å¼•æ“ä¸åŒï¼ŒJinja å…è®¸æ¨¡æ¿è®¾è®¡å™¨è°ƒç”¨å¸¦æœ‰å¯¹è±¡å‚æ•°çš„å‡½æ•°ã€‚Jinja æ˜¯ Flask çš„é»˜è®¤æ¨¡æ¿å¼•æ“ï¼ŒåŒæ—¶ï¼Œä¹Ÿè¢« Ansibleã€Tracã€Salt ä½¿ç”¨ã€‚

## Jinja æ˜¯ä»€ä¹ˆï¼Ÿæ¨¡æ¿æ˜¯ä»€ä¹ˆï¼Ÿ

ä½•ä¸ºæ¨¡æ¿ï¼Ÿä¸¾ä¸ªä¾‹å­å°±çŸ¥é“äº†ã€‚

å‡è®¾è¦å‘é€ä¸€ä¸ªæ–‡ä»¶ç»™ä¸€ä¸ªæˆ–å¤šä¸ªç›®æ ‡èŠ‚ç‚¹ï¼Œè¦å‘é€çš„æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š
```
hello, __NAME__
```
å…¶ä¸­ `__NAME__` éƒ¨åˆ†æƒ³è¦æ ¹æ®ç›®æ ‡èŠ‚ç‚¹çš„ä¸»æœºåæ¥ç¡®å®šï¼Œæ¯”å¦‚å‘é€ç»™ www èŠ‚ç‚¹æ—¶å†…å®¹åº”è¯¥ä¸º `hello, www`ï¼Œå‘é€ç»™ wwww èŠ‚ç‚¹æ—¶ï¼Œå†…å®¹åº”è¯¥ä¸º`hello, wwww`ã€‚æ¢å¥è¯è¯´ï¼Œ`__NAME__` æ˜¯ä¸€ä¸ªèƒ½å¤Ÿæ ¹æ®ä¸åŒåœºæ™¯åŠ¨æ€ç”Ÿæˆä¸åŒå­—ç¬¦ä¸²çš„ä»£ç å°ç‰‡æ®µã€‚è€Œæ ¹æ®ç‰¹æ®Šçš„ä»£ç ç‰‡æ®µåŠ¨æ€ç”Ÿæˆå­—ç¬¦ä¸²ä¾¿æ˜¯æ¨¡æ¿è¦å®ç°çš„åŠŸèƒ½ã€‚

ç°åœ¨è§£é‡Šæ¨¡æ¿ä¾¿å®¹æ˜“äº†ï¼š**æ‰€è°“ Template(æ¨¡æ¿)ï¼Œåªæ˜¯æ–‡æœ¬æ–‡ä»¶ï¼Œå¯ä»¥åœ¨æ–‡æœ¬å­—ç¬¦ä¸²ä¸­åµŒå…¥ä¸€äº› Expressions(è¡¨è¾¾å¼)ï¼Œç„¶åä½¿ç”¨æ¨¡æ¿å¼•æ“å»è§£ææ•´ä¸ªæ¨¡æ¿ï¼Œå°†å…¶ä¸­åµŒå…¥çš„è¡¨è¾¾å¼æ›¿æ¢æˆå¯¹åº”çš„ç»“æœ**ã€‚å…¶ä¸­ï¼Œ**è§£æå¹¶æ›¿æ¢æ¨¡æ¿è¡¨è¾¾å¼çš„è¿‡ç¨‹**ï¼Œç§°ä¸º**æ¸²æŸ“**ã€‚ä»ç¼–ç¨‹è¯­è¨€çš„è§’åº¦è¯´ï¼Œ**è¡¨è¾¾å¼å°±æ˜¯ä»£ç ä¸­çš„ functionã€‚**

å½“æ¨¡æ¿å¼•æ“è§£æè¡¨è¾¾å¼æ—¶ï¼Œæ¯ä¸ª**è¡¨è¾¾å¼**éƒ½**æœ‰è¿”å›å€¼**ã€‚

ä¸ºäº†è®©æ¨¡æ¿å¼•æ“åªæ›¿æ¢è¡¨è¾¾å¼è€Œä¸æ“ä½œæ™®é€šå­—ç¬¦ä¸²ï¼Œæ‰€ä»¥æ¨¡æ¿å¼•æ“éœ€è¦èƒ½å¤ŸåŒºåˆ†æ¨¡æ¿è¡¨è¾¾å¼å’Œæ™®é€šå­—ç¬¦ä¸²ï¼Œæ‰€ä»¥æ¨¡æ¿è¡¨è¾¾å¼é€šå¸¸ä¼šä½¿ç”¨ **Delimiters(åˆ†éš”ç¬¦)** åŒ…å›´èµ·æ¥ã€‚ä¾‹å¦‚ä¸Šé¢ç¤ºä¾‹ä¸­ï¼Œ`__NAME__`ä½¿ç”¨äº†å‰åä¸¤ä¸ªä¸‹åˆ’çº¿åŒ…å›´ï¼Œè¡¨ç¤ºè¿™éƒ¨åˆ†æ˜¯æ¨¡æ¿è¡¨è¾¾å¼ï¼Œå®ƒæ˜¯éœ€è¦è¿›è¡Œæ›¿æ¢çš„ï¼Œè€Œâ€helloâ€ æ˜¯æ™®é€šå­—ç¬¦ä¸²ï¼Œæ¨¡æ¿å¼•æ“ä¸ä¼šå»ç®¡å®ƒã€‚

Jinja æ¨¡æ¿å¼•æ“æä¾›äº†ä¸‰ç§** Delimiters(åˆ†éš”ç¬¦) **æ¥åŒ…å›´ **æ¨¡æ¿è¡¨è¾¾å¼**ï¼š

- `{{ XXX }}` # Jinja çš„ **Basic(åŸºæœ¬)** è¡¨è¾¾å¼ã€‚æ¯”å¦‚å¼•ç”¨å˜é‡ã€ä½¿ç”¨è¿‡æ»¤å™¨
- `{% XXX %}` # Jinja çš„ **Statements(è¯­å¥)** è¡¨è¾¾å¼ï¼Œæ¯”å¦‚ å®šä¹‰å˜é‡ã€æ‰§è¡Œæ§åˆ¶ç»“æ„è¯­å¥(if è¯­å¥ã€for å¾ªç¯)ã€ç­‰ç­‰
- `{# XXX #}` # Jinja çš„æ³¨é‡Šç¬¦å·

è¿™äº›è¡¨è¾¾å¼å¯ä»¥ç”¨æ¥å®šä¹‰å˜é‡ã€å¼•ç”¨å˜é‡ã€å®šä¹‰å‡½æ•°ã€è°ƒç”¨å‡½æ•°ã€æ‰§è¡Œæ§åˆ¶ç»“æ„ç­‰ç­‰ã€‚**è¯´ç™½äº†ï¼Œæ¨¡æ¿å…¶å®ä¹Ÿæ˜¯ä¸€ç§å˜æˆè¯­è¨€ï¼Œåªä¸è¿‡ä»£ç æ˜¯å¤¹æ‚åœ¨å¸¸è§„å­—ç¬¦ä¸²ä¸­çš„ï¼Œå¹¶ä¸”ä½¿ç”¨ç‰¹æ®Šçš„ç¬¦å·ï¼Œå°†è¿™äº›ä»£ç åŒ…å›´èµ·æ¥ã€‚**

æ¨¡æ¿æ›´å¤šç”¨åœ¨ web ç¼–ç¨‹ä¸­æ¥ç”Ÿæˆ HTML é¡µé¢ï¼Œä½†ç»ä¸é™äº web ç¼–ç¨‹ï¼Œå®ƒå¯ä»¥ç”¨åœ¨å¾ˆå¤šæ–¹é¢ï¼Œæ¯”å¦‚ Ansible å°±ä½¿ç”¨ Jinja2 æ¨¡æ¿å¼•æ“æ¥è§£æ YAML ä¸­çš„å­—ç¬¦ä¸²ï¼Œä¹Ÿç”¨åœ¨ template æ¨¡å—æ¸²æŸ“æ¨¡æ¿æ–‡ä»¶ã€‚æ¯ç§ç¼–ç¨‹è¯­è¨€éƒ½æœ‰æ¨¡æ¿ï¼Œæ¯”å¦‚ Python çš„æ¨¡æ¿è¯­è¨€ç§°ä¸º Jinjaã€è€Œ go çš„æ¨¡æ¿è¯­è¨€å°±æˆä¸º go æ¨¡æ¿ã€ç­‰ç­‰ï¼Œé€šå¸¸æ¥è¯´ï¼Œè¿™äº›å˜æˆè¯­è¨€çš„æ¨¡æ¿è¡¨è¾¾å¼çš„è¯­æ³•ï¼Œéƒ½æ˜¯ `{{ XX }}` ç¬¦å·ã€‚

## æ¨¡æ¿æ–‡ä»¶çš„æ‰©å±•å

ä»»ä½•æ–‡ä»¶éƒ½å¯ä»¥ä½œä¸ºæ¨¡æ¿åŠ è½½ï¼Œæ— è®ºæ‰©å±•åæ˜¯ä»€ä¹ˆã€‚ä½†æ˜¯ä½¿ç”¨ `.jinja` ä½œä¸ºæ‰©å±•åï¼Œå¯ä»¥æ˜¯æŸäº› IDE çš„æ’ä»¶æ›´å®¹æ˜“è¯†åˆ«æ¨¡æ¿æ–‡ä»¶ä»¥æä¾› ä»£ç é«˜äº®ã€ä»£ç è¡¥å…¨ ç­‰åŠŸèƒ½ã€‚

å¦å¤–ä¸€ä¸ªè¯†åˆ«æ¨¡æ¿çš„å¥½æ–¹æ³•ï¼Œæ˜¯å°†å®ƒä»¬éƒ½æ”¾åœ¨ `templates` ç›®å½•ä¸­ï¼Œè€Œä¸ç”¨ç®¡æ‰©å±•åæ˜¯ä»€ä¹ˆã€‚è¿™æ˜¯ä¸€ä¸ªé¡¹ç›®æœ€å¸¸è§çš„ç”¨æ³•ã€‚

# Literal(å­—é¢é‡)

Jinja çš„ Literal(å­—é¢é‡) æ˜¯æœ€ç®€å•ã€æœ€ç›´æ¥çš„è¡¨è¾¾å¼å½¢å¼ã€‚ä½†æ˜¯ï¼Œè¿™ä¸ªå…¶å®æ²¡å•¥ç”¨ã€‚ã€‚ã€‚æ¯•ç«Ÿæ˜¯åœ¨æ–‡æœ¬æ–‡ä»¶ä¸­ä½¿ç”¨æ¨¡æ¿è¡¨è¾¾å¼ï¼Œå¦‚æœ Lieral éƒ½æ˜¯ å­—ç¬¦ä¸²ã€æ•°å€¼ã€å­—å…¸ã€ç­‰ç­‰ çš„è¯ï¼Œç›´æ¥åœ¨æ–‡æœ¬ä¸­å†™å°±å¥½å•¦~~

> æ‰€è°“çš„ Literal(å­—é¢é‡) ä»ä¸­æ–‡è§’åº¦çœ‹ï¼Œå°±æ˜¯æ‰€è§å³æ‰€å¾—ï¼Œæ¯”å¦‚æˆ‘è¾“å…¥ "Hello World"ï¼Œçœ‹åˆ°çš„å°±æ˜¯è¿™å‡ ä¸ªå­—æ¯ï¼Œè¿™æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚Literal æ›´å®¹æ˜“ç†è§£çš„è¯æ˜¯ Data Type(æ•°æ®ç±»å‹)ã€‚

æ‰€ä»¥è¿™é‡Œä¸»è¦æ˜¯å®šä¹‰ä¸€ä¸‹è§£æè¡¨è¾¾å¼åå¯ä»¥è¿”å›çš„æ•°æ®ç±»å‹ã€‚Jinja çš„åŸºæœ¬æ•°æ®ç±»å‹æœ‰å¦‚ä¸‹å‡ ç§ï¼š

- å­—ç¬¦ä¸² # åŒå¼•å·æˆ–å•å¼•å·ä¸­é—´çš„ä¸€åˆ‡éƒ½æ˜¯å­—ç¬¦ä¸²
   - `"Hello World"`
- æ•´æ•°å’Œæµ®ç‚¹æ•° # ç›´æ¥å†™ä¸‹æ•°å€¼å³å¯
   - `42` æˆ–è€… `42.23`
- åˆ—è¡¨
   - `['list','of','objects']`
- å…ƒç»„
   - `('tuple','of','values')`
- å­—å…¸
   - `{'dict': 'of', 'key': 'and', 'value': 'pairs'}`
- å¸ƒå°” # ä¸å¸¦å¼•å·çš„ true ä¸ false
   - `true` å’Œ `false`

# Variable(å˜é‡) å’Œ ä½œç”¨åŸŸ

æ¨¡æ¿ä¸­çš„å˜é‡å¯ä»¥é€šè¿‡ä¸¤ç§æ–¹å¼è·å¾—

- åœ¨æ¨¡æ¿ä¸­ä½¿ç”¨ `{% set VAR = VALUE %}` è¡¨è¾¾å¼è¿›è¡Œå®šä¹‰
- åœ¨ç¼–ç¨‹è¯­è¨€ä¸­ï¼Œç”±ä»£ç åœ¨è°ƒç”¨æ¨¡æ¿å¼•æ“å‡½æ•°æ—¶ï¼Œåœ¨å‚æ•°ä¸­å®šä¹‰ã€‚

## å®šä¹‰å˜é‡

```python
{% set VAR = VALUE %}
{% set VAR_1,VAR_2 = VALUE_1,VALUE_2 %}
```

ä¾‹å¦‚ï¼š

```python
{% set mystr = "hello world" %}
{% set mylist1,mylist2 = [1,2,3],[4,5,6] %}
```

## å¼•ç”¨å˜é‡

Jinja æ¨¡æ¿è¯­è¨€ä¸­ï¼Œå¼•ç”¨å˜é‡æ˜¯æœ€åŸºæœ¬ã€æœ€ç®€å•çš„ä¸€ç§è¡¨è¾¾å¼ã€‚å¯ä»¥ç›´æ¥ä½¿ç”¨ `{{ Variable }}` å¼•ç”¨ä¸€ä¸ªå˜é‡ã€‚æ¯”å¦‚ï¼š

```python
{% set NAME = "DesistDaydrem" %}
{{ NAME }}
```

å¦å¤–ï¼Œç”±äº Python ä¸­å˜é‡æ˜¯å¯¹è±¡çš„å¼•ç”¨ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¿˜å¯ä»¥ç›´æ¥å¼•ç”¨å¯¹è±¡çš„æ–¹æ³•ã€‚æ¯”å¦‚ï¼š

```python
{{ NAME.upper()}}
```

è¿™é‡Œç­‰äºå¼•ç”¨äº†å­—ç¬¦ä¸²ç±»å‹çš„å¯¹è±¡çš„ upper() æ–¹æ³•(é‚£ä¸ªæ–¹æ³•ååé¢çš„å°æ‹¬å·å¯ä»¥èƒœç‡)ï¼Œç”¨ä»¥è¾“å‡ºå­—ç¬¦çš„æ‰€æœ‰å¤§å†™å­—ç¬¦ã€‚

### å¼•ç”¨å¤æ‚å˜é‡

Python å¤„ç† YAML æ•°æ®æ—¶ï¼Œå®é™…ä¸Šæ˜¯å°† YAML æ ¼å¼æ•°æ®è½¬æ¢ä¸ºå­—å…¸åè¿›è¡Œå¤„ç†çš„ã€‚æ‰€ä»¥ Jinja æ¨¡æ¿å¼•æ“è®¿é—®åˆ—è¡¨æˆ–å­—å…¸ç±»å‹çš„å˜é‡ï¼Œæœ‰ä¸¤ç§å¼•ç”¨æ–¹å¼

- ç‚¹å¼•ç”¨
  - **ä½¿ç”¨ `X.Y` æ—¶ï¼Œå…ˆæœç´¢ Ptyhon å¯¹è±¡çš„å±æ€§åæˆ–æ–¹æ³•åï¼Œæœç´¢ä¸åˆ°æ—¶å†æœç´¢ Jinja å˜é‡**ã€‚
- æ‹¬å·å¼•ç”¨
  - **ä½¿ç”¨ `X["Y"]` æ—¶ï¼Œå…ˆæœç´¢ Jinja å˜é‡ï¼Œæœç´¢å¤±è´¥æ—¶ï¼Œå†æœç´¢ Python å¯¹è±¡çš„å±æ€§åæˆ–æ–¹æ³•åã€‚**

æ¯”å¦‚ `mylist=["a","b","c"]` åˆ—è¡¨ï¼Œåœ¨ Jinja ä¸­æ—¢å¯ä»¥ä½¿ç”¨ `mylist[1]` æ¥è®¿é—®ç¬¬äºŒä¸ªå…ƒç´ ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ `mylist.1` æ¥è®¿é—®å®ƒã€‚

æ‰€ä»¥ï¼Œä½¿ç”¨ `X.Y` æ–¹å¼æ—¶éœ€è¦å°å¿ƒä¸€äº›ï¼Œ**å½“æˆ‘ä»¬å¼•ç”¨å­—å…¸æ—¶ï¼Œä¸€å®šè¦ç¡®å®šå…¶ä¸­çš„å±æ€§åä¸è¦ä¸ Python ä¸­çš„æ–¹æ³•åæœ‰å†²çª**ã€‚ä¸€èˆ¬ä½¿ç”¨ `X["Y"]` æ›´ä¿é™©ã€‚

## å˜é‡çš„ä½œç”¨åŸŸ

å¦‚æœæ˜¯åœ¨ ifã€for ç­‰è¯­å¥å—å¤–è¿›è¡Œçš„å˜é‡èµ‹å€¼ï¼Œåˆ™å¯ä»¥åœ¨ ifã€for ç­‰è¯­å¥å—å†…å¼•ç”¨ã€‚ä¾‹å¦‚ï¼š

```python
{% set mylist = [1,2,3] %}
{% for item in mylist %}
  {{item}}
{% endfor %}
```

ä½†æ˜¯é™¤ if è¯­å¥å—å¤–ï¼Œå…¶å®ƒç±»å‹çš„è¯­å¥å—éƒ½æœ‰è‡ªå·±çš„ä½œç”¨åŸŸã€‚æ¯”å¦‚ for è¯­å¥å—å†…éƒ¨èµ‹å€¼çš„å˜é‡åœ¨ for é€€å‡ºåå°±æ¶ˆå¤±ã€‚

ä¾‹å¦‚ï¼š

```python
{% set mylist = [1,2,3] %}
{% set mystr = "hello" %}
{% for item in mylist %}
  {{item}}
  {%set mystr="world"%}
{% endfor %}
{{mystr}}
```

æœ€åä¸€è¡Œæ¸²æŸ“çš„ç»“æœæ˜¯`hello`è€Œä¸æ˜¯`world`ã€‚

# è¿ç®—ç¬¦

## Math(ç®—æœ¯) è¿ç®—

- `+` # å°†ä¸¤ä¸ªå¯¹è±¡ç›¸åŠ ã€‚é€šå¸¸å¯¹è±¡æ˜¯æ•°å­—ï¼Œä½†å¦‚æœä¸¤è€…éƒ½æ˜¯å­—ç¬¦ä¸²æˆ–åˆ—è¡¨ï¼Œæ‚¨å¯ä»¥é€šè¿‡è¿™ç§æ–¹å¼è¿æ¥å®ƒä»¬ã€‚ç„¶è€Œï¼Œè¿™ä¸æ˜¯è¿æ¥å­—ç¬¦ä¸²çš„é¦–é€‰æ–¹å¼ï¼å¯¹äºå­—ç¬¦ä¸²è¿æ¥ï¼Œè¯·æŸ¥çœ‹ `~` è¿ç®—ç¬¦ã€‚ `{{ 1 + 1 }}` è¡¨è¾¾å¼çš„è¿”å›å€¼ä¸º 2ã€‚
   - `+` æ“ä½œç¬¦ä¹Ÿå¯ç”¨äºå­—ç¬¦ä¸²ä¸²è”ã€åˆ—è¡¨ç›¸åŠ ï¼Œä¾‹å¦‚`"a"+"b"`å¾—åˆ°â€abâ€ï¼Œ`[1,2]+[3,4]`å¾—åˆ°`[1,2,3,4]`
- `-` #
- `*` #
   - `*` ä¹Ÿå¯ç”¨äºé‡å¤å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚`"-" * 10`å¾—åˆ° 10 ä¸ªè¿ç»­çš„çŸ­æ¨ªçº¿
- `/` #
   - `/` æ˜¯æµ®ç‚¹æ•°é™¤æ³•ï¼Œä¾‹å¦‚ 3/2 å¾—åˆ° 1.5
- `//` #
   - `//` æ˜¯æˆªæ–­å¼æ•´é™¤æ³•ï¼Œä¾‹å¦‚ 20/7 å¾—åˆ° 2
- `%` #
- `**` #

## Comparisons(æ¯”è¾ƒ) è¿ç®—

- `>` #
- `<` #
- `>=` #
- `<=` #
- `==` #
- `!=` #

éœ€è¦è¯´æ˜ä¸€ç‚¹ï¼šæ¯”è¾ƒæ“ä½œä¸ä»…ä»…åªèƒ½æ¯”è¾ƒæ•°å€¼ï¼Œä¹Ÿèƒ½æ¯”è¾ƒå…¶å®ƒå¯¹è±¡ï¼Œæ¯”å¦‚å­—ç¬¦ä¸²ã€‚

ä¾‹å¦‚ `"hey" > "hello"` è¿”å› Trueã€‚

## Logic(é€»è¾‘) è¿ç®—ç¬¦

- `not` #
- `and` #
- `or` #
- `(expr)` #

## å…¶ä»–è¿ç®—ç¬¦

- `in` # æˆå‘˜æµ‹è¯•ï¼Œæµ‹è¯•æ˜¯å¦åœ¨å®¹å™¨å†…
- `is` # åš is æµ‹è¯•ï¼Œå‚è§åæ–‡
- `|` # è¿‡æ»¤å™¨ï¼Œå‚è§åæ–‡
- `~` # å­—ç¬¦ä¸²ä¸²è”

## æ€»ç»“ä¸è¯´æ˜

- `in` è¿ç®—ç¬¦å¯æµ‹è¯•å¤šç§å®¹å™¨ï¼Œå¸¸è§çš„åŒ…æ‹¬ï¼š
   - åˆ—è¡¨æµ‹è¯• `3 in [1,2,3]`
   - å­—ç¬¦ä¸²æµ‹è¯• `"h" in "hey"`
   - å­—å…¸æµ‹è¯• `"name" in {"name":"j333333unma","age":28}`
   - ä¸Šè¿°å‡ ç§æµ‹è¯•ç»“æœéƒ½æ˜¯ True
- `is` è¿ç®—ç¬¦å¯ä»¥åšå¾ˆå¤šæµ‹è¯•ï¼Œæ¯”å¦‚æµ‹è¯•æ˜¯å¦æ˜¯æ•°å€¼ã€æ˜¯å¦æ˜¯å­—ç¬¦ä¸²ã€å˜é‡æ˜¯å¦å®šä¹‰ã€ç­‰ç­‰
- `+` å¯ä»¥åšå­—ç¬¦ä¸²ä¸²è”ï¼Œ`~` ä¹Ÿå¯ä»¥åšå­—ç¬¦ä¸²ä¸²è”ï¼Œä¾‹å¦‚ `"ab" ~ "cd"` è¿ç®—ç»“æœä¸º `"abcd"`
- `not` è¿ç®—ç¬¦å’Œ `is`ã€`in` ç»“åˆæ—¶ï¼Œå¯ä»¥æ”¾åœ¨ä¸¤ä¸ªä½ç½®ã€‚ä¾‹å¦‚ï¼š
   - `not ("h" in "hey")` å’Œ `"h" not in "hey"` ä¸¤è€…æ˜¯ç­‰ä»·çš„
   - `not (3 is number())` å’Œ `3 is not number()` ä¸¤è€…æ˜¯ç­‰ä»·çš„

# Control Structures(æ§åˆ¶ç»“æ„)

> å®˜æ–¹æ–‡æ¡£: https://jinja.palletsprojects.com/en/latest/templates/#list-of-control-structures

- For(å¾ªç¯)
- If(æ¡ä»¶åˆ¤æ–­)
- Macros(å®)
- Call(è°ƒç”¨)
- Filters(è¿‡æ»¤)
- Assignments(èµ‹å€¼)
- Block Assignments(å—èµ‹å€¼)
- Extends(ç»§æ‰¿)
- Blocks(å—)
- Inclued(åŒ…å«)
- Import(å¯¼å…¥)

## æ¡ä»¶åˆ¤æ–­

Jinja ä¸­å¯ä»¥ä½¿ç”¨ if...else... è¯­å¥è¿›è¡Œæ¡ä»¶åˆ¤æ–­ï¼Œå…¶è¯­æ³•ä¸ºï¼š

```
{% if CONDITION_1 %}
  string_or_expression1
{% elif CONDITION_2 %}
  string_or_expression2
{% elif CONDITION_3 %}
  string_or_expression3
{% else %}
  string_or_expression4
{% endif %}
```

å…¶ä¸­ elif å’Œ else åˆ†æ”¯éƒ½æ˜¯å¯çœç•¥çš„ã€‚CONDITION éƒ¨åˆ†æ˜¯æ¡ä»¶è¡¨è¾¾å¼ï¼Œå…³äº Jinja æ”¯æŒçš„æ¡ä»¶è¡¨è¾¾å¼ï¼Œåé¢ä¼šä»‹ç»ã€‚

ä¾‹å¦‚ï¼Œæ¨¡æ¿æ–‡ä»¶ a.txt.j2 å†…å®¹å¦‚ä¸‹ï¼š

```
ä»Šå¤©æ˜ŸæœŸå‡ ï¼š
{% if whatday == "0" %}
  æ˜ŸæœŸæ—¥
{% elif whatday == "1" %}
  æ˜ŸæœŸä¸€
{% elif whatday == "2" %}
  æ˜ŸæœŸäºŒ
{% elif whatday == "3" %}
  æ˜ŸæœŸä¸‰
{% elif whatday == "4" %}
  æ˜ŸæœŸå››
{% elif whatday == "5" %}
  æ˜ŸæœŸäº”
{% elif whatday == "6" %}
  æ˜ŸæœŸå…­
{% else %}
  é”™è¯¯æ•°å€¼
{% endif %}
```

ä¸Šé¢åˆ¤æ–­å˜é‡ whatday çš„å€¼ï¼Œç„¶åè¾“å‡ºå¯¹åº”çš„æ˜ŸæœŸå‡ ã€‚å› ä¸º whatday å˜é‡çš„å€¼æ˜¯å­—ç¬¦ä¸²ï¼Œæ‰€ä»¥è®©å®ƒå’Œå­—ç¬¦ä¸²å½¢å¼çš„æ•°å€¼è¿›è¡Œç­‰å€¼æ¯”è¾ƒã€‚å½“ç„¶ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ç­›é€‰å™¨å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºæ•°å€¼åè¿›è¡Œæ•°å€¼æ¯”è¾ƒï¼š`whatday|int == 0`ã€‚

playbook å†…å®¹å¦‚ä¸‹ï¼š

```
---
- hosts: localhost
  gather_facts: no
  vars_prompt:
    - name: whatday
      default: 0
      prompt: "æ˜ŸæœŸå‡ (0->æ˜ŸæœŸæ—¥,1->æ˜ŸæœŸä¸€...):"
      private: no
  tasks:
    - template:
        src: a.txt.j2
        dest: /tmp/a.txt
```

å¦‚æœ if è¯­å¥çš„åˆ†æ”¯æ¯”è¾ƒç®€å• (æ²¡æœ‰ elif é€»è¾‘)ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨è¡Œå†… if è¡¨è¾¾å¼ã€‚

å…¶è¯­æ³•æ ¼å¼ä¸ºï¼š

```
string_or_expr1 if CONDITION else string_or_expr2
```

å› ä¸ºè¡Œå†… if æ˜¯è¡¨è¾¾å¼è€Œä¸æ˜¯è¯­å¥å—ï¼Œæ‰€ä»¥ä¸ä½¿ç”¨ `{%%}` ç¬¦å·ï¼Œè€Œä½¿ç”¨ `{{}}`ã€‚

ä¾‹å¦‚ï¼š

```yaml
- debug:
    msg: "{{'å‘¨æœ«' if whatday|int > 5 else 'å·¥ä½œæ—¥'}}"
```

### is è¿ç®—ç¬¦

jinja ä½¿ç”¨ `is` å…³é”®å­—ï¼Œå¯¹è¡¨è¾¾å¼çš„æ¸²æŸ“ç»“æœè¿›è¡Œæµ‹è¯•ï¼Œæµ‹è¯•ç»“æœæœ‰ä¸¤ç§ true å’Œ falseã€‚å¸¸ç”¨åœ¨ `{% if %}` è¡¨è¾¾å¼ä¸­ã€‚

æ¯”å¦‚ `name is defined` åˆ™è¡¨ç¤ºå¯¹ name è¿™ä¸ªè¡¨è¾¾å¼è¿›è¡Œæµ‹è¯•è¿™ä¸ªè¡¨è¾¾å¼ï¼Œä¼šæ ¹æ®åä¸º name çš„å˜é‡æ˜¯å¦è¢«å®šä¹‰ï¼Œè¿”å› true æˆ– falseã€‚

`is` è¿ç®—ç¬¦å¯ä»¥åšå¾ˆå¤šæµ‹è¯•æ“ä½œï¼Œæ¯”å¦‚æµ‹è¯•æ˜¯å¦æ˜¯æ•°å€¼ï¼Œæ˜¯å¦æ˜¯å­—ç¬¦ä¸²ç­‰ç­‰ã€‚ä¸‹è¡¨åˆ—å‡ºäº†æ‰€æœ‰ Jinja2 å†…ç½®çš„æµ‹è¯•å‡½æ•°ã€‚

| callable() | even() | le() | none() | string() |
| --- | --- | --- | --- | --- |
| defined() | ge() | lower() | number() | undefined() |
| divisibleby() | gt() | lt() | odd() | upper() |
| eq() | in() | mapping() | sameas() | escaped() |
| iterable() | ne() | sequence() |  |  |

å…¶ä¸­ callable()ã€escaped() å’Œ sameas() åœ¨ Ansible ä¸­å‡ ä¹ç”¨ä¸ä¸Šï¼Œæ‰€ä»¥ä¸è§£é‡Šã€‚

é™¤äº† Jinja2 çš„å†…ç½®æµ‹è¯•å‡½æ•°ï¼ŒAnsible è¿˜æœ‰è‡ªå·±æ‰©å±•çš„ is æµ‹è¯•å‡½æ•°ï¼Œåœ¨åæ–‡æˆ‘ä¼šç»Ÿä¸€åˆ—å‡ºæ¥ã€‚

è¿™äº›æµ‹è¯•å‡½æ•°æœ‰äº›å¯å¸¦å‚æ•°ã€æœ‰äº›ä¸å¸¦å‚æ•°ï¼Œå½“ä¸å¸¦å‚æ•°æˆ–åªå¸¦ä¸€ä¸ªå‚æ•°æ—¶ï¼Œæ‹¬å·å¯ä»¥çœç•¥ã€‚

ä¸‹é¢æ¼”ç¤ºä¸¤ä¸ªæµ‹è¯•æ˜¯å¦æ˜¯å­—ç¬¦ä¸²çš„ç¤ºä¾‹ï¼Œè®©å¤§å®¶çŸ¥é“è¯¥å¦‚ä½•ä½¿ç”¨è¿™äº›æµ‹è¯•å‡½æ•°è¿›è¡Œæµ‹è¯•ï¼Œä¹‹åç›´æ¥è§£é‡Šå„æµ‹è¯•å‡½æ•°çš„æ„ä¹‰ä¾¿å¯ã€‚

ç¤ºä¾‹ä¸€ï¼šåœ¨ when æ¡ä»¶ä¸­æµ‹è¯•

```yaml
- debug:
    msg: "a string"
  when: name is string
  vars:
    name: junmajinlong
```

ç¤ºä¾‹äºŒï¼šåœ¨ jinja æ¨¡æ¿çš„ if ä¸­æµ‹è¯•ã€‚æµ‹è¯• name å˜é‡ï¼Œå¦‚æœä¸æ˜¯å­—ç¬¦ä¸²ç±»å‹ï¼Œåˆ™ä¸ºçœŸã€‚

```
{% if name is not string %}
HELLOWORLD
{% endif %}
```

ä¸‹é¢æ˜¯å„æµ‹è¯•å‡½æ•°çš„ä½œç”¨ï¼š

- `defined()`å’Œ`undefined()` # æµ‹è¯•å˜é‡æ˜¯å¦å·²å®šä¹‰
- `number()`ã€`string()`ã€`none()` # æµ‹è¯•æ˜¯å¦æ˜¯ä¸€ä¸ªæ•°å€¼ã€å­—ç¬¦ä¸²ã€None
- `lt()`ã€`le()`ã€`gt()`ã€`ge()`ã€`eq()`ã€`ne()` # åˆ†åˆ«æµ‹è¯•æ˜¯å¦å°äºã€å°äºç­‰äºã€å¤§äºã€å¤§äºç­‰äºã€ç­‰äºã€ä¸ç­‰äº
- `lower()`å’Œ`upper()` # æµ‹è¯•å­—ç¬¦ä¸²æ˜¯å¦å…¨å°å†™ã€å…¨å¤§å†™
- `even()`å’Œ`odd()` # æµ‹è¯• value æ˜¯å¶æ•°è¿˜æ˜¯å¥‡æ•°
- `divisibleby(num)` # æµ‹è¯•æ˜¯å¦èƒ½è¢« num æ•´é™¤ï¼Œä¾‹å¦‚`18 is divisibleby 3`
- `in(seq)` # æµ‹è¯•æ˜¯å¦åœ¨ seq ä¸­ã€‚ä¾‹å¦‚`3 is in([1,2,3])`ã€`"h" is in("hey")`
- `mapping()` # æµ‹è¯•æ˜¯å¦æ˜¯ä¸€ä¸ªå­—å…¸
- `iterable()` # æµ‹è¯•æ˜¯å¦å¯è¿­ä»£ï¼Œåœ¨ Ansible ä¸­ä¸€èˆ¬å°±æ˜¯ listã€dictã€å­—ç¬¦ä¸²ï¼Œå½“ç„¶ï¼Œåœ¨ä¸åŒåœºæ™¯ä¸‹å¯èƒ½è¿˜ä¼šé‡åˆ°å…¶å®ƒå¯è¿­ä»£çš„ç»“æ„
- `sequence()` # æµ‹è¯•æ˜¯å¦æ˜¯ä¸€ä¸ªåºåˆ—ç»“æ„ï¼Œåœ¨ Ansible ä¸­ä¸€èˆ¬æ˜¯ listã€dictã€å­—ç¬¦ä¸² (æ³¨ï¼šå­—ç¬¦ä¸²ã€dict åœ¨ python ä¸­ä¸æ˜¯åºåˆ—ï¼Œä½†æ˜¯åœ¨ Jinja2 æµ‹è¯•ä¸­ï¼Œå±äºåºåˆ—)

çºµè§‚ä¸Šé¢çš„å†…ç½®æµ‹è¯•å‡½æ•°ï¼Œä¼¼ä¹å¹¶æ²¡æœ‰æä¾›ç›´æ¥æµ‹è¯•æ˜¯å¦æ˜¯ä¸€ä¸ªåˆ—è¡¨ç±»å‹çš„åŠŸèƒ½ï¼Œä½†åœ¨ Ansible ä¸­å´ä¼šç»å¸¸éœ€è¦å»åˆ¤æ–­æ‰€å®šä¹‰çš„å˜é‡æ˜¯å¦æ˜¯ä¸€ä¸ªåˆ—è¡¨ã€‚æ‰€ä»¥è¿™æ˜¯ä¸€ä¸ªå¸¸è§çš„éœ€æ±‚ï¼Œå¯å‚è€ƒå¦‚ä¸‹é—´æ¥æµ‹è¯•æ˜¯å¦æ˜¯åˆ—è¡¨çš„ä»£ç ç‰‡æ®µï¼š

```
(VAR is sequence) and (VAR is not string) and (VAR is not mapping)
```

å¦‚æœå¤§å®¶ä»¥åæ·±å…¥åˆ° Ansible çš„å¼€å‘æ–¹é¢ï¼Œå¯ä»¥è‡ªå®šä¹‰ Ansible çš„æ¨¡å—å’Œæ’ä»¶ï¼Œé‚£ä¹ˆå°±å¯ä»¥è‡ªå·±å†™ä¸€ä¸ªæ›´å®Œå–„çš„ Filter æ’ä»¶æ¥æµ‹è¯•æ˜¯å¦æ˜¯ listã€‚ä¸‹é¢æˆ‘ç®€å•æ¼”ç¤ºä¸‹åŸºæœ¬æ­¥éª¤ï¼Œå¤§å®¶èƒ½ä¾è‘«èŠ¦ç”»ç“¢æ›´å¥½ï¼Œä¸ç†è§£ä¹Ÿæ²¡ä»»ä½•å…³ç³»ã€‚

é¦–å…ˆåˆ›å»º filter_plugins ç›®å½•å¹¶åœ¨å…¶å†…åˆ›å»ºä¸€ä¸ª py æ–‡ä»¶ï¼Œä¾‹å¦‚ collection.pyï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```python
def islist(collection):
  '''
  test data type is a list or not
  '''
  return isinstance(collection, list)

class FilterModule(object):
  '''
  custom jinja2 filter for test list type
  '''
  def filters(self):
    return {
      'islist': islist
    }
```

ç„¶ååœ¨ playbook ä¸­ä¾¿å¯ä½¿ç”¨ islist() è¿™ä¸ªç­›é€‰å™¨æ¥åˆ¤æ–­æ˜¯å¦æ˜¯åˆ—è¡¨ç±»å‹ã€‚ä¾‹å¦‚ï¼š

```
- debug:
    msg: "a list"
  when: p | islist
  vars:
    p:
      - p1
      - p2
```
## Filters(è¿‡æ»¤å™¨)

é€šå¸¸ï¼Œæ¨¡æ¿è¯­è¨€éƒ½ä¼šå¸¦æœ‰è¿‡æ»¤å™¨ï¼ŒJinJa ä¹Ÿä¸ä¾‹å¤–ï¼Œæ¯ä¸ªè¿‡æ»¤å™¨å‡½æ•°éƒ½æ˜¯ä¸€ä¸ªåŠŸèƒ½ï¼Œä½œç”¨å°±ç±»ä¼¼äºå‡½æ•°ï¼Œè€Œä¸”å®ƒä¹Ÿå¯ä»¥æ¥å‚æ•°ã€‚å˜é‡å¯ä»¥é€šè¿‡ **Filters(è¿‡æ»¤å™¨)** ä¿®æ”¹ã€‚Jinja ä¸­æœ‰ä¸¤ç§ä½¿ç”¨ Filters çš„æ–¹å¼ï¼š

- **`|` ç¬¦å·** # è¿‡æ»¤å™¨ ä¸ å˜é‡ ä¹‹é—´ä½¿ç”¨ `|` ç¬¦å·åˆ†å‰²ï¼Œå¹¶ä¸”å¯ä»¥ä½¿ç”¨ `()` ç¬¦å·ä¼ é€’å‚æ•°ã€‚å¤šä¸ªè¿‡æ»¤å™¨å¯ä»¥é“¾å¼è°ƒç”¨ï¼Œå‰ä¸€ä¸ªè¿‡æ»¤å™¨çš„è¿”å›å€¼ä¼šä½œä¸ºæœ‰ä¸€ä¸ªè¿‡æ»¤å™¨çš„è¾“å…¥ã€‚
- **`filter` å…³é”®å­—** #

### `|` ç¬¦å·

ä¾‹å¦‚ï¼ŒJinja æœ‰ä¸€ä¸ªå†…ç½® `lower()` è¿‡æ»¤å™¨å‡½æ•°ï¼Œå¯ä»¥å°†å­—ç¬¦ä¸²å…¨éƒ¨è½¬åŒ–æˆå¤§å†™å­—æ¯ã€‚

```yaml
- debug:
    msg: "{{'hello world'|upper()}}"
```

å¦‚æœè¿‡æ»¤å™¨å‡½æ•°æ²¡æœ‰ç»™å®šå‚æ•°ï¼Œåˆ™æ‹¬å·å¯ä»¥çœç•¥ï¼Œä¾‹å¦‚ `"HELLO"|upper`ã€‚

### `filter` å…³é”®å­—

æˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨ filter å…³é”®å­—ï¼Œåœ¨è¯­å¥è¡¨è¾¾å¼ä¸­ä½¿ç”¨è¿‡æ»¤å™¨ï¼Œä»¥å¯¹æ¨¡æ¿ä¸­çš„ ä¸€å—æ•°æ®(è€Œä¸æ˜¯ä¸€è¡Œæˆ–ä¸€ä¸ªå˜é‡) è¿›è¡Œç­›é€‰æ“ä½œï¼Œæ¯”å¦‚ï¼š

```python
{% filter upper %}
    è¿™éƒ¨åˆ†æ–‡æœ¬å†…å®¹ä¸­ï¼Œå°å†™å­—æ¯å°†ä¼šå˜æˆå¤§å†™çš„
    This text becomes uppercase
{% endfilter %}
```

æœ‰äº›ç­›é€‰å™¨å‡½æ•°éœ€è¦ç»™å®šå‚æ•°ï¼Œä¾‹å¦‚ replace() ç­›é€‰å™¨ï¼Œå¯ä»¥å°†å­—ç¬¦ä¸²ä¸­çš„ä¸€éƒ¨åˆ†æ›¿æ¢æ‰ã€‚ä¾‹å¦‚ï¼Œå°†å­—ç¬¦ä¸²ä¸­çš„â€noâ€ æ›¿æ¢æˆâ€yesâ€ã€‚

```yaml
{% if result %}
{{result|replace('no', 'yes')}}
{%endif%}
```

### Jinja å†…ç½®è¿‡æ»¤å™¨

JinJa å†…ç½®äº†å¤šä¸ªè¿‡æ»¤å™¨å‡½æ•°ï¼ŒAnsible è‡ªèº«ä¹Ÿæ‰©å±•äº†ä¸€äº›æ–¹ä¾¿çš„ç­›é€‰å™¨å‡½æ•°ï¼Œæ‰€ä»¥æ•°é‡éå¸¸å¤šã€‚å¦‚ä¸‹ï¼š

| abs() | float() | lower() | round() | tojson() |
| --- | --- | --- | --- | --- |
| attr() | forceescape() | map() | safe() | trim() |
| batch() | format() | max() | select() | truncate() |
| capitalize() | groupby() | min() | selectattr() | unique() |
| center() | indent() | pprint() | slice() | upper() |
| default() | int() | random() | sort() | urlencode() |
| dictsort() | join() | reject() | string() | urlize() |
| escape() | last() | rejectattr() | striptags() | wordcount() |
| filesizeformat() | length() | replace() | sum() | wordwrap() |
| first() | list() | reverse() | title() | xmlattr() |

æˆ‘ä¼šå°†å®ƒä»¬ä¸­ç»å¤§å¤šæ•°çš„å«ä¹‰åˆ—ä¸¾å‡ºæ¥ (å‰©ä¸‹ä¸€éƒ¨åˆ†æ˜¯æˆ‘è§‰å¾—åœ¨ Ansible ä¸­ç”¨ä¸ä¸Šçš„ï¼Œæ¯”å¦‚ escape() è½¬ä¹‰ä¸º HTML å®‰å…¨å­—ç¬¦ä¸²)ï¼Œå„ä½æ²¡å¿…è¦å…¨éƒ½æµ‹è¯•ä¸€éï¼Œä½†æ˜¯é€Ÿçœ‹ä¸€éå¹¶å¤§æ¦‚äº†è§£å®ƒä»¬çš„å«ä¹‰å’Œä½œç”¨æ˜¯æœ‰å¿…è¦çš„ã€‚

- `float(default=0.0)` # å°†æ•°å€¼å½¢å¼çš„å­—ç¬¦ä¸²è½¬æ¢ä¸ºæµ®ç‚¹æ•°ã€‚å¦‚æœæ— æ³•è½¬æ¢ï¼Œåˆ™è¿”å›é»˜è®¤å€¼ 0.0ã€‚å¯ä½¿ç”¨ default å‚æ•°è‡ªå®šä¹‰è½¬æ¢å¤±è´¥æ—¶çš„é»˜è®¤å€¼ã€‚
   - ä¾‹å¦‚`"abcd"|float`ã€`""|float`éƒ½è½¬æ¢ä¸º 0.0ï¼Œ`""|float('NaN')`è¿”å›çš„æ˜¯å­—ç¬¦ä¸² NaNï¼Œè¡¨ç¤ºéæ•°å€¼å«ä¹‰ã€‚
- `int(default=0,base=10)` # å°†æ•°å€¼å½¢å¼çš„å­—ç¬¦ä¸²ç›´æ¥æˆªæ–­ä¸ºæ•´æ•°ã€‚å¦‚æœæ— æ³•è½¬æ¢ï¼Œåˆ™è¿”å›é»˜è®¤å€¼ 0ã€‚å¯ä½¿ç”¨ default å‚æ•°è‡ªå®šä¹‰è½¬æ¢å¤±è´¥æ—¶çš„é»˜è®¤å€¼ã€‚
   - æ­¤å¤–ï¼Œè¿˜å¯ä»¥æŒ‡å®šè¿›åˆ¶å‚æ•° baseï¼Œæ¯”å¦‚ base=2 è¡¨ç¤ºå°†ä¼ é€’è¿‡æ¥çš„å‚æ•°å½“ä½œäºŒè¿›åˆ¶è¿›è¡Œè§£æï¼Œç„¶åè½¬æ¢ä¸º 10 è¿›åˆ¶æ•°å€¼ã€‚
   - ä¾‹å¦‚`'3.55'|int`ç»“æœä¸º 3ï¼Œ`'0b100'|int(base=2)`ç»“æœä¸º 4ã€‚
- `abs()` # è®¡ç®—ç»å¯¹å€¼ã€‚
   - æ³¨æ„ï¼Œåªèƒ½è®¡ç®—æ•°å€¼ï¼Œå¦‚æœä¼ é€’çš„æ˜¯å­—ç¬¦ä¸²ï¼Œå¯ä½¿ç”¨ç­›é€‰å™¨ int() æˆ– float() å…ˆè½¬æ¢æˆæ•°å€¼ã€‚ä¾‹å¦‚`'-3.14'|float|abs`ã€‚
- `round(precision=0,method='common')` # å¯¹æ•°å€¼è¿›è¡Œå››èˆäº”å…¥ã€‚ç¬¬ä¸€ä¸ªå‚æ•°æŒ‡å®šå››èˆäº”å…¥çš„ç²¾åº¦ï¼Œç¬¬äºŒä¸ªå‚æ•°æŒ‡å®šå››èˆäº”å…¥çš„æ–¹å¼ï¼Œæœ‰ä¸‰ç§æ–¹å¼å¯é€‰æ‹©ï¼š
   - ceilï¼šåªå…¥ä¸èˆ
   - floorï¼šåªèˆä¸å…¥
   - commonï¼šå°äºäº”çš„èˆï¼Œå¤§äºç­‰äº 5 çš„å…¥
   - æ³¨æ„ï¼š
      - åªèƒ½è®¡ç®—æ•°å€¼ï¼Œå¦‚æœä¼ é€’çš„æ˜¯å­—ç¬¦ä¸²ï¼Œå¯ä½¿ç”¨ç­›é€‰å™¨ int() æˆ– float() å…ˆè½¬æ¢æˆæ•°å€¼
      - è®¡ç®—çš„æ˜¯æ•´æ•°ï¼Œåˆ™è¿”å›å€¼æ˜¯æ•´æ•°ï¼Œè®¡ç®—çš„æ˜¯æµ®ç‚¹æ•°ï¼Œåˆ™è¿”å›å€¼æ˜¯æµ®ç‚¹æ•°
   - ä¾‹å¦‚`42.55|round`çš„ç»“æœä¸º 43.0ï¼Œ`45|round`çš„ç»“æœæ˜¯ 45ï¼Œ`42.55|round(1,'floor')`çš„ç»“æœæ˜¯ 42.5ã€‚
- `random()` # è¿”å›ä¸€ä¸ªéšæœºæ•´æ•°ã€‚ç«–çº¿å·¦è¾¹çš„å€¼ X å†³å®šäº†éšæœºæ•°çš„èŒƒå›´ä¸º`[0,X)`ã€‚
   - ä¾‹å¦‚`5|random`ç”Ÿæˆçš„éšæœºæ•°å¯èƒ½æ˜¯ 0ã€1ã€2ã€3ã€4ã€‚
- `list()` # è½¬æ¢ä¸ºåˆ—è¡¨ã€‚å¦‚æœè¦è½¬æ¢çš„ç›®æ ‡æ˜¯å­—ç¬¦ä¸²ï¼Œåˆ™è¿”å›çš„åˆ—è¡¨æ˜¯å­—ç¬¦ä¸²ä¸­çš„æ¯ä¸ªå­—ç¬¦ã€‚
   - ä¾‹å¦‚`range(1,4)|list`çš„ç»“æœæ˜¯`[1,2,3]`ï¼Œ`"hey"|list`çš„ç»“æœæ˜¯`["h","e","y"]`ã€‚
- `string()` # è½¬æ¢ä¸ºå­—ç¬¦ä¸²ã€‚
   - ä¾‹å¦‚`"333aa"`ç»“æœä¸ºâ€333aaâ€ã€‚
- `tojson()` # è½¬æ¢ä¸º json æ ¼å¼ã€‚
- `lower()`ã€`upper()`ã€`title()`ã€`capitalize()` # lower() å°†å¤§å†™å­—æ¯è½¬æ¢ä¸ºå°å†™ã€‚upper() å°†å°å†™å­—æ¯è½¬æ¢ä¸ºå¤§å†™ã€‚title() å°†æ¯ä¸ªé¦–å­—æ¯è½¬ä¸ºå¤§å†™ã€‚capitalize() å°†ç¬¬ä¸€ä¸ªå•è¯é¦–å­—æ¯è½¬ä¸ºå¤§å†™ã€‚
- `min()`ã€`max()` # ä»åºåˆ—ä¸­å–æœ€å°ã€æœ€å¤§å€¼ã€‚
   - ä¾‹å¦‚`["a","abddd","cba"]|max`å¾—åˆ° cbaã€‚
- `sum(start=0)` # è®¡ç®—åºåˆ—ä¸­å„å…ƒç´ çš„ç®—æœ¯å’Œã€‚å¯æŒ‡å®š start å‚æ•°ä½œä¸ºç®—æœ¯å’Œçš„èµ·ç‚¹ã€‚
   - ä¾‹å¦‚`[1,2,3]|sum`å¾—åˆ° 6ï¼Œ`[1,2,3]|sum(start=3)`å¾—åˆ° 9ã€‚
- `trim()` # ç§»é™¤å­—ç¬¦ä¸²å‰ç¼€å’Œåç¼€ç©ºç™½ã€‚
   - ä¾‹å¦‚`"abcd"|trim ~ "DEF"`å¾—åˆ°â€abcdDEFâ€ã€‚
- `truncate()` # æˆªæ–­å­—ç¬¦ä¸²ä¸ºæŒ‡å®šé•¿åº¦ã€‚ä¸»è¦ç”¨äº web ç¼–ç¨‹ï¼ŒAnsible ç”¨ä¸åˆ°ã€‚
- `replace(old,new,count=None)` # å°†å­—ç¬¦ä¸²ä¸­çš„ old æ›¿æ¢æˆ newï¼Œcount å‚æ•°æŒ‡å®šæ›¿æ¢å¤šå°‘æ¬¡ï¼Œé»˜è®¤æ›¿æ¢æ‰€æœ‰åŒ¹é…æˆåŠŸçš„ã€‚
   - ä¾‹å¦‚`"you see see you"|replace("see","look")`å¾—åˆ°`you look look you`ï¼Œè€Œ`replace("see","look",1)`åˆ™å¾—åˆ°`you look see you`ã€‚
- `first()`ã€`last()` # è¿”å›åºåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªã€æœ€åä¸€ä¸ªå…ƒç´ ã€‚
   - ä¾‹å¦‚`"hello world" | last`è¿”å›å­—æ¯ dï¼Œ`[2,3,4]|last`è¿”å›æ•°å€¼ 4ã€‚
- `map(attribute='xxx')` # å¦‚æœä¸€ä¸ªåˆ—è¡¨ä¸­åŒ…å«äº†å¤šä¸ª dictï¼Œmap å¯æ ¹æ®æŒ‡å®šçš„å±æ€§å (å³ dict çš„ key)ï¼Œä»åˆ—è¡¨ä¸­å„ dict å†…ç­›é€‰å‡ºè¯¥å±æ€§å€¼éƒ¨åˆ†ã€‚
   - ä¾‹å¦‚ï¼Œå¯¹äºå¦‚ä¸‹å˜é‡ï¼š
```
p:
  - name: "junma"
    age: 23
  - name: woniu
    age: 22
    weight: 45
  - name: tuner
    age: 25
    weight: 50
```

   - `p|map(attribute="name")|list`å°†å¾—åˆ°`["junma","woniu","tuner"]`ã€‚
- `select()`ã€`reject()` # ä»åºåˆ—ä¸­é€‰ä¸­ã€æ’é™¤æ»¡è¶³æ¡ä»¶çš„é¡¹ã€‚ä¾‹å¦‚ï¼š

```
{{ numbers|select("odd") }}         ->é€‰å‡ºå¥‡æ•°
{{ numbers|select("even") }}        ->é€‰å‡ºå¶æ•°
{{ numbers|select("lt", 42) }}      ->é€‰å‡ºå°äº42çš„æ•°
{{ strings|select("eq", "mystr") }} ->é€‰å‡º"mystr"å…ƒç´ 
{{ numbers|select("divisibleby", 3) }} ->é€‰å‡ºè¢«3æ•´é™¤çš„æ•°
```

   - å…¶ä¸­æµ‹è¯•å‚æ•°å¯ä»¥æŒ‡å®šä¸ºæ”¯æŒçš„æµ‹è¯•å‡½æ•°ï¼Œåœ¨å‰æ–‡å·²ç»ä»‹ç»è¿‡ã€‚
- `selectattr()`ã€`rejectattr()` # æ ¹æ®å¯¹è±¡å±æ€§ç­›é€‰ã€æ’é™¤åºåˆ—ä¸­çš„å¤šä¸ªå…ƒç´ ã€‚è¿™ä¸ªæœ‰æ—¶å€™å¾ˆå¥½ç”¨ã€‚æ¯”å¦‚ï¼š
```
p:
  - name: "junma"
    age: 23
  - name: woniu
    age: 22
    weight: 45
  - name: tuner
    age: 25
    weight: 50
```
ç­›é€‰æ‰€æœ‰ age å¤§äº 22 å²çš„å¯¹è±¡ï¼š
```
p|selectattr('age','gt',22)|list
```
å¾—åˆ°çš„ç»“æœï¼š
```
[
  {"age": 23,"name": "junma"},
  {"age": 25,"name": "tuner","weight": 50}
]
```

- `batch(count,fill_withs=None)` # å°†åºåˆ—ä¸­æ¯ count ä¸ªå…ƒç´ æ‰“åŒ…æˆä¸€ä¸ªåˆ—è¡¨ã€‚æœ€åä¸€ä¸ªåˆ—è¡¨å¯èƒ½å…ƒç´ ä¸ªæ•°ä¸å¤Ÿï¼Œé»˜è®¤ä¸å¡«å……ï¼Œå¦‚æœè¦å¡«å……ï¼Œåˆ™æŒ‡å®š`fill_with`å‚æ•°ã€‚
   - ä¾‹å¦‚`[1,2,3,4,5]|batch(2)|list`å¾—åˆ°`[[1,2],[3,4],[5]]`ï¼Œ`[1,2,3,4,5]|batch(2,'x')|list`å¾—åˆ°`[[1,2],[3,4],[5,'x']]`ã€‚

- `default('default_value',bool=False)`æˆ–`d()` # å¦‚æœç«–çº¿å·¦è¾¹çš„å˜é‡æœªå®šä¹‰ï¼Œåˆ™è¿”å› default() æŒ‡å®šçš„é»˜è®¤å€¼ã€‚é»˜è®¤åªå¯¹æœªå®šä¹‰å˜é‡å…¶ä½œç”¨ï¼Œå¦‚æœæƒ³è®© default() ä¹Ÿèƒ½å¯¹å¸ƒå°”ç±»å‹çš„æ•°æ®ç”Ÿæ•ˆï¼Œéœ€å°†ç¬¬äºŒä¸ªå‚æ•°è®¾ç½®ä¸º trueã€‚
   - `d()`æ˜¯`default()`çš„ç®€å†™æ–¹å¼ã€‚
   - ä¾‹å¦‚`myvar|d('undefined')`åœ¨ myvar ä¸å­˜åœ¨æ—¶è¿”å› undefined å­—ç¬¦ä¸²ï¼Œ`""|d("empty")`ä¸­å› ä¸ºæ˜¯ç©ºå­—ç¬¦ä¸²è€Œä¸æ˜¯æœªå®šä¹‰å˜é‡ï¼Œæ‰€ä»¥ä»ç„¶è¿”å›ç©ºå­—ç¬¦ä¸²ï¼Œ`""|d("empty",true)`åˆ™è¿”å› empty å­—ç¬¦ä¸²ã€‚
- `unique()` # å¯¹åºåˆ—ä¸­è¿›è¡Œå»é‡æ“ä½œã€‚
   - ä¾‹å¦‚`[1,2,3,3,1,2]|unique`å¾—åˆ°ç»“æœ`[1,2,3]`ã€‚

(22).`join(d="")`

å°†åºåˆ—ä¸­çš„å…ƒç´ ä½¿ç”¨ d å‚æ•°æŒ‡å®šçš„ç¬¦å·ä¸²è”æˆå­—ç¬¦ä¸²ï¼Œé»˜è®¤è¿æ¥ç¬¦ä¸ºç©ºå­—ç¬¦ä¸²ã€‚

ä¾‹å¦‚`[1,2,3]|join("-")`å¾—åˆ°`1-2-3`ï¼Œ`[1,2,3]|join`å¾—åˆ° 123ã€‚

(23).`length()`å’Œ`count()`

è¿”å›åºåˆ—ä¸­å…ƒç´ çš„æ•°é‡æˆ–å­—ç¬¦ä¸²çš„å­—ç¬¦ä¸ªæ•°ã€‚length å’Œ count æ˜¯åˆ«åç­‰ä»·çš„å…³ç³»ã€‚

(24).`wordcount`

è®¡ç®—å­—ç¬¦ä¸²ä¸­çš„å•è¯ä¸ªæ•°ã€‚

(25).`reverse()`

é¢ å€’åºåˆ—å…ƒç´ ã€‚

ä¾‹å¦‚`"hello"|reverse`å¾—åˆ°`olleh`ï¼Œ`[1,2,3]|reverse|list`å¾—åˆ°`[3,2,1]`ã€‚

(26).`filesizeformat(binary=False)`

å°†æ•°å€¼å¤§å°è½¬æ¢ä¸º kBã€MBã€GB å•ä½ã€‚é»˜è®¤æŒ‰ç…§ 1000 ä¸ºå•ä½è¿›è¡Œæ¢ç®—ï¼Œå¦‚æœæŒ‡å®š binary å‚æ•°ä¸º Trueï¼Œåˆ™æŒ‰ 1024 è¿›è¡Œæ¢ç®—ã€‚

(27).`slice(N, fill_with=None)`

å°†åºåˆ—å‡åˆ†ä¸º N ä¸ªåˆ—è¡¨ï¼Œå¯æŒ‡å®š`fill_with`å‚æ•°æ¥å¡«å……å‡åˆ†æ—¶ä¸è¶³çš„åˆ—è¡¨ã€‚

ä¾‹å¦‚ï¼š

```
[1,2,3,4,5]|slice(3)    |list -> [[1,2],[3,4],[5]]
[1,2,3,4]  |slice(3,"x")|list -> [[1,2],[3,"x"],[4,"x"]]
```

(28).`groupby(attribute)`
æ ¹æ®æŒ‡å®šçš„å±æ€§å¯¹ dict è¿›è¡Œåˆ†ç»„ã€‚çœ‹ä¸‹é¢çš„ä¾‹å­ï¼š

```yaml
- debug:
    msg: '{{person|groupby("name")}}'
  vars:
    person:
      - name: "junma"
        age: 23
      - name: "junma"
        age: 33
      - name: woniu
        age: 22
        weight: 45
      - name: tuner
        age: 25
        weight: 50
```

å¾—åˆ°çš„ç»“æœï¼š

```
[
  ["junma", [{"age": 23,"name": "junma"},{"age": 33,"name": "junma"}]],
  ["tuner", [{"age": 25,"name": "tuner","weight": 50}]],
  ["woniu", [{"age": 22,"name": "woniu","weight": 45}]]
]
```

(29).`indent(width=4)`
å¯¹å­—ç¬¦ä¸²è¿›è¡Œç¼©è¿›æ ¼å¼åŒ–ã€‚é»˜è®¤ç¼©è¿›å®½åº¦ä¸º 4ã€‚

(30).`format()`
ç±»ä¼¼äº`printf`çš„æ–¹å¼æ ¼å¼åŒ–å­—ç¬¦ä¸²ã€‚å¯¹äºç†Ÿæ‚‰ Python çš„äººæ¥è¯´ï¼Œä½¿ç”¨`%`æˆ–`str.format()`æ ¼å¼åŒ–å­—ç¬¦ä¸²è¦æ›´æ–¹ä¾¿äº›ã€‚

ä¸‹é¢æ˜¯ç­‰ä»·çš„ï¼š

```
{{ "%s, %s!"|format("hello", "world") }}
{{ "%s, %s!" % ("hello", "world") }}
{{ "{}, {}!".format("hello", "world") }}
```

(31).`center(witdth=80)`
å°†å­—ç¬¦ä¸²æ‰©å……åˆ°æŒ‡å®šå®½åº¦å¹¶æ”¾åœ¨ä¸­é—´ä½ç½®ï¼Œé»˜è®¤ 80 ä¸ªå­—ç¬¦ã€‚

ä¾‹å¦‚`"hello"|center(10)|replace("","-")`å¾—åˆ°`"--hello---"`ã€‚

(32).`sort(reverse=False, case_sensitive=False, attribute=None)`
å¯¹åºåˆ—ä¸­çš„å…ƒç´ è¿›è¡Œæ’åºï¼Œattribute æŒ‡å®šæŒ‰ç…§ä»€ä¹ˆè¿›è¡Œæ’åºã€‚

ä¾‹å¦‚`["acd","a","ca"]|sort`å¾—åˆ°`["a","acd","ca"]`ã€‚

å†ä¾‹å¦‚ï¼Œå¯¹äºä¸‹é¢çš„å˜é‡ï¼š

```
person:
  - name: "junma"
    age: 23
  - name: woniu
    age: 22
    weight: 45
  - name: tuner
    age: 25
    weight: 50
```

å¯ä»¥ä½¿ç”¨`person|sort(attribute="age")`å¯¹ 3 ä¸ªå…ƒç´ æŒ‰ç…§ age è¿›è¡Œå‡åºæ’åºã€‚

(33).`dictsort(case_sensitive=False, by='key', reverse=False)`
å¯¹å­—å…¸è¿›è¡Œæ’åºã€‚é»˜è®¤æŒ‰ç…§ key è¿›è¡Œæ’åºï¼Œå¯ä»¥æŒ‡å®šä¸º`value`æŒ‰ç…§ value è¿›è¡Œæ’åºã€‚

ä¾‹å¦‚ï¼š

```
person:
  p2:
    name: "junma"
    age: 23
  p1:
    name: woniu
    age: 22
    weight: 45
  p3:
    name: tuner
    age: 25
    weight: 50
```

å¯ä»¥ä½¿ç”¨`person|dictsort`æŒ‰ç…§ key(å³ p1ã€p2ã€p3) è¿›è¡Œæ’åºï¼Œç»“æœæ˜¯å…ˆ p1ï¼Œå† p2ï¼Œæœ€å p3ã€‚
## å¾ªç¯
### for è¿­ä»£åˆ—è¡¨
for å¾ªç¯çš„è¯­æ³•ï¼š
```python
{% for i in LIST %}
    string_or_expression
{% endfor %}
```
è¿˜æ”¯æŒç›´æ¥æ¡ä»¶åˆ¤æ–­ç­›é€‰è¦å‚ä¸è¿­ä»£çš„å…ƒç´ ï¼š
```python
{% for i in LIST if CONDITION %}
    string_or_expression
{% endfor %}
```
æ­¤å¤–ï¼ŒJinja2 çš„ for è¯­å¥è¿˜å…è®¸ä½¿ç”¨ else åˆ†æ”¯ï¼Œå¦‚æœ for æ‰€è¿­ä»£çš„åˆ—è¡¨ LIST æ˜¯ç©ºåˆ—è¡¨ (æˆ–æ²¡æœ‰å…ƒç´ å¯è¿­ä»£)ï¼Œåˆ™ä¼šæ‰§è¡Œ else åˆ†æ”¯ã€‚
```
{% for i in LIST %}
    string_or_expression
{% else %}
    string_or_expression
{% endfor %}
```
ä¾‹å¦‚ï¼Œåœ¨æ¨¡æ¿æ–‡ä»¶ a.txt.j2 ä¸­æœ‰å¦‚ä¸‹å†…å®¹ï¼š
```
{% for file in files %}
<{{file}}>
{% else %}
no file in files
{% endfor %}
```
playbook æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š
```yaml
---
- hosts: localhost
  gather_facts: no
  tasks:
    - template:
        src: a.txt.j2
        dest: /tmp/a.txt
      vars:
        files:
          - /tmp/a1
          - /tmp/a2
          - /tmp/a3
```
æ‰§è¡Œ playbook ä¹‹åï¼Œå°†ç”ŸæˆåŒ…å«å¦‚ä¸‹å†…å®¹çš„ / tmp/a.txt æ–‡ä»¶ï¼š
```
</tmp/a1>
</tmp/a2>
</tmp/a3>
```
å¦‚æœå°† playbook ä¸­çš„`files`å˜é‡è®¾ç½®ä¸ºç©ºåˆ—è¡¨ï¼Œåˆ™ä¼šæ‰§è¡Œ else åˆ†æ”¯ï¼Œæ‰€ä»¥ç”Ÿæˆçš„ / tmp/a.txt çš„å†…å®¹ä¸ºï¼š
```
no file in files
```
å¦‚æœ files å˜é‡æœªå®šä¹‰æˆ–å˜é‡ç±»å‹ä¸æ˜¯ listï¼Œåˆ™é»˜è®¤ä¼šæŠ¥é”™ã€‚é’ˆå¯¹æœªå®šä¹‰å˜é‡ï¼Œå¯é‡‡ç”¨å¦‚ä¸‹ç­–ç•¥æä¾›é»˜è®¤ç©ºåˆ—è¡¨ï¼š
```
{% for file in (files|default([])) %}
<{{file}}>
{% else %}
no file in files
{% endfor %}
```
å¦‚æœä¸æƒ³è¿­ä»£æ–‡ä»¶åˆ—è¡¨ä¸­çš„`/tmp/a3`ï¼Œåˆ™å¯ä»¥åŠ ä¸Šæ¡ä»¶åˆ¤æ–­ï¼š
```
{% for file in (files|default([])) if file != "/tmp/a3" %}
<{{file}}>
{% else %}
no file in files
{% endfor %}
```
Jinja2 çš„ for å¾ªç¯æ²¡æœ‰æä¾› break å’Œ continue çš„åŠŸèƒ½ï¼Œæ‰€ä»¥åªèƒ½é€šè¿‡ {% for...if...%} æ¥é—´æ¥å®ç°ç±»ä¼¼åŠŸèƒ½ã€‚

### for è¿­ä»£å­—å…¸
é»˜è®¤æƒ…å†µä¸‹ï¼ŒJinja2 çš„ for è¯­å¥åªèƒ½è¿­ä»£åˆ—è¡¨ã€‚

å¦‚æœè¦è¿­ä»£å­—å…¸ç»“æ„ï¼Œéœ€è¦å…ˆä½¿ç”¨å­—å…¸çš„`items()`æ–¹æ³•è¿›è¡Œè½¬æ¢ã€‚å¦‚æœæ²¡æœ‰å­¦è¿‡ pythonï¼Œæˆ‘ä¸‹é¢åšä¸ªç®€å•è§£é‡Šï¼š

å¯¹äºä¸‹é¢çš„å­—å…¸ç»“æ„ï¼š

```
p:
  name: junmajinlong
  age: 18
```

å¦‚æœä½¿ç”¨`p.items()`ï¼Œå°†è®¡ç®—å¾—åˆ°å¦‚ä¸‹ç»“æœï¼š

```
[('name', 'junmajinlong'), ('age', 18)]
```

ç„¶å for è¯­å¥ä¸­ä½¿ç”¨ä¸¤ä¸ªè¿­ä»£å˜é‡åˆ†åˆ«ä¿å­˜å„åˆ—è¡¨å…ƒç´ ä¸­çš„å­å…ƒç´ å³å¯ã€‚ä¸‹é¢è®¾ç½®äº†ä¸¤ä¸ªè¿­ä»£å˜é‡ key å’Œ valueï¼š

```
{% for key,value in p.items() %}
```

é‚£ä¹ˆç¬¬ä¸€è½®è¿­ä»£æ—¶ï¼Œkey å˜é‡ä¿å­˜çš„æ˜¯ name å­—ç¬¦ä¸²ï¼Œvalue å˜é‡ä¿å­˜çš„æ˜¯ junmajinlong å­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆç¬¬äºŒè½®è¿­ä»£æ—¶ï¼Œkey å˜é‡ä¿å­˜çš„æ˜¯ age å­—ç¬¦ä¸²ï¼Œvalue å˜é‡ä¿å­˜çš„æ˜¯ 18 æ•°å€¼ã€‚

å¦‚æœ for è¿­ä»£æ—¶ä¸æƒ³è¦ key æˆ–ä¸æƒ³è¦ valueï¼Œåˆ™ä½¿ç”¨`_`æ¥ä¸¢å¼ƒå¯¹åº”çš„å€¼ã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨`keys()`æ–¹æ³•å’Œ`values()`æ–¹æ³•åˆ†åˆ«è·å–å­—å…¸çš„ key ç»„æˆçš„åˆ—è¡¨ã€å­—å…¸çš„ value ç»„æˆçš„åˆ—è¡¨ã€‚ä¾‹å¦‚ï¼š

```
{% for key,_ in p.items() %}
{% for _,values in p.items() %}
{% for key in p.keys() %}
{% for value in p.values() %}
```

å°†ä¸Šé¢çš„è§£é‡Šæ•´ç†æˆä¸‹é¢çš„ç¤ºä¾‹ã€‚playbook å†…å®¹å¦‚ä¸‹ï¼š

```yaml
- hosts: localhost
  gather_facts: no
  tasks:
    - template:
        src: a.txt.j2
        dest: /tmp/a.txt
      vars:
        p1:
          name: "junmajinlong"
          age: 18
```

æ¨¡æ¿æ–‡ä»¶ a.txt.j2 å†…å®¹å¦‚ä¸‹ï¼š

```
{% for key,value in p1.items() %}
key: {{key}}, value: {{value}}
{% endfor %}
```

æ‰§è¡Œç»“æœï¼š

```
key: name, value: junmajinlong
key: age, value: 18
```

### for çš„ç‰¹æ®Šæ§åˆ¶å˜é‡

åœ¨ for å¾ªç¯å†…éƒ¨ï¼Œå¯ä»¥ä½¿ç”¨ä¸€äº›ç‰¹æ®Šå˜é‡ï¼Œå¦‚ä¸‹ï¼š

| Variable | Description |
| --- | --- |
| loop | å¾ªç¯æœ¬èº« |
| loop.index | æœ¬è½®è¿­ä»£çš„ç´¢å¼•ä½ï¼Œå³ç¬¬å‡ è½®è¿­ä»£ (ä» 1 å¼€å§‹è®¡æ•°) |
| loop.index0 | æœ¬è½®è¿­ä»£çš„ç´¢å¼•ä½ï¼Œå³ç¬¬å‡ è½®è¿­ä»£ (ä» 0 å¼€å§‹è®¡æ•°) |
| loop.revindex | æœ¬è½®è¿­ä»£çš„é€†å‘ç´¢å¼•ä½ (è·ç¦»æœ€åä¸€ä¸ª item çš„é•¿åº¦ï¼Œä» 1 å¼€å§‹è®¡æ•°) |
| loop.revindex0 | æœ¬è½®è¿­ä»£çš„é€†å‘ç´¢å¼•ä½ (è·ç¦»æœ€åä¸€ä¸ª item çš„é•¿åº¦ï¼Œä» 0 å¼€å§‹è®¡æ•°) |
| loop.first | å¦‚æœæœ¬è½®è¿­ä»£æ˜¯ç¬¬ä¸€è½®ï¼Œåˆ™è¯¥å˜é‡å€¼ä¸º True |
| loop.last | å¦‚æœæœ¬è½®è¿­ä»£æ˜¯æœ€åä¸€è½®ï¼Œåˆ™è¯¥å˜é‡å€¼ä¸º True |
| loop.length | å¾ªç¯è¦è¿­ä»£çš„è½®æ•°ï¼Œå³ item çš„æ•°é‡ |
| loop.previtem | æœ¬è½®è¿­ä»£çš„å‰ä¸€è½®çš„ item å€¼ï¼Œå¦‚æœå½“å‰æ˜¯ç¬¬ä¸€è½®ï¼Œåˆ™è¯¥å˜é‡æœªå®šä¹‰ |
| loop.nextitem | æœ¬è½®è¿­ä»£çš„ä¸‹ä¸€è½®çš„ item å€¼ï¼Œå¦‚æœå½“å‰æ˜¯æœ€åä¸€è½®ï¼Œåˆ™è¯¥å˜é‡æœªå®šä¹‰ |
| loop.depth | åœ¨é€’å½’å¾ªç¯ä¸­ï¼Œè¡¨ç¤ºé€’å½’çš„æ·±åº¦ï¼Œä» 1 å¼€å§‹è®¡æ•° |
| loop.depth0 | åœ¨é€’å½’å¾ªç¯ä¸­ï¼Œè¡¨ç¤ºé€’å½’çš„æ·±åº¦ï¼Œä» 0 å¼€å§‹è®¡æ•° |
| loop.cycle | ä¸€ä¸ªå‡½æ•°ï¼Œå¯æŒ‡å®šåºåˆ—ä½œä¸ºå‚æ•°ï¼Œfor æ¯è¿­ä»£ä¸€æ¬¡ä¾¿åŒæ­¥è¿­ä»£åºåˆ—ä¸­çš„ä¸€ä¸ªå…ƒç´  |
| loop.changed(*val) | å¦‚æœæœ¬è½®è¿­ä»£æ—¶çš„ val å€¼å’Œå‰ä¸€è½®è¿­ä»£æ—¶çš„ val å€¼ä¸åŒï¼Œåˆ™è¿”å› True |


ä¹‹å‰æ›¾ä»‹ç»è¿‡ï¼Œåœ¨ Ansible çš„å¾ªç¯å¼€å¯`extended`åŠŸèƒ½ä¹‹åä¹Ÿèƒ½è·å–ä¸€äº›ç‰¹æ®Šå˜é‡ã€‚ä¸éš¾å‘ç°ï¼ŒAnsible å¾ªç¯å¼€å¯`extended`åå¯è·å–çš„å˜é‡å’Œæ­¤å¤„ Jinja2 æä¾›çš„å¾ªç¯å˜é‡å¤§å¤šæ˜¯ç±»ä¼¼çš„ã€‚æ‰€ä»¥è¿™é‡Œåªä»‹ç»ä¹‹å‰å°šæœªè§£é‡Šè¿‡çš„å‡ ä¸ªå˜é‡ã€‚

é¦–å…ˆæ˜¯`loop.cycle()`ï¼Œå®ƒæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå¯ä»¥ä¼ é€’ä¸€ä¸ªåºåˆ— (æ¯”å¦‚åˆ—è¡¨) ä½œä¸ºå‚æ•°ã€‚åœ¨ for å¾ªç¯è¿­ä»£æ—¶ï¼Œæ¯è¿­ä»£ä¸€ä¸ªå…ƒç´ çš„åŒæ—¶ï¼Œä¹Ÿä¼šä»å‚æ•°æŒ‡å®šçš„åºåˆ—ä¸­è¿­ä»£ä¸€ä¸ªå…ƒç´ ï¼Œå¦‚æœåºåˆ—å…ƒç´ è¿­ä»£å®Œäº†ï¼Œåˆ™ä»å¤´å¼€å§‹ç»§ç»­è¿­ä»£ã€‚

ä¾‹å¦‚ï¼Œplaybook å†…å®¹å¦‚ä¸‹ï¼š

```
- hosts: localhost
  gather_facts: no
  tasks:
    - template:
        src: a.txt.j2
        dest: /tmp/a.txt
      vars:
        p:
          - aaa
          - bbb
          - ccc
```

æ¨¡æ¿æ–‡ä»¶ a.txt.j2 å†…å®¹å¦‚ä¸‹ï¼š

```
{% for i in p %}
item: {{i}}
cycle: {{loop.cycle("AAA","BBB")}}
{% endfor %}
```

æ¸²æŸ“åå¾—åˆ°çš„ / tmp/a.txt æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š

```
item: aaa
cycle: AAA
item: bbb
cycle: BBB
item: ccc
cycle: AAA
```

ç„¶åæ˜¯`loop.changed(val)`ï¼Œè¿™ä¹Ÿæ˜¯ä¸€ä¸ªå‡½æ•°ã€‚å¦‚æœç›¸é‚»çš„ä¸¤è½®è¿­ä»£ä¸­ (å³å½“å‰ä¸€è½®å’Œå‰ä¸€è½®)ï¼Œå‚æ•° val çš„å€¼æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œåˆ™å½“å‰ä¸€è½®çš„`loop.changed()`è¿”å› Falseï¼Œå¦åˆ™è¿”å› Trueã€‚ä¸¾ä¸ªä¾‹å­å¾ˆå®¹æ˜“ç†è§£ï¼š

playbook å†…å®¹å¦‚ä¸‹ï¼š

```yaml
- hosts: localhost
  gather_facts: no
  tasks:
    - template:
        src: a.txt.j2
        dest: /tmp/a.txt
      vars:
        persons:
          - name: "junmajinlong"
            age: 18
          - name: "junmajinlong"
            age: 22
          - name: "wugui"
            age: 23
```

æ¨¡æ¿æ–‡ä»¶ a.txt.j2 å†…å®¹å¦‚ä¸‹ï¼š

```
{% for p in persons %}
{% if loop.changed(p.name) %}
index: {{loop.index}}
{% endif %}
{% endfor %}
```

æ¸²æŸ“åå¾—åˆ°çš„ / tmp/a.txt ç»“æœï¼š

```
index: 1
index: 3
```

æ˜¾ç„¶ï¼Œç¬¬äºŒè½®è¿­ä»£æ—¶çš„ p.name å’Œå‰ä¸€è½®è¿­ä»£æ—¶çš„ p.name å€¼æ˜¯ç›¸åŒçš„ï¼Œæ‰€ä»¥æ¸²æŸ“ç»“æœä¸­æ²¡æœ‰`index: 2`ã€‚
### å¦‚ä½•è·¨ä½œç”¨åŸŸ
é‚£å¦‚ä½•åœ¨ for å¾ªç¯å†…åšä¸€ä¸ªè‡ªå¢æ“ä½œå‘¢ï¼Ÿè¿™åº”è¯¥ä¹Ÿæ˜¯éå¸¸å¸¸è§çš„éœ€æ±‚ã€‚ä½†åªèƒ½è¯´ Jinja2 é‡Œè¿™ä¸æ–¹ä¾¿ï¼Œåªèƒ½é€€è€Œæ±‚å…¶æ¬¡æ‰¾å…¶å®ƒæ–¹å¼ï¼Œè¿™é‡Œæˆ‘æä¾›ä¸¤ç§ï¼š
```
{# ä½¿ç”¨loop.indexï¼Œå®ƒæœ¬èº«å°±æ˜¯è‡ªå¢çš„ #}
{% set mylist = [1,2,3] %}
{% for item in mylist %}
name{{loop.index}}
{% endfor %}

{# ä½¿ç”¨Jinja2 2.10ç‰ˆçš„namespaceï¼Œå®ƒå¯ä»¥è®©å˜é‡è·¨ä½œç”¨åŸŸ #}
{% set num = namespace(value=3) %}
{% set mylist = [1,2,3] %}
{% for item in mylist %}
name{{num.value}}
{% set num.value = num.value + 2 %}
{% endfor %}
```
ä½¿ç”¨ä¸Šé¢ç¬¬äºŒç§æ–¹æ¡ˆæ—¶è¦æ³¨æ„ Jinja2 çš„ç‰ˆæœ¬å·ï¼ŒAnsible æ‰€ä½¿ç”¨çš„ Jinja2 å¾ˆå¯èƒ½æ˜¯ä½äº 2.10 ç‰ˆæœ¬çš„ã€‚

## Macro(å®)
è®¡ç®—æœºç§‘å­¦å½“ä¸­ï¼ŒMacro(å®) è¡¨ç¤ºçš„æ˜¯ä¸€æ®µæŒ‡ä»¤çš„ç®€å†™ï¼Œå®ƒä¼šåœ¨ç‰¹å®šçš„æ—¶å€™æ›¿æ¢æˆå…¶æ‰€ä»£è¡¨çš„ä¸€å¤§æ®µæŒ‡ä»¤ã€‚

å¦‚æœå„ä½ä¹‹å‰ä¸æ›¾çŸ¥é“ Macro çš„æ¦‚å¿µï¼Œæˆ‘è¿™é‡Œç”¨ä¸€ä¸ªä¸ä¸¥è°¨ã€ä¸å±äºåŒä¸€ä¸ªèŒƒç•´ä½†æœ€æ–¹ä¾¿å¤§å®¶ç†è§£çš„ç¤ºä¾‹æ¥è§£é‡Šï¼šShell ä¸­çš„å‘½ä»¤åˆ«åå¯ä»¥çœ‹ä½œæ˜¯ Macroï¼ŒShell ä¼šåœ¨å‘½ä»¤å¼€å§‹æ‰§è¡Œä¹‹å‰ (å³åœ¨ Shell è§£æå‘½ä»¤è¡Œçš„é˜¶æ®µ) å…ˆå°†åˆ«åæ›¿æ¢æˆå…¶åŸæœ¬çš„å€¼ã€‚æ¯”å¦‚å°†`ls`æ›¿æ¢æˆ`rm -rf`ã€‚

Jinja2 æ˜¯æ”¯æŒ Macro æ¦‚å¿µçš„ï¼Œå®ç±»ä¼¼äºå‡½æ•°ï¼Œæ¯”å¦‚å¯ä»¥æ¥å‚æ•°ï¼Œå…·æœ‰ä»£ç å¤ç”¨çš„åŠŸèƒ½ã€‚ä½†å…¶æœ¬è´¨å’Œå‡½æ•°æ˜¯ä¸åŒçš„ï¼ŒMacro æ˜¯æ›¿æ¢æˆåŸä»£ç ç‰‡æ®µï¼Œå‡½æ•°æ˜¯ç›´æ¥å¯»æ‰¾åˆ°åœ°å€è¿›è¡Œè°ƒç”¨ã€‚è¿™å°±ä¸å¤šæ‰¯äº†ï¼Œå¥½åƒç¦»é¢˜æœ‰ç‚¹è¿œï¼Œè¿™å¯ä¸æ˜¯ç¼–ç¨‹æ•™ç¨‹ã€‚æ€»çš„æ¥è¯´ï¼ŒJinja2 çš„ Macro éœ€è¦åƒå‡½æ•°ä¸€æ ·å…ˆå®šä¹‰ï¼Œåœ¨ä½¿ç”¨çš„æ—¶å€™ç›´æ¥è°ƒç”¨å³å¯ï¼Œè‡³äºåº•å±‚ç»†èŠ‚ï¼Œç®¡å®ƒé‚£ä¹ˆå¤šå¹²å˜›ï¼Œåˆä¸ä¼šæ¶¨ä¸€æ¯›é’±å·¥èµ„ã€‚

ä¸¾ä¸€ä¸ªæ¯”è¾ƒå¸¸è§çš„æ¡ˆä¾‹ï¼Œæ¯”å¦‚æŸæœåŠ¡çš„é…ç½®æ–‡ä»¶æŸæŒ‡ä»¤å¯ä»¥æ¥å¤šä¸ªå‚æ•°å€¼ï¼Œæ¯ä¸ªå€¼ä»¥ç©ºæ ¼åˆ†éš”ï¼Œæ¯ä¸ªæŒ‡ä»¤ä»¥åˆ†å·`;`ç»“å°¾ã€‚ä¾‹å¦‚ï¼š`log 'host' 'port' 'date';`ã€‚å¦‚æœç”¨æ¨¡æ¿å»åŠ¨æ€é…ç½®è¿™ä¸ªæŒ‡ä»¤ï¼Œå¯èƒ½ä¼šä½¿ç”¨ for å¾ªç¯è¿­ä»£ï¼Œä½†è¦åŒºåˆ†ç©ºæ ¼åˆ†éš”ç¬¦å’Œå°¾éƒ¨çš„åˆ†å·åˆ†éš”ç¬¦ã€‚äºæ˜¯ï¼Œç¼–å†™å¦‚ä¸‹ Macroï¼š
```
{% macro delimiter(loop) -%}
{{ ' ' if not loop.last else ';' }}
{%- endmacro %}
```
ä¸Šé¢è¡¨ç¤ºå®šä¹‰äº†ä¸€ä¸ªåä¸º delimiter çš„ Macroï¼Œå®ƒèƒ½æ¥ä¸€ä¸ªè¡¨ç¤º for å¾ªç¯çš„å‚æ•°ã€‚

ä¸Šé¢çš„ Macro å®šä¹‰ä¸­è¿˜ä½¿ç”¨äº† -%} å’Œ {%- ï¼Œè¿™æ˜¯ç”¨äºå¤„ç†ç©ºç™½ç¬¦å·çš„ï¼Œç¨åä¼šè§£é‡Šå®ƒçš„ç”¨æ³•ï¼Œç°åœ¨å„ä½åªéœ€å½“è¿™ä¸ªçŸ­æ¨ªçº¿ä¸å­˜åœ¨å³å¯ã€‚

å®šä¹‰å¥½è¿™ä¸ª Macro ä¹‹åï¼Œå°±å¯ä»¥åœ¨ä»»æ„éœ€è¦çš„æ—¶å€™å»â€ è°ƒç”¨â€ å®ƒã€‚ä¾‹å¦‚ï¼š

```
log {% for item in log_args %}
'{{item}}'{{delimiter(loop)}}
{%- endfor %}

gzip {% for item in gzip_args %}
'{{item}}'{{delimiter(loop)}}
{%- endfor %}
```

æä¾›ä¸€ä¸ª playbookï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```yaml
- hosts: localhost
  gather_facts: no
  tasks:
    - template:
        src: a.txt.j2
        dest: /tmp/a.txt
      vars:
        log_args:
          - host
          - port
          - date
        gzip_args: ['css','js','html']
```

æ¸²æŸ“å‡ºæ¥çš„ç»“æœå¦‚ä¸‹ï¼š

```
log 'host' 'port' 'date';
gzip 'css' 'js' 'html';
```

Macro çš„å‚æ•°è¿˜å¯ä»¥æŒ‡å®šé»˜è®¤å€¼ï¼Œâ€ è°ƒç”¨â€Macro å¹¶ä¼ é€’å‚æ•°æ—¶ï¼Œè¿˜å¯ä»¥ç”¨ key=value çš„æ–¹å¼ä¼ é€’ã€‚ä¾‹å¦‚ï¼š

```
{# å®šä¹‰Macroæ—¶ï¼ŒæŒ‡å®šé»˜è®¤å€¼ #}
{% macro delimiter(loop,sep=" ",deli=";") -%}
{{ sep if not loop.last else deli }}
{%- endmacro %}

{# "è°ƒç”¨"Macroæ—¶ï¼Œä½¿ç”¨key=valueä¼ é€’å‚æ•°å€¼ #}
log {% for item in log_args %}
'{{item}}'{{delimiter(loop,sep=",")}}
{%- endfor %}

gzip {% for item in gzip_args %}
'{{item}}'{{delimiter(loop,deli="")}}
{%- endfor %}
```

æ¸²æŸ“å¾—åˆ°çš„ç»“æœï¼š

```
log 'host','port','date';
gzip 'css' 'js' 'html'
```

å…³äº Macroï¼Œè¿˜æœ‰äº›å†…å®¹å¯ä»¥ç»§ç»­æ·±å…¥ (ä¸€äº›å˜é‡å’Œ call è°ƒç”¨çš„æ–¹å¼)ï¼Œä½†åº”è¯¥å¾ˆå°‘å¾ˆå°‘ç”¨åˆ°ï¼Œæ‰€ä»¥æˆ‘è¿™å°±ä¸å†å±•å¼€äº†ï¼Œå¦‚æœå¤§å®¶æœ‰æ„æ„¿ï¼Œå¯ä»¥å»å®˜æ–¹æ‰‹å†Œå­¦ä¹ æˆ–ç½‘ä¸Šæœç´¢ç›¸å…³èµ„æ–™ï¼Œæœ‰ç¼–ç¨‹åŸºç¡€çš„äººåº”è¯¥å¾ˆå®¹æ˜“ç†è§£ï¼Œæ²¡æœ‰ç¼–ç¨‹åŸºç¡€çš„ï¼Œå°±åˆ«å‡‘è¿™ä¸ªçƒ­é—¹äº†ã€‚

## æ¨¡ç‰ˆç»§æ‰¿

### Extends ä¸ Block

æœ‰äº›æœåŠ¡ç¨‹åºçš„é…ç½®æ–‡ä»¶å¯ä»¥ä½¿ç”¨ include æŒ‡ä»¤æ¥åŒ…å«é¢å¤–çš„é…ç½®æ–‡ä»¶ï¼Œè¿™æ ·å¯ä»¥æŒ‰ä¸åŒåŠŸèƒ½æ¥åˆ†ç±»ç®¡ç†é…ç½®æ–‡ä»¶ä¸­çš„é…ç½®é¡¹ã€‚åœ¨è§£æé…ç½®æ–‡ä»¶çš„æ—¶å€™ï¼Œä¼šå°† include æŒ‡ä»¤æ‰€æŒ‡å®šçš„æ–‡ä»¶å†…å®¹åŠ è½½å¹¶åˆå¹¶åˆ°ä¸»é…ç½®æ–‡ä»¶ä¸­ã€‚

Jinja2 çš„ block åŠŸèƒ½æœ‰ç‚¹ç±»ä¼¼äº include æŒ‡ä»¤çš„åŠŸèƒ½ï¼Œblock çš„ç”¨æ³•æ˜¯è¿™æ ·çš„ï¼šå…ˆåœ¨ä¸€ä¸ªç±»ä¼¼äºä¸»é…ç½®æ–‡ä»¶çš„æ–‡ä»¶ä¸­å®šä¹‰ blockï¼Œç§°ä¸º base block æˆ–çˆ¶ blockï¼Œç„¶ååœ¨å…¶å®ƒæ–‡ä»¶ä¸­ç»§æ‰¿ base blockï¼Œç§°ä¸ºå­ blockã€‚åœ¨æ¨¡æ¿è§£æçš„æ—¶å€™ï¼Œä¼šå°†å­ block ä¸­çš„å†…å®¹å¡«å……æˆ–è¦†ç›–åˆ°çˆ¶ block ä¸­ã€‚

ä¾‹å¦‚ï¼Œåœ¨ base.conf.j2 æ–‡ä»¶ä¸­å®šä¹‰å¦‚ä¸‹å†…å®¹ï¼š

```
server {
  listen       80;
  server_name  www.abc.com;

{% block root_page %}
location / {
  root   /usr/share/nginx/html;
  index  index.html index.htm;
}
{% endblock root_page %}

  error_page   500 502 503 504  /50x.html;
{% block err_50x %}{% endblock err_50x %}
{% block php_pages %}{% endblock php_pages %}

}
```

è¿™å…¶å®æ˜¯ä¸€ä¸ª Nginx çš„è™šæ‹Ÿä¸»æœºé…ç½®æ¨¡æ¿æ–‡ä»¶ã€‚åœ¨å…¶ä¸­å®šä¹‰äº†ä¸‰ä¸ª blockï¼š

- (1). åä¸º root_page çš„ blockï¼Œå…¶å†…éƒ¨æœ‰å†…å®¹ï¼Œè¿™ä¸ªå†…å®¹æ˜¯é»˜è®¤å†…å®¹
- (2). åä¸º err_50x çš„ blockï¼Œæ²¡æœ‰å†…å®¹
- (3). åä¸º php_pages çš„ blockï¼Œæ²¡æœ‰å†…å®¹

å¦‚æœå®šä¹‰äº†åŒåå­ blockï¼Œåˆ™ä¼šä½¿ç”¨å­ block æ¥è¦†ç›–çˆ¶ blockï¼Œå¦‚æœæ²¡æœ‰å®šä¹‰åŒåå­ blockï¼Œåˆ™ä¼šé‡‡ç”¨é»˜è®¤å†…å®¹ã€‚

ä¸‹é¢ä¸“é—¨ç”¨äºå®šä¹‰å­ block å†…å®¹çš„ child.conf.j2 æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```
{% extends 'base.conf.j2' %}

{% block err_50x %}
location = /50x.html {
  root   /usr/share/nginx/html;
}
{% endblock err_50x %}

  {% block php_pages %}
  location ~ \.php$ {
    fastcgi_pass   "192.168.200.43:9000";
    fastcgi_index  index.php;
    fastcgi_param  SCRIPT_FILENAME /usr/share/www/php$fastcgi_script_name;
    include        fastcgi_params;
  }
  {% endblock php_pages %}
```

å­ block æ–‡ä»¶ä¸­ç¬¬ä¸€è¡Œéœ€è¦ä½¿ç”¨ jinja2 çš„ `extends` æ ‡ç­¾æ¥æŒ‡å®šçˆ¶ block æ–‡ä»¶ã€‚è¿™ä¸ªå­ block æ–‡ä»¶ä¸­ï¼Œæ²¡æœ‰å®šä¹‰åä¸º`root_page`çš„ blockï¼Œæ‰€ä»¥ä¼šä½¿ç”¨çˆ¶ block æ–‡ä»¶ä¸­åŒå block çš„é»˜è®¤å†…å®¹ï¼Œ`err_50x` å’Œ `php_pages` åˆ™ç›´æ¥è¦†ç›–çˆ¶ blockã€‚

åœ¨ template æ¨¡å—æ¸²æŸ“æ–‡ä»¶æ—¶ï¼Œéœ€è¦æŒ‡å®šå­ block ä½œä¸ºå…¶æºæ–‡ä»¶ã€‚ä¾‹å¦‚ï¼š

```yaml
- hosts: localhost
  gather_facts: no
  tasks:
    - template:
        src: child.conf.j2
        dest: /tmp/nginx.conf
```

æ¸²æŸ“å¾—åˆ°çš„ç»“æœ:

```nginx
server {
  listen       80;
  server_name  www.abc.com;

location / {
  root   /usr/share/nginx/html;
  index  index.html index.htm;
}

  error_page   500 502 503 504  /50x.html;
location = /50x.html {
  root   /usr/share/nginx/html;
}
  location ~ \.php$ {
    fastcgi_pass   "192.168.200.43:9000";
    fastcgi_index  index.php;
    fastcgi_param  SCRIPT_FILENAME /usr/share/www/php$fastcgi_script_name;
    include        fastcgi_params;
  }

}
```

jinja2 çš„ block æ˜¯å¾ˆå‡ºè‰²çš„ä¸€ä¸ªåŠŸèƒ½ï¼Œä½†åœ¨ Ansible ä¸­åº”è¯¥ä¸å¤ªå¯èƒ½ç”¨åˆ° (æˆ–æœºä¼šæå°‘)ï¼Œæ‰€ä»¥å¤šçš„å°±ä¸ä»‹ç»äº†ï¼Œæœ‰å…´è¶£çš„å¯è‡ªè¡Œæ‰¾èµ„æ–™äº†è§£ã€‚

## æ¨¡ç‰ˆå¯¼å…¥

https://jinja.palletsprojects.com/en/3.1.x/templates/#import-context-behavior

### Include

https://jinja.palletsprojects.com/en/latest/templates/#include

include å…³é”®å­—å¯ä»¥è®©æ¨¡ç‰ˆåŒ…å«å¦ä¸€ä¸ªæ¨¡ç‰ˆï¼Œå°±åƒå¾ˆå¤šé…ç½®æ–‡ä»¶ä¸­çš„ include æŒ‡ä»¤ä¸€æ ·(åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­åŒ…å«å…¶ä»–çš„ä¸€ä¸ªæˆ–å¤šä¸ªæ–‡ä»¶)ã€‚

```jinja
{% include 'header.html' %}
Body goes here.
{% include 'footer.html' %}
```

ä¸Šé¢çš„è¯­æ³•ä¼šåœ¨ Body ä¸Šé¢æ¸²æŸ“å‡º header.html æ–‡ä»¶ä¸­çš„å†…å®¹ï¼Œå¹¶åœ¨ Body ä¸‹é¢æ¸²æŸ“å‡º footer.html æ–‡ä»¶ä¸­çš„å†…å®¹ã€‚

è‹¥ Include çš„æ–‡ä»¶ä¸å­˜åœ¨å°†ä¼šæŠ¥é”™ï¼Œå¯ä»¥æ·»åŠ  `ignore missing` ä»¥å¿½ç•¥ä¸å­˜åœ¨çš„æ–‡ä»¶ï¼Œæ¯”å¦‚ `{% include "sidebar.html" ignore missing %}`

è¿˜å¯ä»¥æŒ‡å®šå¤šä¸ª Include çš„æ¨¡ç‰ˆæ–‡ä»¶ `{% include ['page_detailed.html', 'page.html'] %}`

### import

import å…³é”®å­—å¯ä»¥å°†æŸä¸ªæ¨¡ç‰ˆæ–‡ä»¶å¯¼å…¥ä¸ºä¸€ä¸ªå˜é‡ï¼Œç”¨æ³•ä¸ Python ä¸­çš„ import è¯­å¥å¾ˆç±»ä¼¼ã€‚

## å¯¼å…¥ä¸ç»§æ‰¿çš„åŒºåˆ«

ä½ å¥½ï¼Œè¿™æ˜¯Bingã€‚æˆ‘å¯ä»¥ç”¨ä¸­æ–‡å›ç­”ä½ çš„é—®é¢˜ã€‚ğŸ˜Š

jinja2 include å’Œ extends çš„åŒºåˆ«æ˜¯ï¼š

- include æ˜¯å°†å¦ä¸€ä¸ªæ¨¡æ¿æ•´ä¸ªåŠ è½½åˆ°å½“å‰æ¨¡æ¿ä¸­ï¼Œå¹¶ç›´æ¥æ¸²æŸ“ã€‚å®ƒçš„ä½œç”¨æ˜¯å¤ç”¨ä¸€äº›å›ºå®šçš„HTMLä»£ç ï¼Œé¿å…æ¨¡æ¿çœ‹èµ·æ¥æ‹¥æŒ¤ã€‚<sup>1</sup> <sup>5</sup>
- extends æ˜¯è®©å½“å‰æ¨¡æ¿ç»§æ‰¿å¦ä¸€ä¸ªæ¨¡æ¿çš„ç»“æ„å’Œå†…å®¹ï¼Œä½†å¯ä»¥åœ¨ä¸€äº›é¢„ç•™çš„åŒºåŸŸï¼ˆblockï¼‰ä¸­æ·»åŠ æˆ–è¦†ç›–è‡ªå·±çš„å†…å®¹ã€‚å®ƒçš„ä½œç”¨æ˜¯å®ç°æ¨¡æ¿çš„å…¬å…±éƒ¨åˆ†ï¼Œé¿å…é‡å¤çš„ä»£ç ã€‚<sup>1</sup> <sup>2</sup>

ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾æœ‰ä¸€ä¸ªbase.htmlæ¨¡æ¿ï¼Œå®šä¹‰äº†ç½‘é¡µçš„å¤´éƒ¨ã€å¯¼èˆªæ ã€å†…å®¹åŒºåŸŸå’Œå°¾éƒ¨ï¼š

```html
<html>
<head>
    <title>{% block title %}{% endblock %}</title>
</head>
<body>
    <div id="header">
        <h1>My Website</h1>
    </div>
    <div id="nav">
        <ul>
            <li><a href="/">Home</a></li>
            <li><a href="/about">About</a></li>
            <li><a href="/contact">Contact</a></li>
        </ul>
    </div>
    <div id="content">
        {% block content %}
        {% endblock %}
    </div>
    <div id="footer">
        {% include 'footer.html' %}
    </div>
</body>
</html>
```

å¯ä»¥çœ‹åˆ°ï¼Œåœ¨titleå’Œcontentä¸¤ä¸ªåœ°æ–¹ï¼Œä½¿ç”¨äº†blockæ ‡ç­¾æ¥é¢„ç•™åŒºåŸŸï¼Œè®©å­æ¨¡æ¿å¯ä»¥è‡ªå®šä¹‰è¿™äº›éƒ¨åˆ†ã€‚åœ¨footerå¤„ï¼Œä½¿ç”¨äº†includeæ ‡ç­¾æ¥å¯¼å…¥ä¸€ä¸ªfooter.htmlæ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶åŒ…å«äº†ä¸€äº›ç‰ˆæƒä¿¡æ¯ç­‰å›ºå®šå†…å®¹ã€‚

ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªindex.htmlæ¨¡æ¿ï¼Œç»§æ‰¿base.htmlï¼Œå¹¶åœ¨blockä¸­æ·»åŠ è‡ªå·±çš„å†…å®¹ï¼š

```html
{% extends 'base.html' %}

{% block title %}
Index Page
{% endblock %}

{% block content %}
<h2>Welcome to my website!</h2>
<p>This is the index page.</p>
{% endblock %}
```

è¿™æ ·ï¼Œå½“æˆ‘ä»¬æ¸²æŸ“index.htmlæ—¶ï¼Œå®ƒä¼šè‡ªåŠ¨ç»§æ‰¿base.htmlçš„ç»“æ„å’Œå†…å®¹ï¼Œå¹¶æ›¿æ¢æ‰blockä¸­çš„éƒ¨åˆ†ã€‚åŒæ—¶ï¼Œå®ƒä¹Ÿä¼šåŒ…å«footer.htmlçš„å†…å®¹ã€‚

å¦‚æœä½ æƒ³äº†è§£æ›´å¤šå…³äºjinja2 include å’Œ extends çš„ç”¨æ³•å’Œç¤ºä¾‹ï¼Œä½ å¯ä»¥å‚è€ƒä»¥ä¸‹é“¾æ¥ï¼š

<sup>1</sup>: https://blog.csdn.net/pipi_peng/article/details/109274782
<sup>2</sup>: https://deepinout.com/flask/flask-questions/464_flask_jinja2_include_extends_not_working_as_expected.html
<sup>3</sup>: https://blog.csdn.net/tolcf/article/details/46135645
<sup>4</sup>: https://stackoverflow.com/questions/3017623/import-include-assigned-variables-in-jinja2
<sup>5</sup>: https://blog.csdn.net/weixin_44415561/article/details/106591909

å¸Œæœ›è¿™èƒ½å¸®åŠ©ä½ ã€‚å¦‚æœä½ è¿˜æœ‰å…¶ä»–é—®é¢˜ï¼Œè¯·éšæ—¶æé—®ã€‚ğŸ˜Š
\-
\[1]: [ã€Jinja2ã€‘å®ã€ç»§æ‰¿ã€åŒ…å«_jinjia2 include_å°çš®çš®é¹çš„åšå®¢-CSDNåšå®¢](https://blog.csdn.net/pipi_peng/article/details/109274782)
\[2]: [Flask jinja2æ¨¡æ¿ include æ ‡ç­¾_æ¡çŒ«çš„åšå®¢-CSDNåšå®¢](https://blog.csdn.net/weixin_44415561/article/details/106591909)
\[3]: [Flask Jinja2 includeå’Œextendsæ— æ³•æŒ‰é¢„æœŸå·¥ä½œ|æå®¢ç¬”è®°](https://deepinout.com/flask/flask-questions/464_flask_jinja2_include_extends_not_working_as_expected.html)
\[4]: [extendså’ŒimplementsåŒºåˆ«_implementså’Œextendsçš„åŒºåˆ«_æ¼‚æµ®çš„é±¼~çš„åšå®¢-CSDNåšå®¢](https://blog.csdn.net/tolcf/article/details/46135645)
\[5]: [Import / include assigned variables in Jinja2 - Stack Overflow](https://stackoverflow.com/questions/3017623/import-include-assigned-variables-in-jinja2)

# Jinja çš„ç©ºç™½å¤„ç†

é€šå¸¸åœ¨æ¨¡æ¿æ–‡ä»¶ä¸­ï¼Œä¼šå°†æ¨¡æ¿ä»£ç ç‰‡æ®µæŒ‰ç…§ç¼–ç¨‹è¯­è¨€çš„ä»£ç ä¸€æ ·è¿›è¡Œæ¢è¡Œã€ç¼©è¿›ï¼Œä½†å› ä¸ºå®ƒä»¬æ˜¯åµŒå¥—åœ¨æ™®é€šå­—ç¬¦ä¸²ä¸­çš„ï¼Œæ¨¡æ¿å¼•æ“å¹¶ä¸çŸ¥é“é‚£æ˜¯ä¸€ä¸ªæ™®é€šå­—ç¬¦ä¸²ä¸­çš„ç©ºç™½è¿˜æ˜¯ä»£ç æ ¼å¼è§„èŒƒåŒ–çš„ç©ºç™½ï¼Œè€Œæœ‰æ—¶å€™è¿™ä¼šå¸¦æ¥é—®é¢˜ã€‚

æ¯”å¦‚ï¼Œæ¨¡æ¿æ–‡ä»¶ a.txt.j2 æ–‡ä»¶ä¸­çš„å†…å®¹å¦‚ä¸‹ï¼š

```
line start
line left {% if true %}
  <line1>
{% endif %} line right
line end
```

è¿™ä¸ªæ¨¡æ¿æ–‡ä»¶ä¸­çš„ä»£ç éƒ¨åˆ†çœ‹ä¸Šå»éå¸¸è§„èŒƒï¼Œæœ‰æ¢è¡Œæœ‰ç¼©è¿›ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œè¿™æ®µæ¨¡æ¿æ–‡ä»¶æƒ³è¦æ¸²æŸ“å¾—åˆ°çš„æ–‡æœ¬å†…å®¹åº”è¯¥æ˜¯ï¼š

```
line start
line left
<line1>
line right
line end
```

æˆ–è€…æ˜¯ï¼š

```
line start
line left <line1> line right
line end
```

ä½†å®é™…æ¸²æŸ“å¾—åˆ°çš„ç»“æœï¼š

```
line start
line left   <line1>
 line right
line end
```

æ¸²æŸ“çš„ç»“æœä¸­æ ¼å¼å¾ˆä¸è§„èŒƒï¼Œä¸»è¦åŸå› å°±æ˜¯ Jinja2 è¯­å¥å—å‰åä»¥åŠè¯­å¥å—è‡ªèº«çš„æ¢è¡Œç¬¦å¤„ç†ã€ç©ºç™½ç¬¦å·å¤„ç†å¯¼è‡´çš„é—®é¢˜ã€‚

Jinja2 æä¾›äº†ä¸¤ä¸ªé…ç½®é¡¹ï¼š`lstrip_blocks`å’Œ`trim_blocks`ï¼Œå®ƒä»¬çš„æ„ä¹‰åˆ†åˆ«æ˜¯ï¼š

- (1).`lstrip_blocks`ï¼šè®¾ç½®ä¸º true æ—¶ï¼Œä¼šå°† Jinja2 è¯­å¥å—å‰é¢çš„æœ¬è¡Œå‰ç¼€ç©ºç™½ç¬¦å·ç§»é™¤
- (2).`trim_blocks`ï¼šè®¾ç½®ä¸º true æ—¶ï¼ŒJinja2 è¯­å¥å—åçš„æ¢è¡Œç¬¦ä¼šè¢«ç§»é™¤æ‰

å¯¹äº Ansible çš„ template æ¨¡å—ï¼Œ`lstrip_blocks` é»˜è®¤è®¾ç½®ä¸º Falseï¼Œ`trim_blocks` é»˜è®¤è®¾ç½®ä¸º trueã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œtemplate æ¨¡å—ä¼šå°†è¯­å¥å—åé¢çš„æ¢è¡Œç¬¦ç§»é™¤æ‰ï¼Œä½†æ˜¯ä¼šä¿ç•™è¯­å¥å—å‰çš„æœ¬è¡Œå‰ç¼€ç©ºç™½ç¬¦å·ã€‚

ä¾‹å¦‚ï¼Œå¯¹äºä¸‹é¢è¿™æ®µæ¨¡æ¿ç‰‡æ®µï¼š

```
line start
    {% if true %}
  <line1>
{% endif %}
line end
```

`{% if`å‰çš„ 4 ä¸ªç©ºæ ¼ä¼šä¿ç•™ï¼Œ`true %}`åçš„æ¢è¡Œç¬¦ä¼šè¢«ç§»é™¤ï¼Œäºæ˜¯'line1'(æ³¨æ„å‰é¢ä¸¤ä¸ªç©ºæ ¼) æ¸²æŸ“çš„æ—¶å€™ä¼šç§»åˆ°ç¬¬äºŒè¡Œå»ã€‚å†çœ‹`{% endif %}`ï¼Œ`{%`å‰é¢çš„ç©ºç™½ç¬¦å·ä¼šä¿ç•™ï¼Œ`%}`åé¢çš„æ¢è¡Œç¬¦ä¼šè¢«ç§»é™¤ï¼Œæ‰€ä»¥`line end`åœ¨æ¸²æŸ“æ—¶ä¼šç§»åŠ¨åˆ°ç¬¬ä¸‰è¡Œã€‚ç¬¬äºŒè¡Œå’Œç¬¬ä¸‰è¡Œçš„æ¢è¡Œç¬¦æ˜¯ç”±'line1'è¿™è¡Œæä¾›çš„ã€‚

æ‰€ä»¥ç»“æœæ˜¯ï¼š

```
line start
      <line1>
line end
```

ä¸€èˆ¬æ¥è¯´ï¼Œå°†`lstrip_blocks`å’Œ`trim_blocks`éƒ½è®¾ç½®ä¸º trueï¼Œæ¯”è¾ƒç¬¦åˆå¤§å¤šæ•°æƒ…å†µä¸‹çš„ç©ºç™½å¤„ç†éœ€æ±‚ã€‚ä¾‹å¦‚ï¼š

```yaml
- template:
    src: a.txt.j2
    dest: /tmp/a.txt
    lstrip_blocks: true
    trim_blocks: true
```

æ¸²æŸ“å¾—åˆ°çš„ç»“æœï¼š

```
line start
  <line1>
line end
```

æ›´ç¬¦åˆä¸€èˆ¬éœ€æ±‚çš„æ¨¡æ¿æ ¼å¼æ˜¯ï¼Œ**Jinja2 æŒ‡ä»¤éƒ¨åˆ† (æ¯”å¦‚ ifã€endifã€forã€endfor ç­‰) ä¸è¦ä½¿ç”¨ä»»ä½•ç¼©è¿›æ ¼å¼ï¼Œé Jinja2 æŒ‡ä»¤éƒ¨åˆ†æŒ‰éœ€ç¼©è¿›**ã€‚

```
line start
{% if true %}
  <line1>
{% endif %}
line end
```

é™¤äº†`lstrip_blocks`ä»¥åŠ`trim_blocks`å¯ä»¥æ§åˆ¶ç©ºç™½å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨`{%- xxx`å¯ä»¥ç§»é™¤æœ¬è¯­å¥å—å‰çš„æ‰€æœ‰ç©ºç™½ (åŒ…æ‹¬æ¢è¡Œç¬¦)ï¼Œä½¿ç”¨`-%}`å¯ä»¥ç§»é™¤æœ¬è¯­å¥å—åçš„æ‰€æœ‰ç©ºç™½ (åŒ…æ‹¬æ¢è¡Œç¬¦)ã€‚

æ³¨æ„ï¼Œ`xxx_blocks`è¿™ä¸¤ä¸ªé…ç½®é¡¹å’Œå¸¦`-`ç¬¦å·çš„æ•ˆæœæ˜¯ä¸åŒçš„ï¼Œæ€»ç»“ä¸‹ï¼š

- (1).lstrip_blocks åªç§»é™¤è¯­å¥å—å‰ç´§è¿ç€çš„ä¸”æ˜¯æœ¬è¡Œå‰ç¼€çš„ç©ºç™½ç¬¦
- (2).{%- ç§»é™¤è¯­å¥å—å‰æ‰€æœ‰ç©ºç™½
- (3).trip_blocks åªç§»é™¤è¯­å¥å—åç´§è·Ÿç€çš„æ¢è¡Œç¬¦
- (4).-%}`ç§»é™¤è¯­å¥å—åæ‰€æœ‰çš„ç©ºç™½

ä¾‹å¦‚ï¼Œä¸‹é¢ä¸¤ä¸ªæ¨¡æ¿ç‰‡æ®µï¼š

```
line1
line2 {%- if true %}
        line3
        line4
      {%- endif %}
line44
line5
```

åœ¨ä¸¤ä¸ª`xxx_blocks`è®¾ç½®ä¸º true æ—¶ï¼Œæ¸²æŸ“å¾—åˆ°çš„ç»“æœæ˜¯ï¼š

```
line1
line2line3
        line4line44
line5
```

æœ€åæƒ³å‘Šè¯‰å„ä½ï¼Œå¦‚æœæ¸²æŸ“åå¾—åˆ°çš„ç»“æœæ˜¯åˆç†çš„ (æ¯”å¦‚é…ç½®æ–‡ä»¶è¯­æ³•ä¸æŠ¥é”™)ï¼Œå°±ä¸è¦è¿½æ±‚ç²¾ç¡®æ§åˆ¶ç©ºç™½ç¬¦å·ã€‚æ¯”å¦‚åˆ«ä¸ºäº†å°†å¤šä¸ªè¿ç»­çš„ç©ºæ ¼å‹ç¼©æˆçœ‹ä¸Šå»æ›´æ˜¾è§„èŒƒçš„å•ä¸ªç©ºæ ¼è€Œæƒ³æ–¹è®¾æ³•(å¦‚æœä½ æ˜¯å¼ºè¿«ç—‡ï¼Œå°±è¦å°å¿ƒå’¯)ã€‚å¦‚æœä½ è¿˜æ²¡é‡åˆ°è¿‡è¿™ä¸ªé—®é¢˜ï¼Œé‚£ä»¥åä¹Ÿè‚¯å®šä¼šé‡åˆ°çš„ï¼Œå…¶å®åªè¦æ¨¡æ¿ç¨å¾®å†™çš„å¤æ‚ä¸€ç‚¹ï¼Œå°±èƒ½ä½“ä¼šåˆ°ä»€ä¹ˆå«åšâ€ ä¼—å£éš¾è°ƒâ€ã€‚

# Python å¯¹è±¡è‡ªèº«çš„æ–¹æ³•
åœ¨å‰é¢è§£é‡Šè¿‡ï¼Œå½“ä½¿ç”¨`x.y`çš„æ–¹å¼è®¿é—® y çš„æ—¶å€™ï¼Œä¼šå…ˆå¯»æ‰¾ x çš„ y å±æ€§æˆ– y æ–¹æ³•ï¼Œæ‰¾ä¸åˆ°æ‰å¼€å§‹æ‰¾ Jinja2 ä¸­å®šä¹‰çš„å±æ€§ã€‚

æ‰€ä»¥ï¼Œåœ¨ Ansible ä¸­æœ‰äº›æ—¶å€™æ˜¯å¯ä»¥ç›´æ¥ä½¿ç”¨ Python å¯¹è±¡è‡ªèº«æ–¹æ³•çš„ï¼Œæ¯”å¦‚å­—ç¬¦ä¸²å¯¹è±¡å¯ä»¥ä½¿ç”¨`endswith`åˆ¤æ–­å­—ç¬¦ä¸²æ˜¯å¦ä»¥æŸå­—ç¬¦ä¸²ç»“å°¾ã€‚

è¿™ä¹Ÿä¸º Ansible æä¾›äº†éå¸¸æœ‰ç”¨çš„åŠŸèƒ½ã€‚ä½†æ˜¯æœ‰äº›äººå¯èƒ½æ²¡å­¦è¿‡ Pythonï¼Œæ‰€ä»¥ä¹Ÿä¸çŸ¥é“æœ‰å“ªäº›æ–¹æ³•å¯ç”¨ï¼Œä¹Ÿä¸ç†è§£æœ‰äº›ä»£ç æ˜¯ä»€ä¹ˆä½œç”¨ã€‚è¿™ä¸€ç‚¹æˆ‘ä¹Ÿæ²¡æœ‰åŠæ³•å¸®åŠ©å„ä½ï¼Œä½†å¤§å®¶ä¹Ÿä¸ç”¨å¤ªè¿‡åœ¨æ„ï¼Œå‡ ä¸ªæ–¹æ³•è€Œå·²ï¼Œç»†èŠ‚ç½¢äº†ã€‚äº‹å®ä¸Šä¹Ÿå°±å­—ç¬¦ä¸²å¯¹è±¡çš„æ–¹æ³•æ¯”è¾ƒå¤šã€‚

### Python å­—ç¬¦ä¸²å¤„ç†

åœ¨ Jinja2 ä¸­ï¼Œç»å¸¸ä¼šä½¿ç”¨åˆ°å­—ç¬¦ä¸²ã€‚å¦‚ä½•ä½¿ç”¨å­—ç¬¦ä¸²å¯¹è±¡çš„æ–¹æ³•ï¼Ÿ

ä¾‹å¦‚ï¼ŒPython å­—ç¬¦ä¸²å¯¹è±¡æœ‰ä¸€ä¸ª upper æ–¹æ³•ï¼Œå¯ä»¥å°†å­—ç¬¦ä¸²æ”¹å˜ä¸ºå¤§å†™å­—æ¯ï¼Œç›´æ¥ä½¿ç”¨`"abc".upper()`ï¼Œæ³¨æ„ä¸è¦çœç•¥å°æ‹¬å·ï¼Œè¿™ä¸€ç‚¹å’Œ Jinja2 å’Œ Shell å‡½æ•°éƒ½æ˜¯ä¸ä¸€æ ·çš„ã€‚

ä¾‹å¦‚ï¼š

```yaml
- debug:
    msg: '{{ "abc".upper() }}'
- debug:
    msg: "{{ 'foo bar baz'.upper().split() }}"
```

å¾—åˆ°ï¼š

```
TASK [debug] ****************
ok: [localhost] => {
    "msg": "ABC"
}

TASK [debug] *****************
    "msg": ["FOO", "BAR", "BAZ"]
}
```

ä¸‹é¢æ˜¯å­—ç¬¦ä¸²å¯¹è±¡çš„å„ç§æ–¹æ³•ï¼Œæˆ‘ç®€å•è¯´æ˜äº†å®ƒä»¬çš„åŠŸèƒ½ï¼Œå…³äºå®ƒä»¬çš„ç”¨æ³•å’Œç¤ºä¾‹å¯å‚è§æˆ‘çš„åšå®¢ï¼š[https://www.junmajinlong.com/python/string_methods/](https://www.junmajinlong.com/python/string_methods/)ã€‚

```
lowerï¼šå°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºå°å†™å­—æ¯
upperï¼šå°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºå¤§å†™å­—æ¯
titleï¼šå°†å­—ç¬¦ä¸²æ‰€æœ‰å•è¯é¦–å­—æ¯å¤§å†™ï¼Œå…¶å®ƒå­—æ¯å°å†™
capitalizeï¼šå°†å­—ç¬¦ä¸²é¦–å•è¯é¦–å­—æ¯å¤§å†™ï¼Œå…¶å®ƒå­—æ¯å°å†™
swapcaseï¼šå°†å­—ç¬¦ä¸²ä¸­æ‰€æœ‰å­—æ¯å¤§å°å†™äº’æ¢
isalphaï¼šåˆ¤æ–­å­—ç¬¦ä¸²ä¸­æ‰€æœ‰å­—ç¬¦æ˜¯å¦æ˜¯å­—æ¯
isdecimalï¼šåˆ¤æ–­å­—ç¬¦ä¸²ä¸­æ‰€æœ‰å­—ç¬¦æ˜¯å¦æ˜¯æ•°å­—
isdigitï¼šåˆ¤æ–­å­—ç¬¦ä¸²ä¸­æ‰€æœ‰å­—ç¬¦æ˜¯å¦æ˜¯æ•°å­—
isnumericï¼šåˆ¤æ–­å­—ç¬¦ä¸²ä¸­æ‰€æœ‰å­—ç¬¦æ˜¯å¦æ˜¯æ•°å­—
isalnumï¼šåˆ¤æ–­å­—ç¬¦ä¸²ä¸­æ‰€æœ‰å­—ç¬¦æ˜¯å¦æ˜¯å­—æ¯æˆ–æ•°å­—
islowerï¼šåˆ¤æ–­å­—ç¬¦ä¸²ä¸­æ‰€æœ‰å­—ç¬¦æ˜¯å¦æ˜¯å°å†™å­—æ¯
isupperï¼šåˆ¤æ–­å­—ç¬¦ä¸²ä¸­æ‰€æœ‰å­—ç¬¦æ˜¯å¦æ˜¯å¤§å†™å­—æ¯
istitleï¼šåˆ¤æ–­å­—ç¬¦ä¸²ä¸­æ˜¯å¦æ‰€æœ‰å•è¯é¦–å­—ç¬¦å¤§å†™ï¼Œå…¶å®ƒå°å†™
isspaceï¼šåˆ¤æ–­å­—ç¬¦ä¸²ä¸­æ‰€æœ‰å­—ç¬¦æ˜¯å¦æ˜¯ç©ºç™½å­—ç¬¦(ç©ºæ ¼ã€åˆ¶è¡¨ç¬¦ã€æ¢è¡Œç¬¦ç­‰)
isprintableï¼šåˆ¤æ–­å­—ç¬¦ä¸²ä¸­æ‰€æœ‰å­—ç¬¦æ˜¯å¦æ˜¯å¯æ‰“å°å­—ç¬¦(å¦‚åˆ¶è¡¨ç¬¦ã€æ¢è¡Œç¬¦ä¸æ˜¯å¯æ‰“å°å­—ç¬¦)
isidentifierï¼šåˆ¤æ–­å­—ç¬¦ä¸²ä¸­æ˜¯å¦ç¬¦åˆæ ‡è¯†ç¬¦å®šä¹‰è§„åˆ™(å³åªåŒ…å«å­—æ¯ã€æ•°å­—æˆ–ä¸‹åˆ’çº¿ï¼Œä¸”å­—æ¯æˆ–ä¸‹åˆ’çº¿å¼€å¤´)
centerï¼šåœ¨å·¦å³ä¸¤è¾¹å¡«å……å­—ç¬¦ä¸²åˆ°æŒ‡å®šé•¿åº¦ï¼Œå­—ç¬¦ä¸²å±…ä¸­
ljustï¼šåœ¨å³è¾¹å¡«å……å­—ç¬¦ä¸²åˆ°æŒ‡å®šé•¿åº¦
rjustï¼šåœ¨å·¦è¾¹å¡«å……å­—ç¬¦ä¸²åˆ°æŒ‡å®šé•¿åº¦
zfillï¼šä½¿ç”¨0å¡«å……åœ¨å­—ç¬¦ä¸²å·¦è¾¹
countï¼šè®¡ç®—å­—ç¬¦ä¸²ä¸­æŸå­—ç¬¦æˆ–æŸå­ä¸²å‡ºç°çš„æ¬¡æ•°
endswithï¼šå­—ç¬¦ä¸²æ˜¯å¦ä»¥æŸå­—ç¬¦æˆ–æŸå­ä¸²ç»“å°¾
startswithï¼šå­—ç¬¦ä¸²æ˜¯å¦ä»¥æŸå­—ç¬¦æˆ–æŸå­ä¸²å¼€å¤´
findï¼šä»å·¦å‘å³æ£€æŸ¥å­—ç¬¦ä¸²ä¸­æ˜¯å¦åŒ…å«æŸå­ä¸²ï¼Œæœç´¢ä¸åˆ°æ—¶è¿”å›-1
rfindï¼šä»å³å‘å·¦æ£€æŸ¥å­—ç¬¦ä¸²ä¸­æ˜¯å¦åŒ…å«æŸå­ä¸²ï¼Œæœç´¢ä¸åˆ°æ—¶è¿”å›-1
indexï¼šåŠŸèƒ½ç±»ä¼¼äºfindï¼Œæœç´¢ä¸åˆ°æ—¶æŠ¥é”™
rindexï¼šåŠŸèƒ½ç±»ä¼¼äºrfindï¼Œæœç´¢ä¸åˆ°æ—¶æŠ¥é”™
replaceï¼šæ›¿æ¢å­—ç¬¦ä¸²
expandtabsï¼šå°†å­—ç¬¦ä¸²ä¸­çš„åˆ¶è¡¨ç¬¦\tæ›¿æ¢æˆç©ºæ ¼ï¼Œé»˜è®¤æ›¿æ¢ä¸º8ç©ºæ ¼
splitï¼šå°†å­—ç¬¦ä¸²åˆ†å‰²å¾—åˆ°åˆ—è¡¨
rsplitï¼šä»å³å‘å·¦åˆ†å‰²å­—ç¬¦ä¸²å¾—åˆ°åˆ—è¡¨
splitlinesï¼šæŒ‰è¡Œåˆ†å‰²å­—ç¬¦ä¸²ï¼Œæ¯è¡Œä½œä¸ºåˆ—è¡¨çš„ä¸€ä¸ªå…ƒç´ 
joinï¼šå°†åˆ—è¡¨å„å…ƒç´ ä½¿ç”¨æŒ‡å®šç¬¦å·è¿æ¥èµ·æ¥ï¼Œä¾‹å¦‚`"-".[1,2,3]`å¾—åˆ°`1-2-3`
stripï¼šç§»é™¤å­—ç¬¦ä¸²å‰ç¼€å’Œåç¼€æŒ‡å®šå­—ç¬¦ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šç§»é™¤çš„å­—ç¬¦ï¼Œåˆ™é»˜è®¤ç§»é™¤ç©ºç™½
lstripï¼šç§»é™¤å­—ç¬¦ä¸²æŒ‡å®šçš„å‰ç¼€å­—ç¬¦ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šç§»é™¤çš„å­—ç¬¦ï¼Œåˆ™é»˜è®¤ç§»é™¤ç©ºç™½
rstripï¼šç§»é™¤å­—ç¬¦ä¸²æŒ‡å®šçš„åç¼€å­—ç¬¦ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šç§»é™¤çš„å­—ç¬¦ï¼Œåˆ™é»˜è®¤ç§»é™¤ç©ºç™½
formatï¼šæ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œæ­¤å¤–è¿˜å¯ä½¿ç”¨Pythonçš„`%`æ ¼å¼åŒ–æ–¹å¼ï¼Œå¦‚{{ '%.2f' % 1.2345 }}
```

### list å¯¹è±¡æ–¹æ³•

è™½ç„¶ Python ä¸­ list å¯¹è±¡æœ‰å¾ˆå¤šæ“ä½œæ–¹å¼ï¼Œä½†åº”ç”¨åˆ° Ansible ä¸­ï¼Œå¤§æ¦‚ä¹Ÿå°±ä¸¤ä¸ªä¸ªæ–¹æ³•å€¼å¾—äº†è§£ï¼š

- `count()`ï¼š(æ— å‚æ•°) è®¡ç®—åˆ—è¡¨ä¸­å…ƒç´ çš„ä¸ªæ•°æˆ–ç»™å®šå‚æ•°åœ¨åˆ—è¡¨ä¸­å‡ºç°çš„æ¬¡æ•°
- `index()`ï¼šæ£€ç´¢ç»™å®šå‚æ•°åœ¨åˆ—è¡¨ä¸­çš„ä½ç½®ï¼Œå¦‚æœå…ƒç´ ä¸å­˜åœ¨ï¼Œåˆ™æŠ¥é”™

ä¾‹å¦‚ï¼š

```yaml
- debug:
    msg: '{{ [1,2,1,1,3,4].count() }}'
- debug:
    msg: '{{ [1,2,1,1,3,4].count(1) }}'
- debug:
    msg: '{{ [1,2,1,1,3,4].index(2) }}'
```
