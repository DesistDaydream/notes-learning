---
title: æœ€ä½³å®è·µ
---

# åˆ›å»ºä¸€ä¸ªè¶…çº§æƒé™

- åˆ›å»ºä¸€ä¸ª ServiceAccount
  - kubectl create serviceaccount -n user-sa-manage test-admin
- å°†è¯¥ ServiceAccount ç»‘å®šåˆ° cluster-admin è¿™ä¸ª clusterroleï¼Œä»¥èµ‹äºˆæœ€é«˜æƒé™
  - kubectl create clusterrolebinding test-admin --clusterrole=cluster-admin --serviceaccount=user-sa-manage:test-admin
- æ­¤æ—¶ï¼Œsa è´¦æˆ·å°±å…·æœ‰è¶…çº§æƒé™äº†ï¼Œå¯ä»¥é€šè¿‡è¯¥ sa çš„ token ç»™åº”ç”¨ç¨‹åºä½¿ç”¨ï¼Œä»¥ä¾¿å¯ä»¥æœ€å¤§åŒ–æ“ä½œé›†ç¾¤
- è·å– TOKEN
  - kubectl get secrets -n user-sa-manage -o jsonpath="{.items\[?(@.metadata.annotations\['kubernetes.io/service-account.name']=='test-admin')].data.token}"|base64 -d

# ä½¿ç”¨ Service Account çš„ Token åˆ›å»ºéç®¡ç†å‘˜ç”¨æˆ·

å¦‚æœæƒ³è¦ä½¿ç”¨ Token å¯¹é›†ç¾¤è¿›è¡Œæ“ä½œï¼Œå…¶å®ï¼Œå¹¶ä¸ä¸€å®šè¦åˆ›å»ºä¸€ä¸ª KubeConfig æ–‡ä»¶ï¼Œåœ¨é€šè¿‡ Kubernetes API è·å–é›†ç¾¤ä¿¡æ¯æ—¶ï¼Œç›´æ¥ä½¿ç”¨ Token è®¤è¯çš„æ–¹å¼å³å¯ï¼Œæ¯”å¦‚ï¼š

- kubernetes-dashboard çš„ web ç™»å½•å¯ä»¥ä½¿ç”¨ Token
- é€šè¿‡ REST è®¿é—® API å¯ä»¥ä¼ é€’ `Authorization: Bearer ${TOKEN}` è¯·æ±‚å¤´æ—¶ä½¿ç”¨ Tokenã€‚

## åˆ›å»º SAï¼Œå¹¶ä¸º SA æˆæƒ

åˆ›å»ºä¸€ä¸ªåç§°ç©ºé—´ï¼Œä¸“é—¨ç”¨æ¥å­˜æ”¾ SAã€‚ç„¶ååˆ›å»ºä¸€ä¸ªåä¸º lch çš„ SAã€‚

```bash
kubectl create namespace user-sa-manage
kubectl create serviceaccount lch -n user-sa-manage
```

**ä¸º SA æˆäºˆæƒé™**
åœ¨ test åç§°ç©ºé—´åˆ›å»º rolebindingï¼Œå°† SA ä¸ cluster-admin è¿™ä¸ª ClusterRole ç»‘å®šï¼Œè®© lch-sa å¯ä»¥å¯¹ test åç§°ç©ºé—´ä¸‹æ‰€æœ‰ç»„ä¸‹çš„æ‰€æœ‰èµ„æºè¿›è¡Œä»»ä½•æ“ä½œã€‚

> ä¹Ÿå¯ä»¥ä½¿ç”¨å…¶ä»– Role æˆ– ClusterRoleï¼Œæˆ–è€…è‡ªå·±åˆ›å»ºå„ç§è§’è‰²ã€‚

(å¯é€‰)è®© lch è¿™ä¸ª SA ä¸ view è¿™ä¸ª ClusterRole ç»‘å®šï¼Œä»¥ä¾¿å¯ä»¥æŸ¥çœ‹é›†ç¾¤å†…æ‰€æœ‰èµ„æºã€‚å¦‚æœä¸æ·»åŠ è¿™ä¸ªæƒé™ï¼Œlch ç”¨æˆ·æ‰§è¡Œ kubectl get ns å‘½ä»¤æ˜¯æ²¡æœ‰æƒé™çš„ã€‚

```bash
kubectl create rolebinding lch-sa-admin -n test --clusterrole=cluster-admin --serviceaccount=user-sa-manage:lch
kubectl create clusterrolebinding lch-sa --clusterrole=view --serviceaccount=user-sa-manage:lch
```

**(å¯é€‰)**ä¸º SA ç»‘å®šè¶…çº§æƒé™
å½“ç»‘å®šäº† cluster-admin è¿™ä¸ª clusterrole ä¹‹åï¼Œä¸Šé¢çš„é‚£äº›æƒé™æ“ä½œä¹Ÿå°±æ²¡ç”¨äº†ï¼Œlch å°†ä¼šæ‹¥æœ‰å¯¹é›†ç¾¤æ“ä½œçš„æœ€é«˜æƒé™

```bash
kubectl create clusterrolebinding lch-sa-admin --clusterrole=cluster-admin --serviceaccount=user-sa-manage:lch
```

### è·å– SA çš„ Token

è·å–åä¸º lch è¿™ä¸ª SA çš„ Token

```bash
LCH_SA_TOKEN=$(kubectl get secrets -n user-sa-manage -o jsonpath="{.items[?(@.metadata.annotations['kubernetes\.io/service-account\.name']=='lch')].data.token}" | base64 -d)
```

## ä½¿ç”¨ SA çš„ Token åˆ›å»º KubeConfig æ–‡ä»¶

### åˆ›å»ºä¸€ä¸ª KubeConfig æ–‡ä»¶ï¼Œå¹¶è®¾ç½®é›†ç¾¤ä¿¡æ¯ã€‚

- **(å¯é€‰)**ä½¿ç”¨é›†ç¾¤ ca è¯ä¹¦ã€‚
  - åƒ kubernetes-dashboard è¿™ç§é›†ç¾¤å†…çš„åº”ç”¨ï¼Œå¯ä»¥ä¸è®¾ç½®é›†ç¾¤çš„è¯ä¹¦ï¼Œå› ä¸º Pod çš„ /run/secrets/kubernetes.io/serivceaccount ç›®å½•ä¸­é»˜è®¤åŒ…å« ca.crtã€‚

```bash
kubectl config set-cluster kubernetes \
  --certificate-authority=/etc/kubernetes/pki/ca.crt \
  --embed-certs=true \
  --server=https://172.19.42.234:6443 \
  --kubeconfig=./lch-sa.conf
```

- ä¸ä½¿ç”¨é›†ç¾¤ ca è¯ä¹¦
  - åœ¨ [CA](âœIT å­¦ä¹ ç¬”è®°/ğŸ”7.ä¿¡æ¯å®‰å…¨/Cryptography(å¯†ç å­¦)/å…¬å¼€å¯†é’¥åŠ å¯†/è¯ä¹¦%20 ä¸%20PKI.md ä¸ PKI.md) çš„æè¿°ä¸­ï¼Œä»»ä½•äººéƒ½æ˜¯å¯ä»¥è·å–åˆ° CA çš„ï¼ŒCA ä¸»è¦æ˜¯ç”¨æ¥éªŒè¯çš„ï¼Œå¹¶ä¸æ˜¯ç‰¹åˆ«éœ€è¦éšè—ï¼Œä¸€å®šä¸è¦è®©åˆ«äººä½¿ç”¨é›†ç¾¤ CA è¯ä¹¦çš„åœºæ™¯æš‚æ—¶æ²¡æƒ³åˆ°~~å›§ã€‚æ¯•ç«Ÿæ²¡æœ‰ CA çš„ç§é’¥ï¼Œä¹Ÿæ²¡æ³•ç­¾å‘æ–°çš„è¯ä¹¦~~~

```bash
kubectl config set-cluster kubernetes \
  --insecure-skip-tls-verify=true \
  --server=https://172.19.42.234:6443 \
  --kubeconfig=./lch-sa.conf
```

### å»ºç«‹ç”¨æˆ·çš„å‡­è¯ä¿¡æ¯

åœ¨è¯¥æ–‡ä»¶ä¸­ä½¿ç”¨ dashboard çš„ token å»ºç«‹ç”¨æˆ·çš„å‡­è¯ä¿¡æ¯ï¼Œå¹¶è‡ªåŠ¨å»ºç«‹ä¸€ä¸ªåä¸º dashboard-admin çš„ç”¨æˆ·

```bash
kubectl config set-credentials lch \
  --token=$LCH_SA_TOKEN \
  --kubeconfig=./lch-sa.conf
```

åœ¨è¯¥æ–‡ä»¶ä¸­åˆ›å»º user ä¸ cluster çš„å…³ç³»çš„ context

```bash
kubectl config set-context lch@kubernetes \
  --cluster=kubernetes \
  --user=lch \
  --kubeconfig=./lch-sa.conf
```

è®¾å®šå½“å‰çš„ context

```bash
kubectl config use-context lch@kubernetes \
--kubeconfig=./lch-sa.conf
```

## æ€»ç»“

è¿™ä¸ªæ“ä½œç”Ÿæˆçš„ KubeConfig å’Œ å…¶ä¸­ç”Ÿæˆçš„ Token å¯ä»¥ç”¨æ¥ç™»å½• kubernetes-dashboard
æ³¨æ„ï¼šDashboard åœ¨è¯»å– kubeconfig æ–‡ä»¶æ—¶ï¼Œåªä¼šè¯»å– token ä½œä¸ºè®¤è¯

ä½¿ç”¨ SA çš„ TOKEN åˆ›å»ºçš„ä¸ä½¿ç”¨ CA çš„ KubeConfig æ–‡ä»¶ä¹Ÿå¯ä»¥ç”¨äºè®¿é—®åœ¨ Nginx å K8S é›†ç¾¤ã€‚

# ä½¿ç”¨ User Account çš„è¯ä¹¦åˆ›å»ºéç®¡ç†ç”¨æˆ·

Kubernetes ä¸­çš„ç³»ç»Ÿç»„ä»¶ etcdã€kube-controller-manager ç­‰ç­‰éƒ½æ˜¯é€šè¿‡è¯ä¹¦

## åˆ›å»º UA æ‰€éœ€è¯ä¹¦ï¼Œå¹¶ä¸º UA æˆæƒ

> æ³¨æ„ï¼šéœ€è¦åœ¨å…·æœ‰é›†ç¾¤çš„ ca è¯ä¹¦çš„èŠ‚ç‚¹ä¸Šæ“ä½œ

```bash
(umask 077;openssl genrsa -out lch.key 2048)
openssl req -new -key lch.key -out lch.csr -subj "/CN=lch"
openssl x509 -req \
  -CA /etc/kubernetes/pki/ca.crt \
  -CAkey /etc/kubernetes/pki/ca.key \
  -CAcreateserial \
  -in lch.csr -out lch.crt -days 3650
```

**ä¸º UA æˆäºˆæƒé™**
åˆ›å»º Role ä»¥åŠ Rolebinding ï¼Œè®© lch å¯ä»¥å¯¹ test åç§°ç©ºé—´ä¸‹æ‰€æœ‰ç»„ä¸‹çš„æ‰€æœ‰èµ„æºè¿›è¡Œä»»ä½•æ“ä½œã€‚
å¹¶ä¸”è®© lch è¿™ä¸ª UA ä¸ view è¿™ä¸ª ClusterRole ç»‘å®šï¼Œä»¥ä¾¿å¯ä»¥æŸ¥çœ‹é›†ç¾¤å†…æ‰€æœ‰èµ„æºã€‚å¦‚æœä¸æ·»åŠ è¿™ä¸ªæƒé™ï¼Œlch ç”¨æˆ·æ‰§è¡Œ kubectl get ns å‘½ä»¤æ˜¯æ²¡æœ‰æƒé™çš„ã€‚

```bash
# å¯ä»¥è‡ªå·±åˆ›å»º role å¹¶ç»‘å®š
kubectl create role lch-ua -n test --verb=* --resource=*.*
kubectl create rolebinding lch-ua -n test --role=lch-ua --user=lch

# ä¹Ÿå¯ä»¥ç›´æ¥ä¸º SA ç»‘å®šé»˜è®¤çš„ clusterroleï¼Œä½¿ç”¨é»˜è®¤çš„æ›´æ–¹ä¾¿ä¸€äº›~
kubectl create clusterrolebinding lch-ua --clusterrole=view --user=lch
```

## ä½¿ç”¨ UA è¯ä¹¦åˆ›å»º KubeConfig æ–‡ä»¶

åˆ›å»ºä¸€ä¸ªæ–°çš„ KubeConfig æ–‡ä»¶ï¼Œå¹¶è®¾ç½®é›†ç¾¤ä¿¡æ¯

```bash
kubectl config set-cluster kubernetes \
  --certificate-authority=/etc/kubernetes/pki/ca.crt \
  --embed-certs=true \
  --server=https://172.19.42.234:6443 \
  --kubeconfig=./lch-ua.conf
```

ä½¿ç”¨ lch çš„è¯ä¹¦åœ¨ KubeConfig æ–‡ä»¶åˆ›å»ºåä¸º lch çš„ç”¨æˆ·ã€‚

```bash
kubectl config set-credentials lch \
  --client-certificate=./lch.crt \
  --client-key=./lch.key \
  --embed-certs \
  --kubeconfig=./lch-ua.conf
```

ç»‘å®š lch ç”¨æˆ· ä¸ é›†ç¾¤

```bash
kubectl config set-context lch@kubernetes \
  --cluster=kubernetes \
  --user=lch \
  --kubeconfig=./lch-ua.conf
```

åˆ‡æ¢è¯¥ KubeConfig æ–‡ä»¶çš„å½“å‰ç¯å¢ƒ

```bash
kubectl config use-context lch@kubernetes \
  --kubeconfig=./lch-ua.conf
```

## æ€»ç»“

ç„¶åå°†å½“å‰ç›®å½•çš„ lch-config æ–‡ä»¶äº¤ç»™è¯¥ç”¨æˆ·ï¼Œè¿™ä¸ªç”¨æˆ·å°†åªå¯ä»¥åœ¨ lch è¿™ä¸ª namespace ä¸‹çš„æ‰€æœ‰èµ„æºè¿›è¡Œä»»ä½•æ“ä½œ

# ç¤ºä¾‹æ€»ç»“

ä»ä¸Šé¢çš„ç¤ºä¾‹å¯ä»¥çœ‹å‡ºæ¥ï¼Œåä¸º lch çš„ UA ä¸ SAï¼Œå…¶å®å¯ä»¥è¢«ç»Ÿä¸€æŠ½è±¡ä¸ºä¸€ä¸ªç”¨æˆ·ï¼Œè¿™ä¸ªç”¨æˆ·çš„åç§°å°±æ˜¯ lchã€‚åªä¸è¿‡ï¼Œä¸¤ç§ç”¨æˆ·çš„è®¤è¯æ–¹å¼ä¸ä¸€æ ·ç½¢äº†ï¼Œä¸€ä¸ªæ˜¯è¯ä¹¦ï¼Œä¸€ä¸ª Tokenï¼Œå…¶å®å°±ç›¸å½“äºæ˜¯æŠŠ è¯ä¹¦ å’Œ Token æŠ½è±¡ä¸ºå¯†ç ã€‚
