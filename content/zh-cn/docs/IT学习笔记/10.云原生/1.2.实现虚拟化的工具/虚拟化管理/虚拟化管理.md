---
title: 虚拟化管理
---

# 概述

## 创建虚拟机后常见操作

根据[虚拟化调试和优化指南](docs/IT学习笔记/10.云原生/1.2.实现虚拟化的工具/虚拟化管理/虚拟化调试和优化指南.md)调优，`virsh edit XXX` 修改文件

使用 `systemctl enable serial-getty@ttyS0.service --now` 启动 serial-getty 服务，以便通过 `virsh console` 命令连接虚拟机

压缩 qcow2 文件，创建 backing file 的 qcow2 和 xml 文件当做模板以便批量创建虚拟机所用
- `qemu-img convert -c -O qcow2 test.qcow2 test.qcow2.new`

# 扩大 KVM 虚拟机 image 镜像

直接使用 qemu-img resize 的时候一定要先备份镜像。先使用 virsh shutdown VM 关闭镜像再进行如下操作：

- 给原始系统文件添加磁盘空间
  - qemu-img resize centos7-baseImage-50G.qcow2 +500G
- 进入虚拟机操作新建硬盘分区
  - parted /dev/vda mkpart primary XXX 100%(XX 改为指定的最后一块扇区的容量)
- 扩容 LVM，注意/dev/vda4 设备为真实情况的设备名称，注意修改
  - partprobe(可能还需要重启)
  - pvcreate /dev/vda4
  - vgextend vg0 /dev/vda4
  - lvextend -l+100%FREE /dev/mapper/vg0-root
    - 这里可以使用 lvextend -l +单元数量 /dev/mapper/vg0-lv101
- 扩展文件系统大小，注意/dev/mapper/vg0-root 修改为真实情况的分区路径
  - xfs_growfs /dev/mapper/vg0-root
  - 或者普通文件系统使用下面的命令
  - resize2fs /dev/mapper/vg0-root (-f 强制扩展)

# 通过 veth 设备查找对应的虚拟机

通过 xml 文件查看虚拟机的 mac 地址

```bash
~]# grep "mac addr" lchTest.xml
<mac address='52:54:00:6a:86:89'/>
```

筛选网络设备 mac

```bash
~]# ip a | grep "86:89" -B 1
127: vnet1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast master br1 state UNKNOWN group default qlen 1000
    link/ether fe:54:00:6a:86:89 brd ff:ff:ff:ff:ff:ff
```

由此可见，vnet 设备的 mac 与虚拟机的 mac 在后面几位是永远保持一致的，所以可以通过 vnet 设备的 mac ，从所有虚拟机中的 xml 进行筛选就行可以找到 vnet 设备对应的虚拟机了。

## 应用实例

比如我现在能看到 4 个 vnet 设备。

```bash
~]# ip a
.....
62: vnet3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast master br1 state UNKNOWN group default qlen 1000
    link/ether fe:54:00:5c:11:85 brd ff:ff:ff:ff:ff:ff
    inet6 fe80::fc54:ff:fe5c:1185/64 scope link
       valid_lft forever preferred_lft forever
79: vnet0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc mq master br1 state UNKNOWN group default qlen 1000
    link/ether fe:54:00:68:20:51 brd ff:ff:ff:ff:ff:ff
    inet6 fe80::fc54:ff:fe68:2051/64 scope link
       valid_lft forever preferred_lft forever
127: vnet1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast master br1 state UNKNOWN group default qlen 1000
    link/ether fe:54:00:6a:86:89 brd ff:ff:ff:ff:ff:ff
    inet6 fe80::fc54:ff:fe6a:8689/64 scope link
       valid_lft forever preferred_lft forever
139: vnet2: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast master br1 state UNKNOWN group default qlen 1000
    link/ether fe:54:00:3a:95:ef brd ff:ff:ff:ff:ff:ff
    inet6 fe80::fc54:ff:fe3a:95ef/64 scope link
       valid_lft forever preferred_lft forever
```

我想看看 vnet3 是关联到哪个虚拟机上了，就可以进行如下操作：(首先看到 vnet3 的 mac 为 fe:54:00:5c:11:85)

```bash
~]# grep -r "5c:11:85" /etc/libvirt/qemu/*
/etc/libvirt/qemu/cobbler.test.tjiptv.net.xml:      <mac address='52:54:00:5c:11:85'/>
```

这时候可以看到，是 cobbler.test.tjiptv.net.xml 这台虚拟机在使用 vnet3 。
