---
title: 最佳实践
---

# 概述

> 参考：
> - <https://notes.wadeism.net/post/kvm-create-vm-clone-by-overlay/>

**注意：本最佳实践仅适用于独立使用 qemu-img、qemu-kvm 等 KVM/QEMU 的命令行工具，不包括 libvirtd 的工具**

# 应用实例

## 准备工作

创建 bridge 网络设备，并配置 ip，然后将宿主机的外部网卡关联的网络设备加入到 bridge 上。

```bash
ip link add br0 type bridge
ip addr add 172.19.42.249/24 dev br0
ip link set dev eth0 master br0
```

## 准备连接虚拟机的工具

1. 使用 vnc 客户端工具([vnc-viewer](https://www.realvnc.com/) 等...) 连接并安装系统即可。

2. 我们也可以通过各种终端(XShell 等)的 X11 转发连接。在宿主机系统中安装 tigervnc 后，在系统下执行如下命令即可。

```bash
vncview :3
```

## 启动虚拟机并安装系统

创建一个 qcow2 格式的镜像文件，用作块设备

```bash
qemu-img create -f qcow2 qemu-install-test.qcow2 10G
```

使用 `qemu-install-test.qcow2` 文件启动虚拟机，并挂载系统镜像。

> 注意
>
> - 如果不分配内存，会提示无法加载 VFS 导致无法启动微型系统来安装系统。默认模拟 1 个 CPU。
> - `:3` 为 vncview 的访问时的端口，3 默认为 5903

```bash
qemu-system-x86_64 qemu-install-test.qcow2 \
-m 4096 \
-cdrom ./CentOS-7-x86_64-DVD-2009.iso \
-vnc 0.0.0.0:3
```

### 连接虚拟机

### 完成安装

安装完成后，不用指定 cdrom 即可启动虚拟机

```bash
qemu-system-x86_64 qemu-install-test.qcow2 -m 4096 -vnc 0.0.0.0:3
```

## 启动一个正常可用的虚拟机

### 生成脚本

生成 -netdev 选项所用的启动脚本

```bash
cat > /etc/qemu-ifup <<\EOF
#!/bin/bash
BRIDGE=br0
if [ -n $1 ]; then
  ip link set dev $1 master ${BRIDGE}
  ip link set dev $1 up
[ $? -eq 0 ] && exit 0 || exit 1
else
  echo "Error: no interface specified."
exit 1
fi
EOF
chmod 755 /etc/qemu-ifup

```

### 启动虚拟机

```bash
qemu-system-x86_64 -m 4096 -smp 2 -name test \
-drive file=/var/lib/libvirt/images/qemu-install-test.qcow2,format=qcow2,if=virtio \
-netdev tap,id=n1 \
-device virtio-net,netdev=n1 \
-vnc :3
```

### 连接虚拟机


### 结语

现在是使用 qemu-system-x86_64 工具自动创建的 tap 设备，若是使用已经已经存在的网络设备，那么还需要创建一个 downscript 脚本，以便可以在虚拟机关闭时，自动处理，将网络设备从 bridge 上拆下来，否则下次再次启动，网络设备已经在 bridge 上，就会报错，导致虚拟机无法启动。

## 通过 virsh domxml-to-native 命令，转换出 wiki 来的 qemu-kvm 命令行其中一部分

其中使用`...`省略了很多无用参数

```bash
# 使用 qemu-kvm 程序创建一个名为 lichenhao.bj-net 的虚拟机
/usr/libexec/qemu-kvm -name lichenhao.bj-net
# 虚拟机使用哪种类型的机器，这里是 i440fx 红帽7
-machine pc-i440fx-rhel7.0.0,accel=kvm,usb=off,dump-guest-core=off
# 虚拟机所使用的 CPU 类型
-cpu Skylake-Server-IBRS,-ds,-acpi,+ss,-ht,-tm,-pbe,-dtes64,-monitor,-ds_cpl,-vmx,-smx,-est,-tm2,-xtpr,-pdcm,-dca,-osxsave,-tsc_adjust,+clflushopt,-intel-pt,+pku,-ospke,+avx512vnni,+md-clear,+stibp,+ssbd,+hypervisor,-arat
# 虚拟机的内存大小
-m 4096
-realtime mlock=off
\
# 虚拟机有2个CPU，模拟成2个插槽，每个插槽的CPU有一个核心，每个核心1个线程
-smp 2,sockets=2,cores=1,threads=1 \
......
# 虚拟机中 virtio-blk-pci 设备，是 VM 的硬盘
# 宿主机中 qcow2 文件，id 为 drive-virtio-disk0
# 两者通过 drive 中的 id参数 与 device 中的 drive 参数保持一致，进行关联
-drive file=/var/lib/libvirt/images/master-3.bj-net.qcow2,format=qcow2,...,id=drive-virtio-disk0,...
-device virtio-blk-pci,...,drive=drive-virtio-disk0,...

# 略 drive 中的 id 与 device 中的 drive 相同。
-drive if=none,id=drive-ide0-0-0,...
-device ide-cd,bus=ide.0,...,drive=drive-ide0-0-0,...

# 虚拟机中 virtio-net-pci 设备，是 VM 中的网卡
# 宿主机中 tap 设备，id 为hostnet0
# 两者通过 netdev 中的 id参数 与 device 中的 netdev 参数保持一致，进行关联。
-netdev tap,...id=hostnet0,...
-device virtio-net-pci,...,netdev=hostnet0,...

# 略，chardev 中的 id 与 device 中的 chardev 相同
-chardev pty,id=charserial0
-device isa-serial,chardev=charserial0,...

# 略，chardev 中的 id 与 device 中的 chardev 相同
-chardev socket,id=charchannel0,path=/var/lib/libvirt/qemu/channel/target/domain--1-lichenhao.bj-net/org.qemu.guest_agent.0,server,nowait
-device virtserialport,bus=virtio-serial0.0,nr=1,chardev=charchannel0,id=channel0,name=org.qemu.guest_agent.0
.....
```
