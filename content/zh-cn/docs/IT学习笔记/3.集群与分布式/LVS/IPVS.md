---
title: IPVS
---

# æ¦‚è¿°

> å‚è€ƒï¼š
> - [Wiki,IPVS](https://en.wikipedia.org/wiki/IP_Virtual_Server)
> - [å®˜æ–¹æ–‡æ¡£](http://www.linuxvirtualserver.org/software/ipvs.html)

**IP Virtual Service(IP è™šæ‹ŸæœåŠ¡ï¼Œç®€ç§° IPVS)** æ˜¯åŸºäº [NetFilter](âœIT å­¦ä¹ ç¬”è®°/ğŸ“„1.æ“ä½œç³»ç»Ÿ/2.Kernel(å†…æ ¸)/8.Network%20 ç®¡ç†/Linux%20 ç½‘ç»œæµé‡æ§åˆ¶/Netfilter%20 æµé‡æ§åˆ¶ç³»ç»Ÿ.md ç®¡ç†/Linux ç½‘ç»œæµé‡æ§åˆ¶/Netfilter æµé‡æ§åˆ¶ç³»ç»Ÿ.md) çš„ Linux å†…æ ¸æ¨¡å—ï¼Œç”¨æ¥å®ç°[ LVS](.md) é›†ç¾¤ä¸­çš„ **Scheduler(è°ƒåº¦å™¨) **åŠŸèƒ½ã€‚å¯åŠ¨è¿™ä¸ªæ¨¡å—çš„ Linux æœåŠ¡å™¨å°±å˜æˆäº† LVS ç³»ç»Ÿä¸­çš„ **Director**ï¼Œæ­¤æ—¶ï¼Œè¿™ä¸ªæœåŠ¡å™¨å¯ä»¥çœ‹ä½œæ˜¯ä¸€ç§é«˜æ•ˆçš„ Layer-4(å››å±‚) äº¤æ¢æœºã€‚åœ¨ Director ä¸Šè¿è¡Œ IPVS ä»£ç æ˜¯ LVS çš„åŸºæœ¬è¦ç´ ã€‚

IPVS åœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œï¼Œå¹¶å……å½“ RS é›†ç¾¤å‰é¢çš„è´Ÿè½½å‡è¡¡å™¨ã€‚IPVS å¯ä»¥å°†åŸºäº TCP å’Œ UDP çš„æœåŠ¡è¯·æ±‚å®šå‘åˆ°çœŸå®æœåŠ¡å™¨ï¼Œå¹¶ä½¿çœŸå®æœåŠ¡å™¨çš„æœåŠ¡åœ¨å•ä¸ª IP åœ°å€ä¸Šè¡¨ç°ä¸ºè™šæ‹ŸæœåŠ¡ã€‚å½“ä¸€ä¸ª TCP è¿æ¥çš„åˆå§‹ SYN æŠ¥æ–‡åˆ°è¾¾æ—¶ï¼ŒIPVS å°±é€‰æ‹©ä¸€å°æœåŠ¡å™¨ï¼Œå°†æŠ¥æ–‡è½¬å‘ç»™å®ƒã€‚æ­¤åé€šè¿‡æŸ¥å‘æŠ¥æ–‡çš„ IP å’Œ TCP æŠ¥æ–‡å¤´åœ°å€ï¼Œä¿è¯æ­¤è¿æ¥çš„åç»§æŠ¥æ–‡è¢«è½¬å‘åˆ°ç›¸åŒçš„æœåŠ¡å™¨ã€‚è¿™æ ·ï¼ŒIPVS æ— æ³•æ£€æŸ¥åˆ°è¯·æ±‚çš„å†…å®¹å†é€‰æ‹©æœåŠ¡å™¨ï¼Œè¿™å°±è¦æ±‚åç«¯çš„æœåŠ¡å™¨ç»„æ˜¯æä¾›ç›¸åŒçš„æœåŠ¡ï¼Œä¸ç®¡è¯·æ±‚è¢«é€åˆ°å“ªä¸€å°æœåŠ¡å™¨ï¼Œè¿”å›ç»“æœéƒ½åº”è¯¥æ˜¯ä¸€æ ·çš„ã€‚ä½†æ˜¯åœ¨æœ‰ä¸€äº›åº”ç”¨ä¸­åç«¯çš„æœåŠ¡å™¨å¯èƒ½åŠŸèƒ½ä¸ä¸€ï¼Œæœ‰çš„æ˜¯æä¾› HTML æ–‡æ¡£çš„ Web æœåŠ¡å™¨ï¼Œæœ‰çš„æ˜¯æä¾›å›¾ç‰‡çš„ Web æœåŠ¡å™¨ï¼Œæœ‰çš„æ˜¯æä¾› CGI çš„ Web æœåŠ¡å™¨ã€‚è¿™æ—¶ï¼Œå°±éœ€è¦åŸºäºå†…å®¹è¯·æ±‚åˆ†å‘ (Content-Based Request Distribution)ï¼ŒåŒæ—¶åŸºäºå†…å®¹è¯·æ±‚åˆ†å‘å¯ä»¥æé«˜åç«¯æœåŠ¡å™¨ä¸Šè®¿é—®çš„å±€éƒ¨æ€§ã€‚

- ä¸€ä¸ª ipvs ä¸»æœºå¯ä»¥åŒæ—¶å®šä¹‰å¤šä¸ª cluster service
- ä¸€ä¸ª cluster service ä¸Šè‡³å°‘åº”è¯¥å®šä¹‰ä¸€ä¸ª real serverï¼Œå®šä¹‰æ—¶æŒ‡æ˜ lvs-typeï¼Œä»¥åŠ lvs scheduler

ç”¨ç™½è¯ç†è§£ IPVSï¼š
IPVS å°±æ˜¯åŒ…æ‹¬ Director å’Œ RS åœ¨å†…çš„æ‰€æœ‰è®¾å¤‡ä¸Šçš„ IPï¼Œç»Ÿä¸€è™šæ‹Ÿæˆä¸€ä¸ª IPï¼Œè¿™ä¸ª IP å°±æ˜¯é¢å‘ç”¨æˆ·çš„å”¯ä¸€ IPï¼Œç”¨æˆ·é€šè¿‡è¿™ä¸ª IPï¼Œå°±å¯ä»¥è®¿é—®é›†ç¾¤ï¼Œè®©é›†ç¾¤ä¸ºå…¶æä¾›æœåŠ¡ï¼Œè¿™ä¹Ÿæ˜¯è´Ÿè½½å‡è¡¡çš„ä½“ç°ï¼Œä¹Ÿæ˜¯é›†ç¾¤çš„ä½“ç°ï¼ŒæŠŠå¾ˆå¤šè®¾å¤‡å½“åšä¸€ä¸ªæ•´ä½“æ¥çœ‹ã€‚

## IPVS ä¸ LVS çš„å…³ç³»

LVS æ›´åå‘äºæè¿°ä¸€ä¸ªæ¦‚å¿µï¼Œè€Œ IPVS ç¨‹åºåˆ™æ˜¯å®ç° LVS çš„æœ€æ ¸å¿ƒéƒ¨åˆ†ã€‚é€šè¿‡ IPVS ä»¥åŠå…¶ç®¡ç†å·¥å…· ipvsadmï¼Œå¯ä»¥å®ç° LVS ä¸­çš„ Director(æŒ‡æŒ¥å™¨)ã€‚è€Œ RSï¼Œæœ¬è´¨ä¸Šå¹¶ä¸éœ€è¦ LVS æˆ–è€… IPVS ä»£ç æ”¯æŒï¼Œåªéœ€è¦åœ¨ DR æ¨¡å¼ä¸‹ï¼Œé…ç½®ä¸€äº›å†…æ ¸å‚æ•°å³å¯ã€‚

è€Œéšç€å‘å±•ï¼ŒIPVS å·²ç»å­˜å•ç‹¬çš„ç¨‹åºï¼Œè¢«åŒ…å«åœ¨ Linux å†…æ ¸ä¸­ï¼Œæˆäº†äº†é»˜è®¤è‡ªå¸¦çš„æ¨¡å—ã€‚

å¯ä»¥è¿™ä¹ˆè¯´ï¼ŒIPVS å°±æ˜¯ LVSï¼›ä¹Ÿå¯ä»¥è¯´ï¼ŒLVS åŒ…å« ipvs ä¸ ipvsadmã€‚

# IPVS é…ç½®

ipvs å¯ä»¥é€šè¿‡ä¸¤ç§æ–¹å¼è¿›è¡Œé…ç½®ï¼š

- ipvsadm å‘½ä»¤
- ipvs æ¨¡å—å‚æ•°

ipvs æ˜¯ä¸€ä¸ªå†…æ ¸æ¨¡å—ï¼Œæ‰€ä»¥ï¼Œæƒ³è¦é…ç½® ipvs åˆ™éœ€è¦ä»¥[å†…æ ¸æ¨¡å—](Module(æ¨¡å—).md Kernel/Module(æ¨¡å—).md)çš„é…ç½®æ–¹å¼æ¥è¿›è¡Œé…ç½®ã€‚å¯ä»¥é€šè¿‡ modinfo -p ip_vs å‘½ä»¤æŸ¥çœ‹è¯¥æ¨¡å—å¯ä»¥é…ç½®çš„å‚æ•°

```bash
root@lichenhao:~# modinfo -p ip_vs
conn_tab_bits:Set connections' hash size (int)
```

ç°é˜¶æ®µï¼Œå¯ç”¨çš„å‚æ•°åªæœ‰ä¸€ä¸ªï¼š
**conn_tab_bits** # è®¾ç½®è¿æ¥è¡¨çš„å¤§å°ã€‚`é»˜è®¤å€¼ï¼š12`ã€‚

- è¯¥å‚æ•°æ§åˆ¶ä¸‹é¢ç¤ºä¾‹ä¸­ size çš„å¤§å°ï¼Œ2 çš„ 12 æ¬¡æ–¹ï¼Œ4096

```bash
root@lichenhao:~# ipvsadm -ln
IP Virtual Server version 1.2.1 (size=4096)
Prot LocalAddress:Port Scheduler Flags
  -> RemoteAddress:Port           Forward Weight ActiveConn InActConn
```

IPVS connection hash table sizeï¼Œè¯¥è¡¨ç”¨äºè®°å½•æ¯ä¸ªè¿›æ¥çš„è¿æ¥åŠè·¯ç”±å»å‘çš„ä¿¡æ¯ï¼ˆè¿™ä¸ªå’Œ iptables è·Ÿè¸ªè¡¨ç±»ä¼¼ï¼‰ã€‚è¿æ¥çš„ Hash è¡¨è¦å®¹çº³å‡ ç™¾ä¸‡ä¸ªå¹¶å‘è¿æ¥ï¼Œä»»ä½•ä¸€ä¸ªæŠ¥æ–‡åˆ°è¾¾éƒ½éœ€è¦æŸ¥æ‰¾è¿æ¥ Hash è¡¨ã€‚Hash è¡¨çš„æŸ¥æ‰¾å¤æ‚åº¦ä¸º O(n/m)ï¼Œå…¶ä¸­ n ä¸º Hash è¡¨ä¸­å¯¹è±¡çš„ä¸ªæ•°ï¼Œm ä¸º Hash è¡¨çš„æ¡¶ä¸ªæ•°ã€‚å½“å¯¹è±¡åœ¨ Hash è¡¨ä¸­å‡åŒ€åˆ†å¸ƒå’Œ Hash è¡¨çš„æ¡¶ä¸ªæ•°ä¸å¯¹è±¡ä¸ªæ•°ä¸€æ ·å¤šæ—¶ï¼ŒHash è¡¨çš„æŸ¥æ‰¾å¤æ‚åº¦å¯ä»¥æ¥è¿‘ O(1)

è¿æ¥è·Ÿè¸ªè¡¨ä¸­ï¼Œæ¯è¡Œç§°ä¸ºä¸€ä¸ª hash bucketï¼ˆhash æ¡¶ï¼‰ï¼Œæ¡¶çš„ä¸ªæ•°æ˜¯ä¸€ä¸ªå›ºå®šçš„å€¼ CONFIG_IP_VS_TAB_BITSï¼Œé»˜è®¤ä¸º 12ï¼ˆ2 çš„ 12 æ¬¡æ–¹ï¼Œ4096ï¼‰ã€‚è¿™ä¸ªå€¼å¯ä»¥è°ƒæ•´ï¼Œè¯¥å€¼çš„å¤§å°åº”è¯¥åœ¨ 8 åˆ° 20 ä¹‹é—´ã€‚

LVS çš„è°ƒä¼˜å»ºè®®å°† hash table çš„å€¼è®¾ç½®ä¸ºä¸ä½äºå¹¶å‘è¿æ¥æ•°ã€‚ä¾‹å¦‚ï¼Œå¹¶å‘è¿æ¥æ•°ä¸º 200ï¼ŒPersistent æ—¶é—´ä¸º 200Sï¼Œé‚£ä¹ˆ hash æ¡¶çš„ä¸ªæ•°åº”è®¾ç½®ä¸ºå°½å¯èƒ½æ¥è¿‘ 200x200=40000ï¼Œ2 çš„ 15 æ¬¡æ–¹ä¸º 32768 å°±å¯ä»¥äº†ã€‚å½“ ip_vs_conn_tab_bits=20 æ—¶ï¼Œå“ˆå¸Œè¡¨çš„çš„å¤§å°ï¼ˆæ¡ç›®ï¼‰ä¸º pow(2,20)ï¼Œå³ 1048576ã€‚

è¿™é‡Œçš„ hash æ¡¶çš„ä¸ªæ•°ï¼Œå¹¶ä¸æ˜¯ LVS æœ€å¤§è¿æ¥æ•°é™åˆ¶ã€‚LVS ä½¿ç”¨å“ˆå¸Œé“¾è¡¨è§£å†³â€œå“ˆå¸Œå†²çªâ€ï¼Œå½“è¿æ¥æ•°å¤§äºè¿™ä¸ªå€¼æ—¶ï¼Œå¿…ç„¶ä¼šå‡ºç°å“ˆç¨€å†²çªï¼Œä¼šï¼ˆç¨å¾®ï¼‰é™ä½æ€§èƒ½ï¼Œä½†æ˜¯å¹¶ä¸å¯¹åœ¨åŠŸèƒ½ä¸Šå¯¹ LVS é€ æˆå½±å“ã€‚

ä¿®æ”¹æ¨¡å—å‚æ•°ï¼šecho "options ip_vs conn_tab_bits=22" > /etc/modprobe.d/ip_vs.confï¼Œæ•ˆæœå¦‚ä¸‹ï¼š

```bash
IP Virtual Server version 1.2.1 (size=4194304)
Prot LocalAddress:Port Scheduler Flags
  -> RemoteAddress:Port           Forward Weight ActiveConn InActConn
TCP  10.10.9.60:30000 rr persistent 30
  -> 10.10.9.69:30000             Route   1      0          0
  -> 10.10.9.70:30000             Route   1      0          0
```
