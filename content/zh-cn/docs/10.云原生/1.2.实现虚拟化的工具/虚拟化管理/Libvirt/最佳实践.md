---
title: "最佳实践"
linkTitle: "最佳实践"
weight: 20
---

# 概述

这里的最佳实践，主要是使用 Libvirt 工具集对虚拟机的全生命周期进行管理。比如创建、修改、删除虚拟机。

最常用的工具是 virt-install、virsh 命令

# 创建虚拟机

详见 [virt-install](docs/10.云原生/1.2.实现虚拟化的工具/虚拟化管理/Libvirt/使用%20libvirt%20API%20的其他应用程序/virt-install.md) 命令中的应用示例

# 为 Domain 添加/移除磁盘

设定几个变量

```bash
# 将要操作的虚拟机
export DOMAIN="tj-test-common-kvm"
# 将要附加的存储设备
export SOURCE_DEVICE="/var/lib/libvirt/images/test-data.qcow2"
export TARGET_DEVICE="vdb"
```

先创建一个 qcow2 文件，然后使用这个文件进行测试

- `qemu-img create -f qcow2 -o size=10G ${SOURCE_DEVICE}`

为 tj-test-common-kvm 添加一块磁盘，使用 /var/lib/libvirt/images/test-data.qcow2 文件

```bash
virsh attach-disk ${DOMAIN} ${SOURCE_DEVICE} \
--driver qemu --subdriver qcow2 \
--target ${TARGET_DEVICE} --targetbus virtio \
--cache none \
--persistent
```

将会生成如下 xml

```xml
    <disk type='file' device='disk'>
      <driver name='qemu' type='qcow2' cache='none'/>
      <source file='/var/lib/libvirt/images/test-data.qcow2'/>
      <target dev='vdb' bus='virtio'/>
      <address type='pci' domain='0x0000' bus='0x07' slot='0x00' function='0x0'/>
    </disk>
```

将 tj-test-common-kvm 虚拟机中的 vdb 设备分离

- `virsh detach-disk ${DOMAIN} ${TARGET_DEVICE} --persistent`

