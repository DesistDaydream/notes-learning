---
title: å¸¸è§é—®é¢˜æ’æŸ¥ä¸è§£å†³æ–¹æ¡ˆ
---

åŸæ–‡é“¾æ¥ï¼š<https://mp.weixin.qq.com/s/URU5jz8oFi-jQhWR4snGWQ>
<https://kubesphere.com.cn/forum/d/5152-kubernetes>

### XXX:10250 connect: no route to host

ç½‘ç»œé—®é¢˜ï¼ŒAPI Server ä¸ Kubelet é€šä¿¡å¤±è´¥ï¼Œå°†ä¼šå¯¼è‡´å¾ˆå¤šå¾ˆå¤šé—®é¢˜

### CRD spec.versions: Invalid value

![image.png](https://notes-learning.oss-cn-beijing.aliyuncs.com/oreyv8/1627795842662-52020db8-cb01-4164-a488-25273674f882.png)
**åŸå› :** CRD yaml æ–‡ä»¶ä¸­ apiVersion ä¸ versions ä¸­çš„ç‰ˆæœ¬ä¸å¯¹åº”
å‚è€ƒ: https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definition-versioning/

### åˆ é™¤ namespaces æ—¶ Terminatingï¼Œæ— æ³•å¼ºåˆ¶åˆ é™¤ä¸”æ— æ³•åœ¨è¯¥ ns ä¸‹åˆ›å»ºå¯¹è±¡

![image.png](https://notes-learning.oss-cn-beijing.aliyuncs.com/oreyv8/1627795842467-c0df8305-29f6-4095-a3f7-cc12c7f2d3ad.png)
**åŸå› :** ns å¤„äº terminating æ—¶ hang ä½äº†ï¼Œä½¿ç”¨ --grace-period=0 --force å¼ºåˆ¶åˆ é™¤ä¹Ÿæ— æ•ˆ
**è§£å†³:**
_#Â  å¯¼å‡º K8s è®¿é—®å¯†é’¥_
echoÂ $(kubectlÂ configÂ viewÂ --rawÂ -oyamlÂ |Â grepÂ client-certÂ Â |cutÂ -dÂ 'Â 'Â -fÂ 6)Â |base64Â -dÂ >Â /tmp/client.pem
echoÂ $(kubectlÂ configÂ viewÂ --rawÂ -oyamlÂ |Â grepÂ client-key-dataÂ Â |cutÂ -dÂ 'Â 'Â -fÂ 6Â )Â |base64Â -dÂ >Â /tmp/client-key.pem
echoÂ $(kubectlÂ configÂ viewÂ --rawÂ -oyamlÂ |Â grepÂ certificate-authority-dataÂ Â |cutÂ -dÂ 'Â 'Â -fÂ 6Â Â )Â |base64Â -dÂ >Â /tmp/ca.pem
_#Â  è§£å†³ namespaceÂ Terminatingï¼Œæ ¹æ®å®é™…æƒ…å†µä¿®æ”¹\<namespaces>_
curlÂ --certÂ /tmp/client.pemÂ --keyÂ /tmp/client-key.pemÂ --cacertÂ /tmp/ca.pemÂ -HÂ "Content-Type:Â application/json"Â -XÂ PUTÂ --data-binaryÂ @/tmp/temp.jsonÂ https://xxx.xxx.xxx.xxx:6443/api/v1/namespaces/\<namespaces>/finalize

### Docker å¯åŠ¨æ—¶æç¤º no sockets found via socket activation

![image.png](https://notes-learning.oss-cn-beijing.aliyuncs.com/oreyv8/1627795842598-50fc963e-e60e-47ed-ad40-b7bdb78e0396.png)
**è§£å†³:** åœ¨å¯åŠ¨ Docker å‰å…ˆæ‰§è¡Œ systemctl unmask Docker.socket å³å¯

### Prometheus opening storage failed: invalid block sequence

![image.png](https://notes-learning.oss-cn-beijing.aliyuncs.com/oreyv8/1627795842458-c0924cb6-06dd-4052-a378-31d068f6494b.png)
**åŸå› :** è¿™ä¸ªéœ€è¦æ’æŸ¥ Prometheus æŒä¹…åŒ–ç›®å½•ä¸­æ˜¯å¦å­˜åœ¨æ—¶é—´è¶…å‡ºè®¾ç½®é˜ˆå€¼çš„æ—¶é—´æ®µçš„æ–‡ä»¶ï¼Œåˆ æ‰åé‡å¯å³å¯

### Kubelet æç¤º: The node was low on resource: ephemeral-storage

**åŸå› :** èŠ‚ç‚¹ä¸Š Kubelet çš„é…ç½®è·¯å¾„è¶…è¿‡é˜ˆå€¼ä¼šè§¦å‘é©±é€ï¼Œé»˜è®¤æƒ…å†µä¸‹é˜ˆå€¼æ˜¯ 85%
**è§£å†³:** æˆ–è€…æ¸…ç†ç£ç›˜é‡Šæ”¾èµ„æºï¼Œæˆ–è€…é€šè¿‡å¯ä¿®æ”¹ Kubelet çš„é…ç½®å‚æ•° imagefs.available æ¥æé«˜é˜ˆå€¼,ç„¶åé‡å¯ Kubelet.
å‚è€ƒ: https://cloud.tencent.com/developer/article/1456389

### kubectl æŸ¥çœ‹æ—¥å¿—æ—¶æç¤º: Error from server: Get https://xxx:10250/containerLogs/spring-prod/xxx-0/xxx: dial tcp xxx:10250: i/o timeout

**åŸå› :** ç›®åœ°æœºå™¨çš„ iptables å¯¹ 10250 è¿™ä¸ªç«¯å£è¿›è¡Œäº† dropï¼Œå¦‚ä¸‹å›¾
iptables-saveÂ -LÂ INPUTÂ â€“-line-numbers

![image.png](https://notes-learning.oss-cn-beijing.aliyuncs.com/oreyv8/1627795842260-c7c3b3c6-8e6e-46c0-9cd1-1f059d858cf9.png)
**è§£å†³:** åˆ é™¤å¯¹åº”çš„è§„åˆ™
iptablesÂ -DÂ INPUTÂ 10

### Service è§£ææç¤º Temporary failure in name resolution

![image.png](https://notes-learning.oss-cn-beijing.aliyuncs.com/oreyv8/1627795843427-7456fcdd-df06-406b-826a-e1745b6e3eab.png)
**åŸå› :** å‡ºç°è¿™ç§æƒ…å†µå¾ˆå¥‡æ€ªï¼Œç°è±¡æ˜¾ç¤ºå°±æ˜¯åŸŸåæ— æ³•è§£æï¼Œå…¨æ ¼å¼çš„åŸŸåèƒ½å¤Ÿè§£ææ˜¯å› ä¸ºåœ¨ pod çš„/etc/hosts ä¸­æœ‰å…¨åŸŸåçš„è®°å½•,é‚£ä¹ˆé—®é¢˜å°±å‡ºåœ¨äº CoreDNS è§£æä¸Šï¼ŒCoreDNS ä»æ—¥å¿—æ¥çœ‹ï¼Œæ²¡æœ‰ä»»ä½•æŠ¥é”™ï¼Œä½†æ˜¯ä» pod çš„çŠ¶æ€æ¥çœ‹ï¼Œè™½ç„¶å¤„äº Running çŠ¶æ€ï¼Œä½†æ˜¯ 0/1 å¯ä»¥çœ‹å‡º CoreDNS å¹¶æœªå¤„äº ready çŠ¶æ€.
![image.png](https://notes-learning.oss-cn-beijing.aliyuncs.com/oreyv8/1627795843336-22cc40fb-29a4-4a46-b135-17acd860101a.png)
å¯ä»¥æŸ¥çœ‹ ep è®°å½•ï¼Œä¼šå‘ç° Endpoint é‚£ä¸€æ æ˜¯ç©ºçš„ï¼Œè¿™ä¹Ÿå°±è¯å®äº† K8s æŠŠ CoreDNS çš„çŠ¶æ€åˆ†ä¸ºäº† notready çŠ¶æ€ï¼Œæ‰€ä»¥ ep æ‰æ²¡æœ‰è®°å½•ï¼Œç»è¿‡ä¸å…¶å®ƒç¯å¢ƒæ¯”è¾ƒåå‘ç°è·Ÿé…ç½®æœ‰å…³ï¼Œæœ€ç»ˆå®šä½åœ¨ CoreDNS çš„é…ç½®æ–‡ä»¶ä¸Š,åœ¨æ’ä»¶ä¸Šéœ€è¦åŠ ä¸Š ready
**è§£å†³:** åœ¨ cm çš„é…ç½®ä¸Šæ·»åŠ  read æ’ä»¶ï¼Œå¦‚ä¸‹å›¾
_#Â ...Â  çœç•¥_
data:
Â Â Corefile:Â |
Â Â Â Â .:53Â {
Â Â Â Â Â Â Â Â errors
Â Â Â Â Â Â Â Â health
Â Â Â Â Â Â Â Â readyÂ Â *#Â  åŠ ä¸Šè¯¥è¡Œåé—®é¢˜è§£å†³*
Â Â Â Â Â Â Â Â kubernetesÂ cluster.localÂ in-addr.arpaÂ ip6.arpaÂ {
Â Â Â Â Â Â Â Â Â Â podsÂ insecure
Â Â Â Â Â Â Â Â Â Â upstreamÂ /etc/resolv.conf
Â Â Â Â Â Â Â Â Â Â fallthroughÂ in-addr.arpaÂ ip6.arpa
Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â *#Â ...Â  çœç•¥*

å…³äº CoreDNS çš„ ready æ’ä»¶çš„ä½¿ç”¨,å¯ä»¥å‚è€ƒ ğŸ‘‰ è¿™é‡Œ
æ€»ç»“èµ·æ¥å°±æ˜¯ä½¿ç”¨ ready æ¥è¡¨æ˜å½“å‰å·²å‡†å¤‡å¥½å¯ä»¥æ¥æ”¶è¯·æ±‚ï¼Œä» codedns çš„ yaml æ–‡ä»¶ä¹Ÿå¯ä»¥çœ‹åˆ°æœ‰ livenessProbe

### ä½¿ç”¨ Kubectl å‘½ä»¤è¡Œæ—¶æç¤º: Unable to connect to the server: x509: certificate relies on legacy Common Name field, use SANs or temporarily enable Common Name matching with GODEBUG=x509ignoreCN=0

**åŸå› :** è¿™ä¸ªè·Ÿæœ¬åœ°çš„ go ç¯å¢ƒæœ‰å…³
**è§£å†³:** åœ¨ä½¿ç”¨ kubectl å‰ä½¿ç”¨å‘½ä»¤ export GODEBUG=x509ignoreCN=0 å³å¯

### namespaces "kube-system" is forbidden: this namespace may not be deleted

**åŸå› :** kube-system æ˜¯é›†ç¾¤ä¸­å—ä¿æŠ¤çš„ ns, è¢«ç¦æ­¢åˆ é™¤ï¼Œä¸»è¦æ˜¯é˜²æ­¢è¯¯æ“ä½œï¼Œå¦‚æœéœ€è¦åˆ é™¤çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨ --force
å‚è€ƒ: https://github.com/kubernetes/kubernetes/pull/62167/files

### unknown field volumeClaimTemplates

![image.png](https://notes-learning.oss-cn-beijing.aliyuncs.com/oreyv8/1627795843447-8705e384-6c44-4fd7-a7a8-c1fcf995505e.png)
**åŸå› :** æç¤ºè¿™ä¸ªé”™è¯¯çš„åŸå› æ˜¯èµ„æºå¯¹è±¡æ˜¯ Deployment, è€Œ Deployment æœ¬å°±æ˜¯æ— çŠ¶æ€çš„ï¼Œ æ‰€ä»¥ä¹Ÿå°±æ²¡æœ‰ä½¿ç”¨ pv è¿™ä¸€è¯´æ³•äº†ï¼Œå¯ä»¥å‚è€ƒ api
å‚è€ƒ: ğŸ‘‰Deploymentspec-v1-apps

### CoreDNS æç¤º Loop (127.0.0.1:38827 -> :53) detected for zone "."

![image.png](https://notes-learning.oss-cn-beijing.aliyuncs.com/oreyv8/1627795843702-35c559c4-d985-49a6-8bff-ba6598670ac9.png)
**åŸå› :** CoreDNS æ‰€åœ¨çš„å®¿ä¸»æœºä¸Š /etc/resolv.conf ä¸­å­˜åœ¨æœ‰ 127.0.xx çš„ nameserverï¼Œè¿™æ ·ä¼šé€ æˆè§£ææ­»å¾ªç¯ã€‚
**è§£å†³:** ä¿®æ”¹å®¿ä¸»æœº /etc/resolv.conf æˆ–è€…å°† CoreDNS çš„ ConfigMap ä¸­çš„ forward ä¿®æ”¹ä¸ºä¸€ä¸ªå¯ç”¨çš„åœ°å€, å¦‚ 8.8.8.8ã€‚

### hostPath volumes are not allowed to be used

![image.png](https://notes-learning.oss-cn-beijing.aliyuncs.com/oreyv8/1627795843658-b6818606-bcc9-4a9a-8e0f-670242f281ee.png)
**åŸå› :** é›†ç¾¤ä¸­å­˜åœ¨ psp ç¦æ­¢ pod ç›´æ¥æŒ‚è½½ hostpath.
**è§£å†³:** é€šè¿‡æ·»åŠ ä»¥ä¸‹çš„ psp è§„åˆ™æ¥å…è®¸æˆ–è€…åˆ é™¤å­˜åœ¨çš„ psp éƒ½å¯
apiVersion:Â extensions/v1beta1
kind:Â PodSecurityPolicy
metadata:
Â Â name:Â auth-privilege-psp
spec:
Â Â allowPrivilegeEscalation:Â true
Â Â allowedHostPaths:
Â Â -Â pathPrefix:Â /
Â Â fsGroup:
Â Â Â Â ranges:
Â Â Â Â -Â max:Â 65535
Â Â Â Â Â Â min:Â 1
Â Â Â Â rule:Â RunAsAny
Â Â hostNetwork:Â true
Â Â hostPID:Â true
Â Â hostPorts:
Â Â -Â max:Â 9796
Â Â Â Â min:Â 9796
Â Â privileged:Â true
Â Â requiredDropCapabilities:
Â Â -Â ALL
Â Â runAsUser:
Â Â Â Â rule:Â RunAsAny
Â Â seLinux:
Â Â Â Â rule:Â RunAsAny
Â Â supplementalGroups:
Â Â Â Â ranges:
Â Â Â Â -Â max:Â 65535
Â Â Â Â Â Â min:Â 1
Â Â Â Â rule:Â RunAsAny
Â Â volumes:
Â Â -Â configMap
Â Â -Â emptyDir
Â Â -Â projected
Â Â -Â secret
Â Â -Â downwardAPI
Â Â -Â persistentVolumeClaim
Â Â -Â hostPath

### container has runAsNonRoot and image has non-numeric user (grafana), cannot verify user is non-root

![image.png](https://notes-learning.oss-cn-beijing.aliyuncs.com/oreyv8/1627795843986-21fcb1fe-752b-4829-a3a8-e300254fc295.png)
**åŸå› :** è¿™æ˜¯ç”±äºåœ¨ deploy ä¸­è®¾ç½®äº† securityContext: runAsNonRoot: trueï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå½“ pod å¯åŠ¨æ—¶ï¼Œä½¿ç”¨çš„é»˜è®¤ç”¨æˆ·ã€‚æ¯”å¦‚ä¸Šé¢çš„ grafanaï¼ŒK8s æ— æ³•ç¡®å®šä»–æ˜¯ä¸æ˜¯ root ç”¨æˆ·
**è§£å†³:** æŒ‡å®š securityContext:runAsUser: 1000ï¼Œéšä¾¿ä¸€ä¸ª id å·å³å¯ï¼Œåªè¦ä¸æ˜¯ 0(0 ä»£è¡¨ root)ã€‚
å‚è€ƒ: https://stackoverflow.com/questions/51544003/using-runasnonroot-in-kubernetes

### OCI runtime create failed: no such file or directory

![image.png](https://notes-learning.oss-cn-beijing.aliyuncs.com/oreyv8/1627795844250-2ddf9955-a0cd-4f0a-8569-e44454ef9cbf.png)
**åŸå› :** /var/lib/Kubelet/pod ä¸‹çš„æ•°æ®ç›®å½•å·²ç»æŸå.
**è§£å†³:** åˆ é™¤å¯¹åº”çš„ç›®å½•å³å¯

### é•œåƒæ‹‰å–æ—¶å‡ºç° ImageInspectError

![image.png](https://notes-learning.oss-cn-beijing.aliyuncs.com/oreyv8/1627795844359-d580b01d-02a1-456f-9303-475ddeeb8ca7.png)
**åŸå› :** è¿™ç§æƒ…å†µä¸‹ä¸€èˆ¬éƒ½æ˜¯é•œåƒæŸåäº†
**è§£å†³:** æŠŠç›¸å…³çš„é•œåƒåˆ é™¤åé‡æ–°æ‹‰å–

### Kubelet æ—¥å¿—æç¤º: node not found

![image.png](https://notes-learning.oss-cn-beijing.aliyuncs.com/oreyv8/1627795844738-03cb47b6-c4ea-435a-942a-f01aa23b25f1.png)
**åŸå› :** è¿™ä¸ªæŠ¥é”™åªæ˜¯ä¸­é—´è¿‡ç¨‹ï¼ŒçœŸæ­£çš„åŸå› åœ¨äº apiserver æ²¡æœ‰å¯åŠ¨æˆåŠŸï¼Œå¯¼è‡´ä¼šä¸€ç›´å‡ºç°è¿™ä¸ªé”™è¯¯
**è§£å†³:** æ’æŸ¥ Kubelet ä¸ apiserver çš„è¿é€šæ˜¯å¦æ­£å¸¸

### OCI runtime create failed: executable file not found in PATH

![image.png](https://notes-learning.oss-cn-beijing.aliyuncs.com/oreyv8/1627795844911-0f208c9e-c77f-43a7-abdf-3df68963489d.png)
**åŸå› :** åœ¨ path ä¸­æ²¡æœ‰ nvidia-container-runtime-hook è¿™ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¯èƒ½è·Ÿæœ¬äººåˆ é™¤ nvidia æ˜¾å¡é©±åŠ¨æœ‰å…³.
**è§£å†³:** nvidia-container-runtime-hook æ˜¯ Docker nvidia çš„ runtime æ–‡ä»¶ï¼Œé‡æ–°å®‰è£…å³å¯.

### Nginx Ingress Empty address

_#Â kubectlÂ getÂ ingress_
NAMEÂ Â Â Â Â Â Â Â Â HOSTSÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ADDRESSÂ Â Â PORTSÂ Â Â AGE
PrometheusÂ Â Â Prometheus.1box.comÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 80Â Â Â Â Â Â 31d

ä¼šå‘ç° address ä¸­çš„ ip æ˜¯ç©ºçš„ï¼Œè€ŒæŸ¥çœ‹ç”Ÿäº§ç¯å¢ƒæ—¶å´æ˜¯æœ‰ ip åˆ—è¡¨çš„.
**åŸå› :** è¿™ä¸ªå…¶å®ä¸æ˜¯ä¸€ä¸ªé”™è¯¯ï¼Œä¹Ÿä¸å½±å“ä½¿ç”¨ï¼ŒåŸå› åœ¨äºæµ‹è¯•ç¯å¢ƒä¸­æ˜¯ä¸å­˜åœ¨ LoadBalancer ç±»å‹çš„ svc, å¦‚æœéœ€è¦ address ä¸­æ˜¾ç¤º ip çš„è¯éœ€è¦åšäº›é¢å¤–çš„è®¾ç½®
**è§£å†³:**

1. åœ¨ nginx controller çš„å®¹å™¨ä¸­æŒ‡å®šå¯åŠ¨å‚æ•°-report-ingress-status
2. åœ¨ nginx controller å¼•ç”¨çš„ ConfigMap ä¸­æ·»åŠ  external-status-address: "10.164.15.220"

è¿™æ ·çš„è¯,åœ¨ address ä¸­å˜ä¼šæ˜¾ç¤º 10.164.15.220 äº†
å‚è€ƒ:
https://github.com/nginxinc/kubernetes-ingress/issues/587
https://docs.nginx.com/nginx-ingress-controller/configuration/global-configuration/reporting-resources-status/

### Kubelet: but volume paths are still present on disk

![image.png](https://notes-learning.oss-cn-beijing.aliyuncs.com/oreyv8/1627795844960-bf400d2f-82f2-4005-b134-596eb9a33011.png)
**åŸå› :** è¿™ç§ pod å·²ç»è¢«åˆ é™¤äº†ï¼Œä½†æ˜¯ volume è¿˜å­˜åœ¨äº disk ä¸­
**è§£å†³:** åˆ é™¤å¯¹åº”çš„ç›®å½•/var/lib/Kubelet/pods/3cd73...
å‚è€ƒ: https://github.com/longhorn/longhorn/issues/485

### PLEG is not healthy

![image.png](https://notes-learning.oss-cn-beijing.aliyuncs.com/oreyv8/1627795845375-52becf2c-1526-4044-92b2-6358b9779f97.png)
**åŸå› :** å®¿ä¸»æœºä¸Šé¢è·‘çš„å®¹å™¨å¤ªå¤šï¼Œå¯¼è‡´ pod æ— æ³•åœ¨ 3m é’Ÿå†…å®Œæˆç”Ÿå‘½å‘¨æœŸæ£€æŸ¥
**è§£å†³:** PLEG(Pod Lifecycle Event Generator) ç”¨äº kublet åŒæ­¥ pod ç”Ÿå‘½å‘¨æœŸï¼Œæœ¬æƒ³ç€å¦‚æœæ˜¯å› ä¸ºæ—¶é—´çŸ­å¯¼è‡´çš„è¶…æ—¶ï¼Œé‚£æ˜¯ä¸æ˜¯å¯ä»¥ç›´æ¥è°ƒæ•´è¿™ä¸ªæ—¶é—´å‘¢? æŸ¥çœ‹ Kubelet çš„æºç å‘ç°ä¸å¤ªè¡Œï¼Œ3m æ—¶é—´æ˜¯å†™åœ¨ä»£ç é‡Œçš„å› æ­¤æ— æ³•ä¿®æ”¹ï¼Œå½“ç„¶ä¿®æ”¹å†ç¼–è¯‘è‚¯å®šæ²¡é—®é¢˜ï¼Œä½†æˆæœ¬å¤ªå¤§ï¼Œæ‰€ä»¥åªå¾—ä¼˜åŒ–å®¹å™¨çš„è°ƒåº¦æƒ…å†µ.
å‚è€ƒ: https://developers.redhat.com/blog/2019/11/13/pod-lifecycle-event-generator-understanding-the-pleg-is-not-healthy-issue-in-kubernetes/

### metrics-server: 10255 connection refused

unableÂ toÂ fullyÂ collectÂ metrics:Â \[unableÂ toÂ fullyÂ scrapeÂ metricsÂ fromÂ sourceÂ Kubelet_summary:K8s-node-49:Â unableÂ toÂ fetchÂ metricsÂ fromÂ KubeletÂ K8s-node-49Â (xxx.xxx.xxx.49):Â GetÂ http://xxx.xxx.xxx.49:10255/stats/summary?only\_cpu\_and\_memory=true:Â dialÂ tcpÂ xxx.xxx.xxx.49:10255:Â connect:Â connectionÂ refused

**åŸå› :** ç°åœ¨çš„ K8s éƒ½é»˜è®¤ç¦ç”¨äº† Kubelet çš„ 10255 ç«¯å£ï¼Œå‡ºç°è¿™ä¸ªé”™è¯¯æ˜¯å› æ­¤åœ¨ Kubelet å¯åŠ¨å‘½ä»¤ä¸­å¯ç”¨äº†è¯¥ç«¯å£
**è§£å†³:** å°† - --Kubelet-port=10255 æ³¨é‡Š

### metrics-server: no such host

unableÂ toÂ fetchÂ metricsÂ fromÂ KubeletÂ K8s-node-234Â (K8s-node-234):Â GetÂ https://K8s-node-234:10250/stats/summary?only_cpu_and_memory=true:Â dialÂ tcp:Â lookupÂ K8s-node-234Â onÂ 10.96.0.10:53:Â noÂ suchÂ host

**è§£å†³:** ä½¿ç”¨ Kubelet-preferred-address-types=InternalIP,Hostname,InternalDNS,ExternalDNS,ExternalIP å‚æ•°
å‚è€ƒ: https://github.com/kubernetes-sigs/metrics-server/blob/master/README.md

### pod æ— æ³•è§£æåŸŸå

é›†ç¾¤ä¸­æ–°å¢äº†å‡ å°æœºå™¨ç”¨äºéƒ¨ç½² clickhouse ç”¨äºåšå¤§æ•°æ®åˆ†æï¼Œä¸ºäº†ä¸è®©è¿™ç±»å ç”¨å¤§é‡èµ„æºçš„ Pod å½±å“å…¶å®ƒ Podï¼Œå› æ­¤é€‰æ‹©ç»™æœºå™¨æ‰“ taint çš„å½¢å¼æ§åˆ¶è¯¥ç±» Pod çš„è°ƒåº¦, åˆ›å»º Pod åå‘ç°è¿™äº› Pod éƒ½ä¼šå‡ºç° DNS è§£æå¼‚å¸¸,
åŸå› ï¼›è¦æ³¨æ„å®¹å™¨ç½‘ç»œï¼Œæ¯”å¦‚è¿™é‡Œä½¿ç”¨çš„æ˜¯ flannel æ˜¯å¦å®¹å¿äº†è¿™äº›æœºå™¨çš„ taintï¼Œä¸ç„¶çš„è¯ï¼Œflannel æ˜¯æ— æ³•è¢«è°ƒåº¦åˆ°è¿™äº›æœºå™¨çš„,å› æ­¤å®¹å™¨é—´çš„é€šä¿¡ä¼šå‡ºç°é—®é¢˜ï¼Œ**å¯ä»¥å°†ç±»ä¼¼ flannel è¿™äº›çš„åŸºç¡€ POD å®¹å¿æ‰€æœ‰çš„ NoScheule ä¸ NoExecute**
**è§£å†³:** flannel çš„ ds yaml ä¸­æ·»åŠ ä»¥ä¸‹ tolerationï¼Œè¿™æ ·é€‚ç”¨ä»»ä½•çš„åœºæ™¯
Â Â Â Â Â Â tolerations:
Â Â Â Â Â Â -Â effect:Â NoSchedule
Â Â Â Â Â Â Â Â operator:Â Exists
Â Â Â Â Â Â -Â effect:Â NoExecute
Â Â Â Â Â Â Â Â operator:Â Exists

### Are you tring to mount a directory on to a file

![image.png](https://notes-learning.oss-cn-beijing.aliyuncs.com/oreyv8/1627795845346-b553ddc2-30c1-42db-8e6a-2ea5c4433bc7.png)
**åŸå› :** Yaml æ–‡ä»¶ä¸­ä½¿ç”¨äº† subPath, ä½†æ˜¯ mountPath æŒ‡å‘äº†ä¸€ä¸ªç›®å½•
**è§£å†³:** mountPath éœ€è¦åŠ ä¸Šæ–‡ä»¶å
![image.png](https://notes-learning.oss-cn-beijing.aliyuncs.com/oreyv8/1627795845724-89cd98d0-1c7a-4701-9a6e-1c4584dd5619.png)

### Kubernetes å¯åŠ¨åæç¤º slice: no such file ro directory

![image.png](https://notes-learning.oss-cn-beijing.aliyuncs.com/oreyv8/1627795845678-9dc9dc51-8c3e-4461-a002-a4ffb9dc3723.png)
**åŸå› :** yum å®‰è£…çš„ Kubelet é»˜è®¤çš„æ˜¯ cgroupfsï¼Œè€Œ Docker ä¸€èˆ¬é»˜è®¤çš„æ˜¯ systemdã€‚ä½†æ˜¯ kubernetes å®‰è£…çš„æ—¶å€™å»ºè®®ä½¿ç”¨ systemd, Kubelet è·Ÿ Docker çš„ä¸ä¸€è‡´, è¦ä¹ˆä¿®æ”¹ Kubelet çš„å¯åŠ¨å‚æ•° , è¦ä¹ˆä¿®æ”¹ dokcer å¯åŠ¨å‚æ•°
**è§£å†³:**

- Docker çš„å¯åŠ¨å‚æ•°æ–‡ä»¶ä¸º: /etc/Docker/daemon.json: "exec-opts": \["native.cgroupdriver=systemdâ€]
- Kubelet çš„å¯åŠ¨å‚æ•°æ–‡ä»¶ä¸º: /var/lib/Kubelet/config.yaml: cgroupDriver: systemd

### "cni0" already has an IP address different from xxx.xxxx.xxx.xxx

![image.png](https://notes-learning.oss-cn-beijing.aliyuncs.com/oreyv8/1627795845816-7daf652c-acde-4e70-8dc4-4d889b6df5aa.png)
**åŸå› :** ä½¿ç”¨ kubeadm reset é‡å¤æ“ä½œè¿‡, reset ä¹‹åï¼Œä¹‹å‰ flannel åˆ›å»ºçš„ bridge device cni0 å’Œç½‘å£è®¾å¤‡ flannel.1 ä¾ç„¶å¥åœ¨
**è§£å†³:** æ·»åŠ ä¹‹å‰éœ€è¦æ¸…é™¤ä¸‹ç½‘ç»œ
kubeadmÂ reset
systemctlÂ stopÂ Kubelet
systemctlÂ stopÂ Docker
rmÂ -rfÂ /var/lib/cni/
rmÂ -rfÂ /var/lib/Kubelet/\*
rmÂ -rfÂ /etc/cni/
ifconfigÂ cni0Â down
ifconfigÂ flannel.1Â down
ifconfigÂ Docker0Â down
ipÂ linkÂ deleteÂ cni0
ipÂ linkÂ deleteÂ flannel.1
systemctlÂ startÂ Docker
systemctlÂ startÂ Kubelet

### kubeadm åˆå§‹åŒ–æ—¶æç¤º CPU å°äº 2

\[preflight]Â RunningÂ pre-flightÂ checks
errorÂ executionÂ phaseÂ preflight:Â \[preflight]Â SomeÂ fatalÂ errorsÂ occurred:
Â Â Â Â \[ERRORÂ NumCPU]:Â theÂ numberÂ ofÂ availableÂ CPUsÂ 1Â isÂ lessÂ thanÂ theÂ requiredÂ 2
\[preflight]Â IfÂ youÂ knowÂ whatÂ youÂ areÂ doing,Â youÂ canÂ makeÂ aÂ checkÂ non-fatalÂ withÂ `--ignore-preflight-errors=...`

**åŸå› :** kubeadm å¯¹èµ„æºä¸€å®šçš„è¦æ±‚ï¼Œå¦‚æœæ˜¯æµ‹è¯•ç¯å¢ƒæ— æ‰€è°“çš„è¯,å¯å¿½ç•¥
**è§£å†³:**
ä½¿ç”¨ Â --ignore-preflight-errorsÂ  å¿½ç•¥

### Unable to update cni config: no network found

![image.png](https://notes-learning.oss-cn-beijing.aliyuncs.com/oreyv8/1627795846340-4412cff2-a01b-4ab1-8716-7ee4cd3a0409.png)
**åŸå› :** è¿˜æœªéƒ¨ç½²ç½‘ç»œæ’ä»¶å®¹å™¨ï¼Œå¯¼è‡´åœ¨ /etc/cni ä¸‹è¿˜æ²¡æœ‰æ–‡ä»¶
**è§£å†³:** æ ¹æ®å®é™…æƒ…å†µéƒ¨ç½²ç½‘ç»œæ’ä»¶

### while reading 'google-Dockercfg' metadata

![image.png](https://notes-learning.oss-cn-beijing.aliyuncs.com/oreyv8/1627795846370-2c2f039d-127a-4b47-895e-c265511d3ce9.png)
**åŸå› :** ä»å…¶å®ƒæœºå™¨è®¿é—®ä¸Šè¿°è¿™äº› url ç¡®å®å‡ºç° 404
**è§£å†³:** ç”±äºæ˜¯åœ¨ RKE ä¸Šéƒ¨ç½² K8s, æ‰€ä»¥å¯èƒ½ä¼šå»è®¿é—® google ç›¸å…³çš„ url, ä¸å½±å“ä¸šåŠ¡,å¯ä»¥å¿½ç•¥

### no providers available to validate pod request

![image.png](https://notes-learning.oss-cn-beijing.aliyuncs.com/oreyv8/1627795846584-1bddd303-39e9-402b-bdde-6b7c7ac69ac2.png)
**åŸå› :** åœ¨ api-server çš„å¯åŠ¨å‚æ•° enable-admission ä¸­è®¾ç½®äº† PodSecrityPolicy, ä½†æ˜¯é›†ç¾¤ä¸­åˆæ²¡æœ‰ä»»ä½•çš„ podsecritypolicyï¼Œå› æ­¤å¯¼è‡´æ•´ä¸ªé›†ç¾¤éƒ½æ— æ³•æ–°å»ºå‡º pod
**è§£å†³:** åˆ é™¤ç›¸åº”çš„ podsecritypolicy å³å¯

### unable to upgrade connection: Unauthorized

![image.png](https://notes-learning.oss-cn-beijing.aliyuncs.com/oreyv8/1627795846680-575f17cb-69b1-4774-8760-311b14dbb792.png)
**åŸå› :** Kubelet çš„å¯åŠ¨å‚æ•°å°‘äº† x509 è®¤è¯æ–¹å¼
**è§£å†³:** é…ç½®è¯ä¹¦çš„è·¯å¾„, åŠ ä¸Šé‡å¯ Kubelet å³å¯
![image.png](https://notes-learning.oss-cn-beijing.aliyuncs.com/oreyv8/1627795846898-75454713-4d2f-4691-8a30-fa92f04df863.png)

### kubectl get cs æç¤º\<unknown>

![image.png](https://notes-learning.oss-cn-beijing.aliyuncs.com/oreyv8/1627795847105-09736a43-5687-4c97-b73a-f8e22a440f64.png)
**åŸå› :** è¿™æ˜¯ä¸ª kubectl çš„ bug, è·Ÿç‰ˆæœ¬ç›¸å…³ï¼Œkubernetes æœ‰æ„åºŸé™¤ get cs å‘½ä»¤
**è§£å†³:** ç›®å‰å¯¹é›†ç¾¤çš„è¿è¡Œæ— å½±å“, å¯é€šè¿‡åŠ  -o yaml æŸ¥çœ‹çŠ¶æ€

### å®‰è£… kubeadm æ—¶æç¤º Depends é”™è¯¯

![image.png](https://notes-learning.oss-cn-beijing.aliyuncs.com/oreyv8/1627795847695-8edead12-7272-461d-9b74-ce74bc525af4.png)
**åŸå› :** è·Ÿ kubeadm æ²¡å¤šå¤§å…³ç³», ç³»ç»Ÿå®‰è£…çš„æœ‰é—®é¢˜
**è§£å†³:** æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ä¿®å¤
aptÂ --fix-brokenÂ install
apt-getÂ update

### è®¿é—® service æ—¶æç¤º Connection refused

ç°è±¡: ä»å¦ä¸€ç¯å¢ƒä¸­æŠŠ yaml æ–‡ä»¶å¯¼å…¥åˆ°æ–°ç¯å¢ƒåæœ‰äº› service è®¿é—®ä¸é€š
telnetÂ mongodb-mst.externalÂ 27017
TryingÂ 10.97.135.242...
telnet:Â UnableÂ toÂ connectÂ toÂ remoteÂ host:Â ConnectionÂ refused

é¦–å…ˆæ’é™¤äº†åŸŸåã€ç«¯å£çš„é…ç½®é—®é¢˜ã€‚
ä¼šå‘ç°æç¤ºè¿æ¥æ‹’ç».å¯ä»¥ç¡®å®šçš„æ˜¯é›†ç¾¤å†…çš„ DNS æ˜¯æ­£å¸¸çš„.
é‚£ä¹ˆå°±æ˜¯é€šè¿‡ clusterIP æ— æ³•åˆ°è¾¾ realserver. æŸ¥çœ‹ iptables è§„åˆ™
å‘ç°æç¤º default has no Endpoints --reject-with icmp-port-unreachable
![image.png](https://notes-learning.oss-cn-beijing.aliyuncs.com/oreyv8/1627795847625-b50a453d-74ba-4a1f-96fb-b6e9416385e5.png)
å¾ˆå¥‡æ€ª, æç¤ºæ²¡æœ‰ Endpoints, ä½†æ˜¯ä½¿ç”¨ kubectl get ep åˆèƒ½çœ‹åˆ° ep å­˜åœ¨ä¸”é…ç½®æ²¡æœ‰é—®é¢˜
è€Œä¸”è¿™ä¸ª default æ˜¯æ€ä¹ˆæ¥çš„.
ä¸ºäº†æ–¹ä¾¿éƒ¨ç½², å¾ˆå¤šé…ç½®æ˜¯ä»åˆ«çš„ç¯å¢ƒå¯¼å‡ºçš„é…ç½®, æœ‰äº› service è®¿é—®æ˜¯æ²¡é—®é¢˜çš„, åªæœ‰å°‘éƒ¨åˆ† connection refusedã€‚
ç»“æ¯”ä¸€ä¸‹å‘ç°ä¸€ä¸ªå¾ˆæœ‰è¶£çš„é—®é¢˜ï¼Œå…ˆæ¥çœ‹ä¸‹ä¸æ­£å¸¸çš„ yaml æ–‡ä»¶:
![image.png](https://notes-learning.oss-cn-beijing.aliyuncs.com/oreyv8/1627795847852-63786a28-76ca-4716-94ff-dbcb16defcb1.png)
ç”±äºæœåŠ¡åœ¨é›†ç¾¤å¤–éƒ¨ç½²çš„, å› æ­¤è¿™é‡Œä½¿ç”¨äº† subset æ–¹å¼, å¼€å§‹æ€€ç–‘é—®é¢˜åœ¨è¿™é‡Œ, ä½†æ˜¯åæ¥çŸ¥é“è¿™ä¸ªä¸æ˜¯é‡ç‚¹
ä¹ä¸€çœ‹è¿™ä¸ªé…ç½®æ²¡ä»€ä¹ˆé—®é¢˜, éƒ¨ç½²ä¹Ÿå¾ˆæ­£å¸¸, ä½†æ˜¯å¯¹æ¯”æ­£å¸¸çš„ yaml æ–‡ä»¶ï¼Œå‘ç°ä¸€ä¸ªåŒºåˆ«ï¼š
å¦‚æœåœ¨ services ä¸­çš„ç«¯å£æŒ‡å®šäº†åå­—, é‚£ä¹ˆåœ¨ subsets ä¸­çš„ç«¯å£ä¹Ÿè¦å¸¦åå­—, æ²¡æœ‰å¸¦åå­—çš„å°±ä¼šå‡ºç° connection refusedï¼Œè¿™ä¸ªç¡®å®ä¹‹å‰ä»æ¥æ²¡æœ‰å…³æ³¨è¿‡, ä¸€ä¸ªç«¯å£çš„æƒ…å†µä¸‹ä¹Ÿä¸ä¼šæŒ‡å®šåå­—
è€Œä¸”è¿™é¢ iptalbes ä¸­æç¤ºçš„ default åˆšå¥½å°±æ˜¯è¿™é‡Œçš„ port name,è™½ç„¶ä¸æ•¢ç›¸ä¿¡ï¼Œä½†æ˜¯ä¹Ÿåªèƒ½è¯•ä¸€è¯•è¿™ä¸ªæ–¹æ³•: åœ¨ subsets ä¸­ä¹ŸåŠ äº† port name
![image.png](https://notes-learning.oss-cn-beijing.aliyuncs.com/oreyv8/1627795848243-58d550ed-6077-4d55-8b93-e49c42860058.png)
é‡æ–°éƒ¨ç½²ä¸€ä¸ªï¼Œå†æ¬¡æŸ¥çœ‹ iptalbes è§„åˆ™
iptables-save|grep mongodb-mst
![image.png](https://notes-learning.oss-cn-beijing.aliyuncs.com/oreyv8/1627795848135-b82e144a-718a-47e0-a923-d4dbef27e87a.png)
OMG, å±…ç„¶å¯è¡Œ, å†çœ‹ä¸‹ telnet çš„ç»“æœ:
TryingÂ 10.105.116.92...
ConnectedÂ toÂ mongodb-mst.external.svc.cluster.local.
EscapeÂ characterÂ isÂ '^]'.

è®¿é—®ä¹Ÿæ˜¯æ²¡é—®é¢˜, é‚£ä¹ˆåŸå› å°±åœ¨äº:
**åœ¨ service ä¸­æŒ‡å®šäº† port name æ—¶, ä¹Ÿéœ€è¦åœ¨ ep ä¸­æŒ‡å®š port name**

### error converting fieldPath: field label not supported

ä»Šå¤©é‡åˆ°ä¸€ä¸ªéƒ¨ç½² Deployment å‡ºé”™çš„é—®é¢˜, yaml æ–‡ä»¶å¦‚ä¸‹:
```yaml
apiVersion:Â apps/v1
kind:Â Deployment
metadata:
Â Â name:Â demo-Deployment
Â Â namespace:Â 4test
Â Â labels:
Â Â Â Â app:Â config-demo-app
spec:
Â Â replicas:Â 1
Â Â selector:
Â Â Â Â matchLabels:
Â Â Â Â Â Â app:Â config-demo-app
Â Â template:
Â Â Â Â metadata:
Â Â Â Â Â Â labels:
Â Â Â Â Â Â Â Â app:Â config-demo-app
Â Â Â Â Â Â annotations:
Â Â Â Â Â Â Â Â *#Â TheÂ fieldÂ we'llÂ useÂ toÂ coupleÂ ourÂ ConfigMapÂ andÂ Deployment*
Â Â Â Â Â Â Â Â configHash:Â 4431f6d28fdf60c8140d28c42cde331a76269ac7a0e6af01d0de0fa8392c1145
Â Â Â Â spec:
Â Â Â Â Â Â containers:
Â Â Â Â Â Â -Â name:Â config-demo-app
Â Â Â Â Â Â Â Â image:Â gcr.io/optimum-rock-145719/config-demo-app
Â Â Â Â Â Â Â Â ports:
Â Â Â Â Â Â Â Â -Â containerPort:Â 80
Â Â Â Â Â Â Â Â envFrom:
Â Â Â Â Â Â Â Â *#Â TheÂ ConfigMapÂ weÂ wantÂ toÂ use*
Â Â Â Â Â Â Â Â -Â configMapRef:
Â Â Â Â Â Â Â Â Â Â Â Â name:Â demo-config
Â Â Â Â Â Â Â Â *#Â Extra-curricular:Â WeÂ canÂ makeÂ theÂ hashÂ ofÂ ourÂ ConfigMapÂ availableÂ atÂ a*
Â Â Â Â Â Â Â Â *#Â (e.g.)Â debugÂ EndpointÂ viaÂ aÂ fieldRef*
Â Â Â Â Â Â Â Â env:
Â Â Â Â Â Â Â Â -Â name:Â CONFIG_HASH
Â Â Â Â Â Â Â Â Â Â *#value:Â "4431f6d28fdf60c8140d28c42cde331a76269ac7a0e6af01d0de0fa8392c1145"*
Â Â Â Â Â Â Â Â Â Â valueFrom:
Â Â Â Â Â Â Â Â Â Â Â Â fieldRef:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â fieldPath:Â spec.template.metadata.annotations.configHash
```

æç¤ºä»¥ä¸‹é”™è¯¯:
![image.png](https://notes-learning.oss-cn-beijing.aliyuncs.com/oreyv8/1627795856579-787ee326-6723-4a6b-96ac-9983b2c819b2.png)
ä¼šæç¤º Unsupported value:spec.template.metadata.annotations.configHashã€‚
ç›®çš„å¾ˆç®€å•: container ä¸­çš„ç¯å¢ƒå˜é‡ä¸­å¼•ç”¨ configHash å˜é‡, è¿™ä¸ªå€¼æ˜¯å½“ ConfigMap å˜æ›´æ—¶æ¯”å¯¹ä¸¤ä¸ªä¸åŒçš„ sha å€¼ä»¥æ­¤è¾¾åˆ°é‡å¯ pod çš„ç›®çš„, ä½† fieldPath æ˜¾ç„¶ä¸æ”¯æŒ spec.template.metadata.annotations.configHashã€‚
ä»æŠ¥é”™æç¤ºæ¥çœ‹, æ”¯æŒåˆ—è¡¨æœ‰ metadata.name, metadata.namespace, metadata.uid, spec.nodeName,spec.serviceAccountName, status.hostIp, status.PodIP, status.PodIPsã€‚
è¿™äº›å€¼ç”¨äºå®¹å™¨ä¸­éœ€è¦ä»¥ä¸‹ä¿¡æ¯æ—¶å¯ä»¥ä¸ä» K8s çš„ apiserver ä¸­è·å–è€Œæ˜¯å¯ä»¥å¾ˆæ–¹ä¾¿åœ°ä»è¿™äº›å˜é‡ç›´æ¥è·å¾—ã€‚
å‚è€ƒ:

- https://www.magalix.com/blog/kubernetes-patterns-the-reflection-pattern
- https://kubernetes.io/docs/tasks/inject-data-application/downward-api-volume-expose-pod-information/

### **å‚è€ƒæ–‡ç« :**

- https://www.ibm.com/docs/en/cloud-private/3.2.0?topic=console-namespace-is-stuck-in-terminating-state
- https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definition-versioning/
- https://github.com/kubernetes/kubernetes/issues/19317
- http://www.xuyasong.com/?p=1725
- https://kubernetes.io/
- https://fuckcloudnative.io/
- https://www.cnblogs.com/breezey/p/8810039.html
- https://ieevee.com/tech/2018/04/25/downwardapi.html
- https://www.magalix.com/blog/kubernetes-patterns-the-reflection-pattern
- https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#Deploymentspec-v1-apps
- https://kubernetes.io/docs/tasks/inject-data-application/downward-api-volume-expose-pod-information/
- https://github.com/kubernetes/kubernetes/pull/62167/files
- https://github.com/kubernetes-sigs/metrics-server/blob/master/README.md
